{# Temperature Conversion Macros for Home Assistant

   These macros provide reusable temperature conversion functions
   that can be used throughout your sensor templates.

   Usage in sensor templates:
   {% from 'init.jinja' import celsius, fahrenheit %}

   {{ celsius('sensor.some_temp_sensor') }}
   {{ fahrenheit('sensor.some_temp_sensor') }}

   Key features:
   - Returns 'none' for unavailable/unknown sensors (safer than returning 0)
   - Auto-detects unit from sensor's unit_of_measurement attribute
   - Supports normalized unit strings (C/CELSIUS, F/FAHRENHEIT)
   - Handles missing units gracefully with default_unit_if_missing parameter
#}

{# Convert temperature sensor value to Celsius

   Args:
     entity_id: Entity ID of the temperature sensor (string)
     default_unit_if_missing: Unit to assume if sensor has no unit attribute (default: 'C')

   Returns:
     Temperature value in Celsius (float), or none if sensor unavailable

   Example:
     {% from 'init.jinja' import celsius %}
     {{ celsius('sensor.outdoor_temperature') }}
     {{ celsius('sensor.some_sensor', 'F') }}  {# Assume F if unit missing #}
#}
{% macro celsius(entity_id, default_unit_if_missing='C') %}
  {% set state = states(entity_id) %}
  {% if state in ['unavailable', 'unknown', 'none', ''] or state is none %}
    {{ none }}
  {% else %}
    {% set value = state | float(default=none) %}
    {% if value is none %}
      {{ none }}
    {% else %}
      {% set from_unit = (state_attr(entity_id, 'unit_of_measurement') or default_unit_if_missing) | replace('°','') | upper | trim %}
      {% if from_unit in ['C', 'CELSIUS'] %}
        {{ value }}
      {% elif from_unit in ['F', 'FAHRENHEIT'] %}
        {{ (value - 32) * 5 / 9 }}
      {% else %}
        {{ value }}
      {% endif %}
    {% endif %}
  {% endif %}
{% endmacro %}

{# Convert temperature sensor value to Fahrenheit

   Args:
     entity_id: Entity ID of the temperature sensor (string)
     default_unit_if_missing: Unit to assume if sensor has no unit attribute (default: 'C')

   Returns:
     Temperature value in Fahrenheit (float), or none if sensor unavailable

   Example:
     {% from 'init.jinja' import fahrenheit %}
     {{ fahrenheit('sensor.outdoor_temperature') }}
     {{ fahrenheit('sensor.some_sensor', 'F') }}  {# Assume F if unit missing #}
#}
{% macro fahrenheit(entity_id, default_unit_if_missing='C') %}
  {% set state = states(entity_id) %}
  {% if state in ['unavailable', 'unknown', 'none', ''] or state is none %}
    {{ none }}
  {% else %}
    {% set value = state | float(default=none) %}
    {% if value is none %}
      {{ none }}
    {% else %}
      {% set from_unit = (state_attr(entity_id, 'unit_of_measurement') or default_unit_if_missing) | replace('°','') | upper | trim %}
      {% if from_unit in ['F', 'FAHRENHEIT'] %}
        {{ value }}
      {% elif from_unit in ['C', 'CELSIUS'] %}
        {{ value * 9 / 5 + 32 }}
      {% else %}
        {{ value }}
      {% endif %}
    {% endif %}
  {% endif %}
{% endmacro %}
