- binary_sensor:
  # CX50 Heat Pump Optimization Sensors
  # Purpose: Track heat pump cycles, startup penalties, and steady-state efficiency
  # Goal: Improve COP from 2.0-2.5 to manufacturer's 4.55 rating

  # ------------------------------------------------------------------------
  # Heat Pump Running Detection (Improved Logic)
  # More precise than just checking power > 500W
  # Requires: Water flow detected AND (Compressor running OR Active heat transfer)
  # ------------------------------------------------------------------------
  - name: "Heat Pump Running"
    unique_id: heat_pump_running
    state: >-
      {% set flow_active = is_state('binary_sensor.heat_pump_flow_status', 'on') %}
      {% set compressor_freq = states('sensor.cx50_compressor_frequency') | float(0) %}
      {% set thermal_output = states('sensor.heat_pump_thermal_power_output') | float(0) %}

      {# Heat pump is running if flow detected AND (compressor running OR producing heat) #}
      {% if flow_active %}
        {{ 'on' if (compressor_freq > 0 or thermal_output > 1000) else 'off' }}
      {% else %}
        off
      {% endif %}
    device_class: running # Valid for binary_sensor
    icon: mdi:heat-pump
    availability: >-
      {{ states('binary_sensor.heat_pump_flow_status') not in ['unknown', 'unavailable']
          and states('sensor.cx50_compressor_frequency') not in ['unknown', 'unavailable']
          and states('sensor.heat_pump_thermal_power_output') not in ['unknown', 'unavailable'] }}

  # ------------------------------------------------------------------------
  # Heat Pump Startup Phase Detection
  # ------------------------------------------------------------------------
  - name: "Heat Pump In Startup Phase"
    unique_id: heat_pump_in_startup_phase
    state: >-
      {% set cycle_time = states('sensor.heat_pump_current_cycle_duration') | float(0) %}
      {{ (cycle_time > 0 and cycle_time < 180) | lower }}
    icon: mdi:rocket-launch

  # ------------------------------------------------------------------------
  # Heat Pump Steady State Detection
  # ------------------------------------------------------------------------
  - name: "Heat Pump Steady State"
    unique_id: heat_pump_steady_state
    state: >-
      {% set cycle_time = states('sensor.heat_pump_current_cycle_duration') | float(0) %}
      {% set remaining_time = states('sensor.heat_pump_current_cycle_remaining') | float(0) %}
      {{ (cycle_time > 180 and remaining_time > 10) | lower }} # Arbitrary 10s buffer before cycle end
    icon: mdi:check-circle-outline

  # ------------------------------------------------------------------------
  # Short Cycle Detection
  # MOVED from the broken, separate block into this main block
  # ------------------------------------------------------------------------
  - name: "Heat Pump Last Cycle Was Short"
    unique_id: heat_pump_last_cycle_was_short
    state: >-
      {% set last_cycle = states('sensor.heat_pump_last_cycle_duration') | float(0) %}
      {{ (last_cycle > 0 and last_cycle < 300) | lower }}
    icon: mdi:alert-circle

  # ------------------------------------------------------------------------
  # Circulator Pump Running Without Heat Pump
  # Detects when pump is circulating but compressor is off
  # This causes energy loss through the heat pump coil
  # ------------------------------------------------------------------------
  - name: "Circulator Running HP Off"
    unique_id: circulator_running_hp_off
    state: >-
      {% set flow = states('sensor.cx50_pump_flow_lpm') | float(0) %}
      {% set hp_running = is_state('binary_sensor.heat_pump_running', 'on') %}
      {% set compressor_freq = states('sensor.cx50_compressor_frequency') | float(0) %}

      {# Circulator is running if flow > 4 L/min #}
      {# Heat pump is off if power < 500W or compressor frequency = 0 #}
      {{ flow > 4 and not hp_running and compressor_freq == 0 }}
    icon: mdi:pump-off

# ------------------------------------------------------------------------
# Calculated Sensors
# This block is correct and remains as-is
# ------------------------------------------------------------------------
- sensor:
  - name: "Heat Pump Average Steady State COP"
    unique_id: heat_pump_average_steady_state_cop
    state_class: measurement
    unit_of_measurement: "COP"
    state: >-
      {% set cop_value = states('sensor.heat_pump_current_cop') | float(0) %}
      {% set steady_state = is_state('binary_sensor.heat_pump_steady_state', 'on') %}
      {% set enable = is_state('input_boolean.enable_cop_optimization', 'on') %}
      {% set current_value = states('sensor.heat_pump_average_steady_state_cop') | float(0) %}

      {% if steady_state and enable and cop_value > 0 %}
        {{ cop_value | round(2) }}
      {% else %}
        {{ current_value | round(2) }}
      {% endif %}
    availability: >-
      {% set cop_available = states('sensor.heat_pump_current_cop') not in ['unknown', 'unavailable'] %}
      {% set cop_value = states('sensor.heat_pump_current_cop') | float(0) %}
      {% set steady_state = is_state('binary_sensor.heat_pump_steady_state', 'on') %}
      {% set enable = is_state('input_boolean.enable_cop_optimization', 'on') %}
      {% set has_previous = states('sensor.heat_pump_average_steady_state_cop') not in ['unknown', 'unavailable', 'none'] %}
      {% set previous_value = states('sensor.heat_pump_average_steady_state_cop') | float(0) %}

      {{ (steady_state and enable and cop_available and cop_value > 0) or (has_previous and previous_value > 0) }}
      
  - name: "System Distribution Efficiency"
    unique_id: system_distribution_efficiency
    state_class: measurement
    unit_of_measurement: "%"
    state: >-
      {% set hp_output = states('sensor.heat_pump_thermal_power_output') | float(0) %}
      {% set hvac_load = states('sensor.hvac_thermal_power_used') | float(0) %}

      {% if hp_output > 0 %}
        {{ ((hvac_load / hp_output) * 100) | round(1) }}
      {% else %}
        0
      {% endif %}
    icon: mdi:percent

  - name: "System Loss Analysis"
    unique_id: system_loss_analysis
    state: >-
      {% set hp_output = states('sensor.heat_pump_thermal_power_output') | float(0) %}
      {% set hvac_load = states('sensor.hvac_thermal_power_used') | float(0) %}
      {% set efficiency = states('sensor.system_distribution_efficiency') | float(0) %}

      {% if hp_output < 100 %}
        Heat pump idle
      {% elif hvac_load > hp_output %}
        ERROR: HVAC load ({{ (hvac_load/1000) | round(1) }}kW) > HP output ({{ (hp_output/1000) | round(1) }}kW) - Check sensors!
      {% elif efficiency >= 90 %}
        Excellent ({{ efficiency }}% - {{ ((hp_output - hvac_load)/1000) | round(1) }}kW loss)
      {% elif efficiency >= 80 %}
        Good ({{ efficiency }}% - {{ ((hp_output - hvac_load)/1000) | round(1) }}kW loss)
      {% elif efficiency >= 70 %}
        Fair ({{ efficiency }}% - {{ ((hp_output - hvac_load)/1000) | round(1) }}kW loss)
      {% elif efficiency >= 50 %}
        Poor ({{ efficiency }}% - {{ ((hp_output - hvac_load)/1000) | round(1) }}kW loss)
      {% else %}
        Critical ({{ efficiency }}% - {{ ((hp_output - hvac_load)/1000) | round(1) }}kW loss)
      {% endif %}

  # ------------------------------------------------------------------------
  # System Distribution Losses (Watts)
  # Calculates thermal power lost in distribution between HP and HVAC load
  # Formula: Losses = HP Output - HVAC Load
  # ------------------------------------------------------------------------
  - name: "System Distribution Losses"
    unique_id: system_distribution_losses
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    icon: mdi:leak
    state: >-
      {% set hp_output = states('sensor.heat_pump_thermal_power_output') | float(0) %}
      {% set hvac_load = states('sensor.hvac_thermal_power_used') | float(0) %}

      {% if hp_output > 100 %}
        {{ (hp_output - hvac_load) | round(0) }}
      {% else %}
        0
      {% endif %}

  # ------------------------------------------------------------------------
  # System Distribution Efficiency (Daily)
  # Compares Energy Used by House (Load) vs. Energy Produced by HP (Source)
  # Formula: Efficiency = (Load / Source) * 100
  # ------------------------------------------------------------------------
  - name: "System Distribution Efficiency (Daily)"
    unique_id: system_distribution_efficiency_daily
    unit_of_measurement: "%"
    state_class: measurement
    icon: mdi:percent
    state: >-
      {% set load_kwh = states('sensor.hvac_thermal_energy_used_daily') | float(0) %}
      {% set source_kwh = states('sensor.hvac_hp_thermal_energy_produced_daily') | float(0) %}

      {% if source_kwh > 0.5 %}
        {{ ((load_kwh / source_kwh) * 100) | round(1) }}
      {% else %}
        {{ 'unavailable' }}
      {% endif %}      

  # ------------------------------------------------------------------------
  # Filtered Thermal Power (Space Heating ONLY)
  # EXCLUDES DHW to isolate true Space Heating COP
  # ------------------------------------------------------------------------
  - name: "HP Space Heating Thermal Power (kW)"
    unique_id: hp_space_heating_thermal_power_kw
    unit_of_measurement: "kW"
    device_class: power
    state_class: measurement
    icon: mdi:radiator
    state: >-
      {% if states('sensor.heat_pump_operating_mode') == 'Heat' %}
        {% set watts = states('sensor.heat_pump_thermal_power_output') | float(0) %}
        {{ (watts / 1000) | round(3) }}
      {% else %}
        {{ 0.0 }}
      {% endif %}      

  # ------------------------------------------------------------------------
  # House Heat Loss Coefficient (HLC) - Energy-Based (The stable one)
  # Formula: HLC = (Daily Energy / 24h) / Avg Delta T
  # ------------------------------------------------------------------------
  - name: "House Heat Loss Coefficient (Energy-Based)"
    unique_id: house_heat_loss_coefficient_energy_based
    unit_of_measurement: "kW/Â°C"
    state_class: measurement
    icon: mdi:home-thermometer
    state: >-
      {% set daily_kwh = states('sensor.hvac_thermal_energy_used_daily') | float(0) %}
      {% set avg_delta_t_c = states('sensor.house_delta_t_c_24_hour_mean') | float(0) %}
      
      {% if avg_delta_t_c > 1.0 %}
        {{ ((daily_kwh / 24.0) / avg_delta_t_c) | round(2) }}
      {% else %}
        {{ 'unavailable' }}
      {% endif %}

      # ------------------------------------------------------------------------
  # Circulator Pump Running Without Heat Pump
  # Detects standby energy loss condition
  # ------------------------------------------------------------------------
  - name: "Circulator Pump Flow Rate"
    unique_id: circulator_pump_flow_rate
    unit_of_measurement: "L/min"
    state_class: measurement
    icon: mdi:pump
    state: >-
      {{ states('sensor.cx50_pump_flow_lpm') | float(0) }}

  # ------------------------------------------------------------------------
  # Energy Loss Rate When Circulator Runs Without Heat Pump
  # Calculates thermal loss through heat pump coil
  # In heating mode: hot water is cooled by outdoor coil
  # In cooling mode: cool water is warmed by outdoor coil
  # ------------------------------------------------------------------------
  - name: "HP Standby Thermal Loss Rate"
    unique_id: hp_standby_thermal_loss_rate
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    icon: mdi:snowflake-alert
    state: >-
      {% set circulator_running = states('binary_sensor.circulator_running_hp_off') %}
      {% set operating_mode = states('sensor.heat_pump_operating_mode') %}

      {% if circulator_running == 'on' %}
        {# Use the thermal power calculation to determine loss #}
        {# When HP is off but water circulating, delta T represents loss #}
        {% set inlet = states('sensor.cx50_inlet_water_temp_c') | float(0) %}
        {% set outlet = states('sensor.cx50_outlet_water_temp_c') | float(0) %}
        {% set flow_lpm = states('sensor.cx50_pump_flow_lpm') | float(0) %}
        {% set density = states('input_number.cx_fluid_density') | float(1025) %}
        {% set specific_heat = states('input_number.cx_fluid_specific_heat') | float(3.95) %}

        {# Calculate thermal transfer (negative = heat loss in heating mode) #}
        {% set delta_t = outlet - inlet %}
        {% set flow_lps = flow_lpm / 60 %}
        {% set flow_kgs = (flow_lps * density) / 1000 %}
        {% set specific_heat_j = specific_heat * 1000 %}
        {% set thermal_loss = (flow_kgs * specific_heat_j * delta_t) | abs %}

        {{ thermal_loss | round(0) }}
      {% else %}
        0
      {% endif %}
    availability: >-
      {{ states('sensor.cx50_inlet_water_temp_c') not in ['unknown', 'unavailable']
          and states('sensor.cx50_outlet_water_temp_c') not in ['unknown', 'unavailable']
          and states('sensor.cx50_pump_flow_lpm') not in ['unknown', 'unavailable'] }}

  # ------------------------------------------------------------------------
  # Accumulated Energy Loss (Daily)
  # ------------------------------------------------------------------------
  - name: "HP Standby Energy Loss Daily"
    unique_id: hp_standby_energy_loss_daily
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    icon: mdi:alert-circle-outline
    state: >-
      {{ states('sensor.hp_standby_thermal_loss_accumulated') | float(0) }}

  # In sensors/cx_optimization_sensors.yaml

  # ------------------------------------------------------------------------
  # 1. GENERAL Heating Electrical Power (Includes DHW)
  # This is the source for your main "HP Heating Electrical Energy" accumulator
  # ------------------------------------------------------------------------
  - name: "HP Heating Electrical Power (kW)"
    unique_id: hp_heating_electrical_power_kw
    unit_of_measurement: "kW"
    device_class: power
    state_class: measurement
    icon: mdi:lightning-bolt
    state: >-
      {# FIX: Check for both 'Heat' AND 'HEAT + DHW' #}
      {% if states('sensor.heat_pump_operating_mode') in ['Heat', 'HEAT + DHW'] %}
        {% set watts = states('sensor.heat_pump_electrical_power_input') | float(0) %}
        {{ (watts / 1000) | round(3) }}
      {% else %}
        {{ 0.0 }}
      {% endif %}

  # ------------------------------------------------------------------------
  # 2. GENERAL Heating Thermal Power (Includes DHW)
  # This is the source for your main "HP Heating Thermal Energy" accumulator
  # ------------------------------------------------------------------------
  - name: "HP Heating Thermal Power (kW)"
    unique_id: hp_heating_thermal_power_kw
    unit_of_measurement: "kW"
    device_class: power
    state_class: measurement
    icon: mdi:fire
    state: >-
      {# FIX: Check for both 'Heat' AND 'HEAT + DHW' #}
      {% if states('sensor.heat_pump_operating_mode') in ['Heat', 'HEAT + DHW'] %}
        {% set watts = states('sensor.heat_pump_thermal_power_output') | float(0) %}
        {{ (watts / 1000) | round(3) }}
      {% else %}
        {{ 0.0 }}
      {% endif %}

  - name: "Model Heat Loss Per Degree F"
    unique_id: model_heat_loss_per_degree
    unit_of_measurement: "W"
    # device_class: power
    # state_class: measurement
    icon: mdi:fire
    state: >-
      {% set btu_loss_per_hour = states('input_number.manual_j_heat_loss_per_hour_at_design_temperature') | float(45000) %}
      {% set design_temp = states('input_number.home_heat_loss_design_temperature') | float(9) %}
      {% set target_temp = states('input_number.model_heat_target_temperature') | float(70) %}
      {% set watts = btu_loss_per_hour / 3412 | float %}
      {% set range = target_temp - design_temp | float %}
      {% set loss_per_degree = watts/range * 1000| float %}
      {{ loss_per_degree | float }}

  - name: "Model Heat Loss Per Hour"
    unique_id: model_heat_loss_per_hour
    unit_of_measurement: "kW"
    device_class: power
    state_class: measurement
    icon: mdi:fire
    state: >-
      {% set btu_loss_per_hour = states('input_number.manual_j_heat_loss_per_hour_at_design_temperature') | float(45000) %}
      {% set design_temp = states('input_number.home_heat_loss_design_temperature') | float(9) %}
      {% set target_temp = states('input_number.model_heat_target_temperature') | float(70) %}
      {% set watts = btu_loss_per_hour / 3412 | float %}
      {% set range = target_temp - design_temp | float %}
      {% set loss_per_degree = watts/range * 1000| float %}

      {% set average_temp = states('sensor.last_hour_temperature_average') | float(47)  %}

      {% set range = target_temp - average_temp | float %}
      {% set watts = (loss_per_degree * range)/1000 | float %}
      {{ watts | round(1) }}

  - name: "Model Heat Loss Per Day"
    unique_id: model_heat_loss_per_day
    unit_of_measurement: "kW"
    device_class: power
    state_class: measurement
    icon: mdi:fire
    state: >-
      {% set btu_loss_per_hour = states('input_number.manual_j_heat_loss_per_hour_at_design_temperature') | float(45000) %}
      {% set design_temp = states('input_number.home_heat_loss_design_temperature') | float(9) %}
      {% set target_temp = states('input_number.model_heat_target_temperature') | float(70) %}
      {% set watts = btu_loss_per_hour / 3412 | float %}
      {% set range = target_temp - design_temp | float %}
      {% set loss_per_degree = watts/range * 1000| float %}

      {% set average_temp = states('sensor.last_day_temperature_average') | float(47)  %}

      {% set range = target_temp - average_temp | float %}
      {% set watts_per_hour = (loss_per_degree * range)/1000 | float %}
      {% set watts_per_day = (watts_per_hour * 24) | float %}
      {{ watts_per_day | round(1) }}      