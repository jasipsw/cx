- binary_sensor:
  # CX50 Heat Pump Optimization Sensors
  # Purpose: Track heat pump cycles, startup penalties, and steady-state efficiency
  # Goal: Improve COP from 2.0-2.5 to manufacturer's 4.55 rating

  # ------------------------------------------------------------------------
  # Heat Pump Running Detection (Improved Logic)
  # More precise than just checking power > 500W
  # Requires: Water pump ON AND (Compressor running OR Active heat transfer)
  # ------------------------------------------------------------------------
  - name: "Heat Pump Running"
    unique_id: heat_pump_running
    state: >-
      {% set pump_on = is_state('binary_sensor.cx_c34_c4_water_pump', 'on') %}
      {% set compressor_freq = states('sensor.cx50_compressor_frequency') | float(0) %}
      {% set thermal_output = states('sensor.heat_pump_thermal_power_output') | float(0) %}

      {# Heat pump is running if pump is on AND (compressor running OR producing heat) #}
      {% if pump_on %}
        {{ (compressor_freq > 0 or thermal_output > 1000) | lower }}
      {% else %}
        {{ false | lower }}
      {% endif %}
    device_class: running # Valid for binary_sensor
    icon: mdi:heat-pump
    availability: >-
      {{ states('binary_sensor.cx_c34_c4_water_pump') not in ['unknown', 'unavailable']
          and states('sensor.cx50_compressor_frequency') not in ['unknown', 'unavailable']
          and states('sensor.heat_pump_thermal_power_output') not in ['unknown', 'unavailable'] }}

  # ------------------------------------------------------------------------
  # Heat Pump Startup Phase Detection
  # ------------------------------------------------------------------------
  - name: "Heat Pump In Startup Phase"
    unique_id: heat_pump_in_startup_phase
    state: >-
      {% set cycle_time = states('sensor.heat_pump_current_cycle_duration') | float(0) %}
      {{ (cycle_time > 0 and cycle_time < 180) | lower }}
    icon: mdi:rocket-launch

  # ------------------------------------------------------------------------
  # Heat Pump Steady State Detection
  # ------------------------------------------------------------------------
  - name: "Heat Pump Steady State"
    unique_id: heat_pump_steady_state
    state: >-
      {% set cycle_time = states('sensor.heat_pump_current_cycle_duration') | float(0) %}
      {% set remaining_time = states('sensor.heat_pump_current_cycle_remaining') | float(0) %}
      {{ (cycle_time > 180 and remaining_time > 10) | lower }} # Arbitrary 10s buffer before cycle end
    icon: mdi:check-circle-outline

  # ------------------------------------------------------------------------
  # Short Cycle Detection
  # MOVED from the broken, separate block into this main block
  # ------------------------------------------------------------------------
  - name: "Heat Pump Last Cycle Was Short"
    unique_id: heat_pump_last_cycle_was_short
    state: >-
      {% set last_cycle = states('sensor.heat_pump_last_cycle_duration') | float(0) %}
      {{ (last_cycle > 0 and last_cycle < 300) | lower }}
    icon: mdi:alert-circle

# ------------------------------------------------------------------------
# Calculated Sensors
# This block is correct and remains as-is
# ------------------------------------------------------------------------
- sensor:
  - name: "Heat Pump Average Steady State COP"
    unique_id: heat_pump_average_steady_state_cop
    state_class: measurement
    unit_of_measurement: "COP"
    state: >-
      {% set cop_entity = 'sensor.heat_pump_current_cop' %}
      {% set steady_state = is_state('binary_sensor.heat_pump_steady_state', 'on') %}
      {% set enable = is_state('input_boolean.enable_cop_optimization', 'on') %}

      {% if steady_state and enable %}
        {{ states(cop_entity) }}
      {% else %}
        {{ states('sensor.heat_pump_average_steady_state_cop') }}
      {% endif %}
      
  - name: "System Distribution Efficiency"
    unique_id: system_distribution_efficiency
    state_class: measurement
    unit_of_measurement: "%"
    state: >-
      {% set hp_output = states('sensor.heat_pump_thermal_power_output') | float(0) %}
      {% set hvac_load = states('sensor.hvac_thermal_power_used') | float(0) %}

      {% if hp_output > 0 %}
        {{ ((hvac_load / hp_output) * 100) | round(1) }}
      {% else %}
        0
      {% endif %}
    icon: mdi:percent

  - name: "System Loss Analysis"
    unique_id: system_loss_analysis
    state: >-
      {% set hp_output = states('sensor.heat_pump_thermal_power_output') | float(0) %}
      {% set hvac_load = states('sensor.hvac_thermal_power_used') | float(0) %}
      {% set efficiency = states('sensor.system_distribution_efficiency') | float(0) %}

      {% if hp_output < 100 %}
        Heat pump idle
      {% elif hvac_load > hp_output %}
        ERROR: HVAC load ({{ (hvac_load/1000) | round(1) }}kW) > HP output ({{ (hp_output/1000) | round(1) }}kW) - Check sensors!
      {% elif efficiency >= 90 %}
        Excellent ({{ efficiency }}% - {{ ((hp_output - hvac_load)/1000) | round(1) }}kW loss)
      {% elif efficiency >= 80 %}
        Good ({{ efficiency }}% - {{ ((hp_output - hvac_load)/1000) | round(1) }}kW loss)
      {% elif efficiency >= 70 %}
        Fair ({{ efficiency }}% - {{ ((hp_output - hvac_load)/1000) | round(1) }}kW loss)
      {% elif efficiency >= 50 %}
        Poor ({{ efficiency }}% - {{ ((hp_output - hvac_load)/1000) | round(1) }}kW loss)
      {% else %}
        Critical ({{ efficiency }}% - {{ ((hp_output - hvac_load)/1000) | round(1) }}kW loss)
      {% endif %}

  # ------------------------------------------------------------------------
  # System Distribution Efficiency (Daily)
  # Compares Energy Used by House (Load) vs. Energy Produced by HP (Source)
  # Formula: Efficiency = (Load / Source) * 100
  # ------------------------------------------------------------------------
  - name: "System Distribution Efficiency (Daily)"
    unique_id: system_distribution_efficiency_daily
    unit_of_measurement: "%"
    state_class: measurement
    icon: mdi:percent
    state: >-
      {% set load_kwh = states('sensor.hvac_thermal_energy_used_daily') | float(0) %}
      {% set source_kwh = states('sensor.hvac_hp_thermal_energy_produced_daily') | float(0) %}
      
      {% if source_kwh > 0.5 %}
        {{ ((load_kwh / source_kwh) * 100) | round(1) }}
      {% else %}
        {{ 'unavailable' }}
      {% endif %}      

  # ------------------------------------------------------------------------
  # Filtered Thermal Power (Space Heating ONLY)
  # EXCLUDES DHW to isolate true Space Heating COP
  # ------------------------------------------------------------------------
  - name: "HP Space Heating Thermal Power (kW)"
    unique_id: hp_space_heating_thermal_power_kw
    unit_of_measurement: "kW"
    device_class: power
    state_class: measurement
    icon: mdi:radiator
    state: >-
      {% if states('sensor.heat_pump_operating_mode') == 'Heat' %}
        {% set watts = states('sensor.heat_pump_thermal_power_output') | float(0) %}
        {{ (watts / 1000) | round(3) }}
      {% else %}
        {{ 0.0 }}
      {% endif %}      

  # ------------------------------------------------------------------------
  # House Heat Loss Coefficient (HLC) - Energy-Based (The stable one)
  # Formula: HLC = (Daily Energy / 24h) / Avg Delta T
  # ------------------------------------------------------------------------
  - name: "House Heat Loss Coefficient (Energy-Based)"
    unique_id: house_heat_loss_coefficient_energy_based
    unit_of_measurement: "kW/Â°C"
    state_class: measurement
    icon: mdi:home-thermometer
    state: >-
      {% set daily_kwh = states('sensor.hvac_thermal_energy_used_daily') | float(0) %}
      {% set avg_delta_t_c = states('sensor.house_delta_t_c_24_hour_mean') | float(0) %}
      
      {% if avg_delta_t_c > 1.0 %}
        {{ ((daily_kwh / 24.0) / avg_delta_t_c) | round(2) }}
      {% else %}
        {{ 'unavailable' }}
      {% endif %}

      # In sensors/cx_optimization_sensors.yaml

  # ------------------------------------------------------------------------
  # 1. GENERAL Heating Electrical Power (Includes DHW)
  # This is the source for your main "HP Heating Electrical Energy" accumulator
  # ------------------------------------------------------------------------
  - name: "HP Heating Electrical Power (kW)"
    unique_id: hp_heating_electrical_power_kw
    unit_of_measurement: "kW"
    device_class: power
    state_class: measurement
    icon: mdi:lightning-bolt
    state: >-
      {# FIX: Check for both 'Heat' AND 'HEAT + DHW' #}
      {% if states('sensor.heat_pump_operating_mode') in ['Heat', 'HEAT + DHW'] %}
        {% set watts = states('sensor.heat_pump_electrical_power_input') | float(0) %}
        {{ (watts / 1000) | round(3) }}
      {% else %}
        {{ 0.0 }}
      {% endif %}

  # ------------------------------------------------------------------------
  # 2. GENERAL Heating Thermal Power (Includes DHW)
  # This is the source for your main "HP Heating Thermal Energy" accumulator
  # ------------------------------------------------------------------------
  - name: "HP Heating Thermal Power (kW)"
    unique_id: hp_heating_thermal_power_kw
    unit_of_measurement: "kW"
    device_class: power
    state_class: measurement
    icon: mdi:fire
    state: >-
      {# FIX: Check for both 'Heat' AND 'HEAT + DHW' #}
      {% if states('sensor.heat_pump_operating_mode') in ['Heat', 'HEAT + DHW'] %}
        {% set watts = states('sensor.heat_pump_thermal_power_output') | float(0) %}
        {{ (watts / 1000) | round(3) }}
      {% else %}
        {{ 0.0 }}
      {% endif %}