# Heat Pump Cycle Tracking Sensors
# These sensors track the current cycle duration and provide cycle statistics

# ------------------------------------------------------------------------
# Heat Pump Current Cycle Duration (Seconds)
# Regular template sensor - auto-updates, no triggers needed
# ------------------------------------------------------------------------
- sensor:
  - name: "Heat Pump Current Cycle Duration"
    unique_id: heat_pump_current_cycle_duration
    unit_of_measurement: "s"
    device_class: duration
    state_class: measurement
    icon: mdi:timer
    state: >
      {% set is_running = is_state('binary_sensor.heat_pump_running', 'on') %}

      {% if not is_running %}
        {# Heat pump is OFF, so current cycle duration is 0 #}
        0
      {% else %}
        {# Heat pump is ON, calculate duration since it turned on #}
        {% set last_changed = states.binary_sensor.heat_pump_running.last_changed %}
        {% if last_changed %}
          {% set duration_seconds = (now() - last_changed).total_seconds() %}
          {{ duration_seconds | round(0) }}
        {% else %}
          0
        {% endif %}
      {% endif %}

# ------------------------------------------------------------------------
# Heat Pump Current Cycle Duration (Minutes)
# Same as above but in minutes for easier reading
# ------------------------------------------------------------------------
- sensor:
  - name: "Heat Pump Current Cycle Duration Minutes"
    unique_id: heat_pump_current_cycle_duration_minutes
    unit_of_measurement: "min"
    device_class: duration
    state_class: measurement
    icon: mdi:chart-line
    state: >
      {% set duration_s = states('sensor.heat_pump_current_cycle_duration') | float(0) %}
      {{ (duration_s / 60) | round(2) }}

# ------------------------------------------------------------------------
# Heat Pump Last Cycle Duration (Seconds)
# Stores the duration of the last completed cycle
# ------------------------------------------------------------------------
- trigger:
  - platform: state
    entity_id: binary_sensor.heat_pump_running
    from: "on"
    to: "off"
  sensor:
  - name: "Heat Pump Last Cycle Duration"
    unique_id: heat_pump_last_cycle_duration
    unit_of_measurement: "s"
    device_class: duration
    state_class: measurement
    icon: mdi:history
    state: >
      {% set cycle_duration = trigger.to_state.state %}
      {% set duration_seconds = states('sensor.heat_pump_current_cycle_duration') | float(0) %}

      {# Store the duration from just before the heat pump turned off #}
      {% if duration_seconds > 0 %}
        {{ duration_seconds | round(0) }}
      {% else %}
        {# If we can't get the duration, preserve the previous value #}
        {{ this.state if this.state not in ['unknown', 'unavailable', 'none'] else 0 }}
      {% endif %}

# ------------------------------------------------------------------------
# Heat Pump Last Cycle COP
# Captures the COP value when the cycle completes (ON â†’ OFF)
# ------------------------------------------------------------------------
- trigger:
  - platform: state
    entity_id: binary_sensor.heat_pump_running
    from: "on"
    to: "off"
  sensor:
  - name: "Heat Pump Last Cycle COP"
    unique_id: heat_pump_last_cycle_cop
    state_class: measurement
    icon: mdi:gauge
    state: >
      {% set current_cop = states('sensor.heat_pump_cop') | float(0) %}
      {% set last_known_cop = states('sensor.cx_last_known_cop') | float(0) %}

      {# Use current COP if valid, otherwise use last known COP #}
      {% if current_cop > 0 and current_cop < 10 %}
        {{ current_cop | round(2) }}
      {% elif last_known_cop > 0 and last_known_cop < 10 %}
        {{ last_known_cop | round(2) }}
      {% else %}
        {# Preserve previous value if both are invalid #}
        {{ this.state if this.state not in ['unknown', 'unavailable', 'none'] else 'unknown' }}
      {% endif %}

# ------------------------------------------------------------------------
# Heat Pump Current Cycle Remaining (Placeholder)
# This would require knowing the target cycle duration
# For now, return unavailable as we don't have that information
# ------------------------------------------------------------------------
- sensor:
  - name: "Heat Pump Current Cycle Remaining"
    unique_id: heat_pump_current_cycle_remaining
    unit_of_measurement: "s"
    device_class: duration
    state_class: measurement
    icon: mdi:timer-sand
    state: >
      {# This would require knowing target cycle duration #}
      {# For now, return a sensible default based on minimum runtime target #}
      {% set is_running = is_state('binary_sensor.heat_pump_running', 'on') %}
      {% set current_duration = states('sensor.heat_pump_current_cycle_duration') | float(0) %}
      {% set min_runtime_minutes = states('input_number.minimum_runtime_target') | float(10) %}
      {% set min_runtime_seconds = min_runtime_minutes * 60 %}

      {% if not is_running %}
        0
      {% elif current_duration < min_runtime_seconds %}
        {{ (min_runtime_seconds - current_duration) | round(0) }}
      {% else %}
        0
      {% endif %}

# ------------------------------------------------------------------------
# Heat Pump Standby Power
# Shows the electrical power consumed when heat pump is in standby (off)
# ------------------------------------------------------------------------
- sensor:
  - name: "Heat Pump Standby Power"
    unique_id: heat_pump_standby_power
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    icon: mdi:power-plug-off
    state: >
      {% set is_running = is_state('binary_sensor.heat_pump_running', 'on') %}
      {% set power = states('sensor.heat_pump_electrical_power_input') | float(0) %}

      {% if not is_running and power < 500 %}
        {# Heat pump is off, show current standby power #}
        {{ power | round(1) }}
      {% elif not is_running %}
        {# Heat pump is off but power reading seems high #}
        {{ power | round(1) }}
      {% else %}
        {# Heat pump is running, preserve last standby value #}
        {{ this.state if this.state not in ['unknown', 'unavailable', 'none'] else 0 }}
      {% endif %}

# ------------------------------------------------------------------------
# Heat Pump Last Standby Power
# Captures standby power consumption right before heat pump starts
# ------------------------------------------------------------------------
- trigger:
  - platform: state
    entity_id: binary_sensor.heat_pump_running
    from: "off"
    to: "on"
  sensor:
  - name: "Heat Pump Last Standby Power"
    unique_id: heat_pump_last_standby_power
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    icon: mdi:power-standby
    state: >
      {% set standby_power = states('sensor.heat_pump_standby_power') | float(0) %}

      {# Capture the standby power from just before startup #}
      {% if standby_power > 0 and standby_power < 500 %}
        {{ standby_power | round(1) }}
      {% else %}
        {# If we can't get valid standby power, preserve previous value #}
        {{ this.state if this.state not in ['unknown', 'unavailable', 'none'] else 0 }}
      {% endif %}

# ------------------------------------------------------------------------
# Heat Pump Hourly COP
# Calculates COP from hourly utility meters (thermal output / electrical input)
# Updates continuously throughout the hour as meters accumulate
# Use 'last' grouping in charts to get end-of-hour COP values
# ------------------------------------------------------------------------
- sensor:
  - name: "Heat Pump Hourly COP"
    unique_id: heat_pump_hourly_cop
    state_class: measurement
    icon: mdi:gauge
    state: >
      {% set output = states('sensor.hp_thermal_energy_output_hourly') | float(0) %}
      {% set input = states('sensor.hp_electrical_energy_hourly') | float(0) %}

      {% if input > 0.01 %}
        {{ (output / input) | round(2) }}
      {% else %}
        {# No input yet this hour, preserve previous value or return 0 #}
        {{ this.state if this.state not in ['unknown', 'unavailable', 'none'] else 0 }}
      {% endif %}
    attributes:
      thermal_output_kwh: >
        {{ states('sensor.hp_thermal_energy_output_hourly') | float(0) | round(3) }}
      electrical_input_kwh: >
        {{ states('sensor.hp_electrical_energy_hourly') | float(0) | round(3) }}
