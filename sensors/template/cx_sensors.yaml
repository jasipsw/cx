# Chiltrix Heat Pump - Template Sensors (CORRECTED)
# Fixed: Power calculation, fan speeds, temperature units

- sensor:

    # ------------------------------------------------------------------------
    # Operating Mode (Text Conversion)
    # ------------------------------------------------------------------------

    - name: "Heat Pump Operating Mode"
      unique_id: "heat_pump_operating_mode"
      state: >-
        {% set mode = states('sensor.cx50_operating_mode') | int(0) %}
        {% if mode == 0 %}Cool
        {% elif mode == 1 %}Heat
        {% elif mode == 2 %}DHW
        {% elif mode == 3 %}Cool + DHW
        {% elif mode == 4 %}Heat + DHW
        {% else %}Unknown
        {% endif %}

    - name: "Heat Pump Inlet Temperature"
      unique_id: heat_pump_inlet_temperature
      unit_of_measurement: "°F"
      state_class: measurement
      icon: mdi:thermometer
      state: >
        {% set inlet = states('sensor.cx50_inlet_water_temp_c') | float(0) %}
        {{ (inlet * 1.8 + 32.0) | round(2) }}

    - name: "Heat Pump Target Heating Temperature"
      unique_id: heat_pump_target_heating_temperature
      unit_of_measurement: "°F"
      state_class: measurement
      icon: mdi:thermometer
      state: >
        {% set temp = states('sensor.cx50_heating_target_temp_c') | float(0) %}
        {{ (temp * 1.8 + 32.0) | round(2) }}

    - name: "Heat Pump Target DHW Temperature"
      unique_id: heat_pump_target_dhw_temperature
      unit_of_measurement: "°F"
      state_class: measurement
      icon: mdi:thermometer
      state: >
        {% set temp = states('sensor.cx50_dhw_target_temp_c') | float(0) %}
        {{ (temp * 1.8 + 32.0) | round(2) }}        
         
    - name: "Heat Pump Ambient Temperature"
      unique_id: heat_pump_ambient_temperature
      unit_of_measurement: "°F"
      state_class: measurement
      icon: mdi:thermometer
      state: >
        {% set temp = states('sensor.cx50_ambient_temp_c') | float(0) %}
        {{ (temp * 1.8 + 32.0) | round(2) }}

    - name: "Heat Pump Outlet Temperature"
      unique_id: heat_pump_outlet_temperature
      unit_of_measurement: "°F"
      state_class: measurement
      icon: mdi:thermometer
      state: >
        {% set outlet = states('sensor.cx50_outlet_water_temp_c')  | float(0) %}
        {{ (outlet * 1.8 + 32.0) | round(2) }}

    # ------------------------------------------------------------------------
    # Temperature Delta (ΔT) - CORRECTED
    # ------------------------------------------------------------------------
    - name: "Heat Pump Delta T"
      unique_id: heat_pump_delta_t
      unit_of_measurement: "°F"
      state_class: measurement
      icon: mdi:delta
      state: >
        {% set inlet = states('sensor.heat_pump_inlet_temperature') | float(0) %}
        {% set outlet = states('sensor.heat_pump_outlet_temperature')  | float(0) %}
        {{ ( outlet - inlet ) | round(2) }}

    # ------------------------------------------------------------------------
    # Electrical Power Input - CORRECTED (V × I)
    # ------------------------------------------------------------------------

    - name: "Heat Pump Electrical Power Input"
      unique_id: heat_pump_electrical_power_input
      unit_of_measurement: "W"
      device_class: power
      state_class: measurement
      icon: mdi:flash
      state: >
        {% set voltage = states('sensor.cx50_input_ac_voltage') | float(0) %}
        {% set current = states('sensor.cx50_input_ac_current') | float(0) %}
        {{ (voltage * current) | round(0) }}
      availability: >
        {{ states('sensor.cx50_input_ac_voltage') not in ['unknown', 'unavailable']
            and states('sensor.cx50_input_ac_current') not in ['unknown', 'unavailable'] }}

    - name: "Heat Pump Electrical Power Input kW"
      unique_id: heat_pump_electrical_power_input_kw
      unit_of_measurement: "kW"
      device_class: power
      state_class: measurement
      icon: mdi:transmission-tower
      state: >
        {% set power = states('sensor.heat_pump_electrical_power_input') | float(0) / 1000 %}
        {{ power | round(3) }}

    # ------------------------------------------------------------------------
    # Compressor Speed (Percentage) - CORRECTED
    # ------------------------------------------------------------------------

    - name: "Heat Pump Compressor Speed"
      unique_id: heat_pump_compressor_speed
      unit_of_measurement: "%"
      state_class: measurement
      state: >-
        {% set freq = states('sensor.cx50_compressor_frequency') | float(0) %}
        {% set max_freq = 120 %}
        {{ ((freq / max_freq) * 100) | round(0) }}
      availability: "{{ states('sensor.cx50_compressor_frequency') not in ['unknown', 'unavailable'] }}"

    # ------------------------------------------------------------------------
    # Fan Speed (Average) - CORRECTED (divide by 10 for tenths of percent)
    # ------------------------------------------------------------------------

    - name: "Heat Pump Fan Speed"
      unique_id: heat_pump_fan_speed_pct
      unit_of_measurement: "%"
      state_class: measurement
      state: >-
        {% set fan1 = states('sensor.cx50_c45_ec_fan_motor_1_speed') | float(0) %}
        {% set fan2 = states('sensor.cx50_c46_ec_fan_motor_2_speed') | float(0) %}
        {# Values are in tenths of percent, so divide by 10 #}
        {% set avg_speed = ((fan1 + fan2) / 2) / 10 %}
        {{ avg_speed | round(1) }}

    # ------------------------------------------------------------------------
    # Thermal Power Output (Q) - CORRECTED
    # Formula: Q = ṁ × Cp × ΔT
    # ------------------------------------------------------------------------

    - name: "Heat Pump Thermal Power Output"
      unique_id: heat_pump_thermal_power_output
      unit_of_measurement: "W"
      device_class: power
      state_class: measurement
      icon: mdi:fire
      state: >-
        {% set inlet = states('sensor.cx50_inlet_water_temp_c') | float(0) %}
        {% set outlet = states('sensor.cx50_outlet_water_temp_c') | float(0) %}
        {% set flow_lpm = states('sensor.cx50_pump_flow_lpm') | float(0) %}
        {% set density = states('input_number.cx_fluid_density') | float(1025) %}
        {% set specific_heat = states('input_number.cx_fluid_specific_heat') | float(3.95) %}

        {% set delta_t = outlet - inlet %}
        {% set flow_lps = flow_lpm / 60 %}
        {% set flow_kgs = (flow_lps * density) / 1000 %}
        {% set specific_heat_j = specific_heat * 1000 %}
        {% set thermal_output = flow_kgs * specific_heat_j * delta_t %}
        {{ thermal_output | round(0) }}
      availability: >-
        {{ states('sensor.cx50_inlet_water_temp_c') not in ['unknown', 'unavailable']
            and states('sensor.cx50_outlet_water_temp_c') not in ['unknown', 'unavailable']
            and states('sensor.cx50_pump_flow_lpm') not in ['unknown', 'unavailable'] }}

    - name: "Heat Pump Thermal Power Output kW"
      unique_id: heat_pump_thermal_power_output_kw
      unit_of_measurement: "kW"
      device_class: power
      state_class: measurement
      icon: mdi:lightning-bolt-circle
      state: >
        {% set thermal_power = states('sensor.heat_pump_thermal_power_output') | float(0) / 1000 %}
        {{ thermal_power | round(2) }}

    # ------------------------------------------------------------------------
    # COP Calculation - CORRECTED (uses calculated electrical power)
    # Formula: COP = Thermal Power Output / Electrical Power Input
    # ------------------------------------------------------------------------

    - name: "Heat Pump COP"
      unique_id: heat_pump_cop
      state_class: measurement
      icon: mdi:gauge
      state: >-
        {% set input_power = states('sensor.heat_pump_electrical_power_input') | float(0) %}
        {% set output_power = states('sensor.heat_pump_thermal_power_output') | float(0) %}
        {% if input_power > 100 and output_power > 0 %}
          {{ (output_power / input_power) | round(2) }}
        {% else %}
          unavailable
        {% endif %}
      availability: >-
        {% set input_power = states('sensor.heat_pump_electrical_power_input') | float(0) %}
        {{ input_power > 100 }}

    # ------------------------------------------------------------------------
    # COP by Operating Mode
    # ------------------------------------------------------------------------

    - name: "Heat Pump COP Heating"
      unique_id: heat_pump_cop_heating
      state_class: measurement
      icon: mdi:fire
      state: >
        {% set operating_state = states('sensor.cx50_operating_mode') | int(0) %}
        {% set cop = states('sensor.heat_pump_cop') %}
        {% if operating_state == 2 and cop not in ['unavailable', 'unknown'] %}
          {{ cop }}
        {% else %}
          unavailable
        {% endif %}

    - name: "Heat Pump COP Cooling"
      unique_id: heat_pump_cop_cooling
      state_class: measurement
      icon: mdi:snowflake
      state: >
        {% set operating_state = states('sensor.cx50_operating_mode') | int(0) %}
        {% set cop = states('sensor.heat_pump_cop') %}
        {% if operating_state == 1 and cop not in ['unavailable', 'unknown'] %}
          {{ cop }}
        {% else %}
          unavailable
        {% endif %}

    - name: "Heat Pump COP DHW"
      unique_id: heat_pump_cop_dhw
      state_class: measurement
      icon: mdi:water-boiler
      state: >
        {% set operating_state = states('sensor.cx50_operating_mode') | int(0) %}
        {% set cop = states('sensor.heat_pump_cop') %}
        {% if operating_state == 4 and cop not in ['unavailable', 'unknown'] %}
          {{ cop }}
        {% else %}
          unavailable
        {% endif %}

    # ------------------------------------------------------------------------
    # Efficiency Rating (Human-readable)
    # ------------------------------------------------------------------------

    - name: "Heat Pump Efficiency Rating"
      unique_id: heat_pump_efficiency_rating
      state: >
        {% set cop = states('sensor.heat_pump_cop') | float(0) %}
        {% if cop >= 4.5 %}
          Excellent
        {% elif cop >= 3.5 %}
          Very Good
        {% elif cop >= 2.5 %}
          Good
        {% elif cop >= 1.5 %}
          Fair
        {% elif cop > 0 %}
          Poor
        {% else %}
          Unknown
        {% endif %}
      icon: >
        {% set cop = states('sensor.heat_pump_cop') | float(0) %}
        {% if cop >= 4.5 %}
          mdi:star-circle
        {% elif cop >= 3.5 %}
          mdi:star
        {% elif cop >= 2.5 %}
          mdi:thumb-up
        {% elif cop >= 1.5 %}
          mdi:minus-circle
        {% else %}
          mdi:alert-circle
        {% endif %}

    - name: "Heat Pump Thermal Power (kW)"
      unique_id: "heat_pump_thermal_power_kw"
      unit_of_measurement: "kW"
      state_class: "measurement"
      icon: mdi:sun-thermometer
      
      # Availability: Added check for the operating mode sensor
      availability: >-
        {% set bad_states = ['unavailable', 'unknown', 'none', ''] %}
        
        {% set flow_ok = states('sensor.cx50_pump_flow_gpm') not in bad_states %}
        {% set t_out_ok = states('sensor.heat_pump_outlet_temperature') not in bad_states %}
        {% set t_in_ok = states('sensor.heat_pump_inlet_temperature') not in bad_states %}
        {% set cp_ok = states('input_number.cx_fluid_specific_heat') not in bad_states %}
        {% set rho_ok = states('input_number.cx_fluid_density') not in bad_states %}
        {% set mode_ok = states('sensor.heat_pump_operating_mode') not in bad_states %}
        
        {{ flow_ok and t_out_ok and t_in_ok and cp_ok and rho_ok and mode_ok }}
        
      # State: Calculates thermal power (Q) in kW
      # Calculates for 'Heat' and 'Heat + DHW' modes (any mode producing space heating)
      state: >-
        {% set mode = states('sensor.heat_pump_operating_mode') %}

        {# Calculate if mode includes heating (Heat or Heat + DHW) #}
        {% if mode in ['Heat', 'Heat + DHW'] %}
          {% set flow_gpm = states('sensor.cx50_pump_flow_gpm') | float(0) %}
          {% set t_out_f = states('sensor.heat_pump_outlet_temperature') | float(0) %}
          {% set t_in_f = states('sensor.heat_pump_inlet_temperature') | float(0) %}
          
          {% set cp_fluid = states('input_number.cx_fluid_specific_heat') | float(3.95) %}
          {% set rho_fluid = states('input_number.cx_fluid_density') | float(970) %}
          
          {% set flow_factor = 0.00006309 %} 
          {% set delta_t_c = (t_out_f - t_in_f) / 1.8 %}
          {% set mass_flow_rate_kg_s = flow_gpm * flow_factor * rho_fluid %}
          {% set result_kw = mass_flow_rate_kg_s * cp_fluid * delta_t_c %}
          
          {{ result_kw | round(2) }}
        
        {% else %}
          {# If mode is anything else (Off, DHW, Cool, etc.), HVAC power is 0 #}
          {{ 0.0 }}
        {% endif %}


    - name: "Heat Pump Thermal Power (BTU/h)"
      unique_id: "heat_pump_thermal_power_btu_h"
      unit_of_measurement: "BTU/h"
      state_class: "measurement"
      icon: mdi:sun-thermometer-outline
      
      # Only available if the source kW sensor is available
      availability: >-
        {{ states('sensor.heat_pump_thermal_power_kw') | is_number }}
        
      # Conversion: 1 kW = 3412.14 BTU/h
      state: >-
        {% set kw_power = states('sensor.heat_pump_thermal_power_kw') | float(0) %}
        {{ (kw_power * 3412.14) | round(0) }}      

- binary_sensor:

    # Heat Pump Flow Status
    # Simple, reliable flow detection based on measured flow rate
    # ON = water flowing through heat pump (flow > 0 L/min)
    # OFF = no flow detected
    - name: "Heat Pump Flow Status"
      unique_id: heat_pump_flow_status
      device_class: running
      state: >-
        {% set flow_rate = states('sensor.cx50_pump_flow_lpm') | float(0) %}
        {{ 'on' if flow_rate > 0 else 'off' }}
      availability: >-
        {{ states('sensor.cx50_pump_flow_lpm') not in ['unknown', 'unavailable'] }}

