# G2 Diverter Valve Position Detection
# Detects whether G2 valve is directing flow to buffer tank or DHW tank
# Uses TREND sensors to detect which tank is actively heating
#
# TREND SENSORS are defined in sensors/binary_sensors.yaml:
#   - binary_sensor.dhw_tank_heating_trend
#   - binary_sensor.buffer_tank_heating_trend

# ============================================================================
# TRIGGER-BASED G2 VALVE POSITION SENSOR
# ============================================================================
# This sensor detects valve position ONLY when heat pump is running
# Shows "Idle" when HP is off (not latching to old state)

- trigger:
    # Trigger when DHW tank starts heating (AND HP is running)
    - platform: state
      entity_id: binary_sensor.dhw_tank_heating_trend
      to: 'on'
      id: dhw_heating

    # Trigger when buffer tank starts heating (AND HP is running)
    - platform: state
      entity_id: binary_sensor.buffer_tank_heating_trend
      to: 'on'
      id: buffer_heating

    # Trigger when HP stops running - reset to Idle
    - platform: state
      entity_id: binary_sensor.heat_pump_running
      to: 'off'
      id: hp_stopped

    # Trigger when HP starts running - check active trends
    - platform: state
      entity_id: binary_sensor.heat_pump_running
      to: 'on'
      id: hp_started

    # Trigger when both trends turn OFF - reset to idle
    - platform: template
      value_template: >-
        {{ is_state('binary_sensor.dhw_tank_heating_trend', 'off')
           and is_state('binary_sensor.buffer_tank_heating_trend', 'off') }}
      id: both_trends_off

    # Also check on startup
    - platform: homeassistant
      event: start
      id: startup

  sensor:
    # ------------------------------------------------------------------------
    # G2 Valve Position (Primary State Sensor)
    # Only shows heating mode when HP is running AND trends detected
    # ------------------------------------------------------------------------
    - name: "G2 Valve Position"
      unique_id: g2_valve_position
      icon: mdi:valve
      state: >-
        {% set hp_running = is_state('binary_sensor.heat_pump_running', 'on') %}
        {% set dhw_trend = is_state('binary_sensor.dhw_tank_heating_trend', 'on') %}
        {% set buf_trend = is_state('binary_sensor.buffer_tank_heating_trend', 'on') %}

        {# G2 valve defaults to Buffer Tank position when HP is off #}
        {# Only switches to DHW Tank when HP running AND actively heating DHW #}

        {% if not hp_running %}
          {# HP off - valve in default rest position (buffer tank) #}
          Buffer Tank (HP Off)
        {% elif trigger.id == 'dhw_heating' and hp_running %}
          {# DHW trend detected while HP running #}
          DHW Tank
        {% elif trigger.id == 'buffer_heating' and hp_running %}
          {# Buffer trend detected while HP running #}
          Buffer Tank
        {% elif trigger.id == 'hp_stopped' %}
          {# HP just stopped - return to default position #}
          Buffer Tank (HP Off)
        {% elif trigger.id == 'both_trends_off' and hp_running %}
          {# Both trends off but HP still running - check modbus mode #}
          {% set mode = states('sensor.heat_pump_operating_mode') %}
          {% if 'DHW' in mode %}
            DHW Tank
          {% else %}
            Buffer Tank
          {% endif %}
        {% elif trigger.id == 'startup' or trigger.id == 'hp_started' %}
          {# On startup/HP start, check which trend is currently active #}
          {% if hp_running and dhw_trend %}
            DHW Tank
          {% elif hp_running and buf_trend %}
            Buffer Tank
          {% elif hp_running %}
            {# HP running but no clear trend yet - check modbus mode #}
            {% set mode = states('sensor.heat_pump_operating_mode') %}
            {% if 'DHW' in mode %}
              DHW Tank
            {% else %}
              Buffer Tank
            {% endif %}
          {% else %}
            {# HP not running - default position #}
            Buffer Tank (HP Off)
          {% endif %}
        {% else %}
          {# Maintain current state only if HP still running #}
          {% if hp_running %}
            {{ this.state if this.state is defined else 'Buffer Tank' }}
          {% else %}
            {# HP stopped running - return to default #}
            Buffer Tank (HP Off)
          {% endif %}
        {% endif %}

    # ------------------------------------------------------------------------
    # G2 Valve Last Switch Time (with trigger context)
    # ------------------------------------------------------------------------
    - name: "G2 Valve Last Switch"
      unique_id: g2_valve_last_switch
      device_class: timestamp
      icon: mdi:clock-outline
      state: >-
        {{ now().isoformat() }}
      attributes:
        trigger_id: >-
          {{ trigger.id if trigger is defined else 'unknown' }}
        previous_state: >-
          {{ this.state if this.state is defined else 'never' }}

# ============================================================================
# BINARY SENSOR - G2 DHW Mode (for automations)
# ============================================================================
- binary_sensor:
  - name: "G2 Valve DHW Mode"
    unique_id: g2_valve_dhw_mode
    device_class: heat
    icon: mdi:water-boiler
    state: >-
      {# Only ON if HP running AND valve position is DHW Tank #}
      {% set hp_running = is_state('binary_sensor.heat_pump_running', 'on') %}
      {% set valve_dhw = is_state('sensor.g2_valve_position', 'DHW Tank') %}
      {{ (hp_running and valve_dhw) | lower }}
