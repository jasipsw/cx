# G2 Diverter Valve Position Detection
# Detects whether G2 valve is directing flow to buffer tank or DHW tank
#
# METHOD: Delta-T Correlation (2025-11-18)
# Compares HP outlet temperature with buffer and DHW supply temperatures
# Whichever supply line is closer to HP outlet is receiving the flow
#
# FUTURE: When post-G2-valve sensor is installed, update sensor references below
# to use the new sensor for faster and more accurate detection

- sensor:
    # ------------------------------------------------------------------------
    # G2 Valve Position (Delta-T Correlation Method)
    # ------------------------------------------------------------------------
    - name: "G2 Valve Position"
      unique_id: g2_valve_position
      icon: mdi:valve
      state: >-
        {% set hp_running = is_state('binary_sensor.heat_pump_running', 'on') %}

        {% if not hp_running %}
          {# HP is off - valve position doesn't matter #}
          Idle (HP Off)

        {% else %}
          {# HP is running - determine valve position by temperature correlation #}

          {# Get HP outlet temperature (heat source) #}
          {% set hp_outlet = states('sensor.heat_pump_outlet_temperature') | float(0) %}

          {# Get buffer supply temperature (one possible destination) #}
          {# TODO: Replace with post-G2-valve sensor when available #}
          {% set buffer_supply = states('sensor.supply_from_heat_pump') | float(0) %}

          {# Get DHW supply temperature (other possible destination) #}
          {# TODO: Replace with post-G2-valve sensor when available #}
          {% set dhw_supply = states('sensor.dhw_supply_from_heat_pump') | float(0) %}

          {# Calculate temperature differences (abs value) #}
          {% set buffer_diff = (hp_outlet - buffer_supply) | abs %}
          {% set dhw_diff = (hp_outlet - dhw_supply) | abs %}

          {# Whichever supply line is closer to HP outlet is receiving flow #}
          {# Use 10Â°F threshold to avoid false positives from stale temps #}
          {% if buffer_diff < dhw_diff and buffer_diff < 10.0 %}
            Buffer Tank
          {% elif dhw_diff < buffer_diff and dhw_diff < 10.0 %}
            DHW Tank
          {% else %}
            {# Temperature differences too large or equal - unable to determine #}
            Unknown (No Clear Match)
          {% endif %}
        {% endif %}

      attributes:
        hp_outlet_temp: >-
          {{ states('sensor.heat_pump_outlet_temperature') | float(0) | round(2) }}
        buffer_supply_temp: >-
          {{ states('sensor.supply_from_heat_pump') | float(0) | round(2) }}
        dhw_supply_temp: >-
          {{ states('sensor.dhw_supply_from_heat_pump') | float(0) | round(2) }}
        buffer_temp_diff: >-
          {% set hp_outlet = states('sensor.heat_pump_outlet_temperature') | float(0) %}
          {% set buffer_supply = states('sensor.supply_from_heat_pump') | float(0) %}
          {{ (hp_outlet - buffer_supply) | abs | round(2) }}
        dhw_temp_diff: >-
          {% set hp_outlet = states('sensor.heat_pump_outlet_temperature') | float(0) %}
          {% set dhw_supply = states('sensor.dhw_supply_from_heat_pump') | float(0) %}
          {{ (hp_outlet - dhw_supply) | abs | round(2) }}
        detection_method: "Delta-T Correlation"

    # ------------------------------------------------------------------------
    # G2 Valve Last Position Change (for tracking valve switches)
    # ------------------------------------------------------------------------
    - name: "G2 Valve Last Switch"
      unique_id: g2_valve_last_switch
      device_class: timestamp
      icon: mdi:clock-outline
      state: >-
        {# Update timestamp whenever valve position changes #}
        {% set current_position = states('sensor.g2_valve_position') %}
        {% set previous_position = this.attributes.previous_position if this.attributes.previous_position is defined else 'unknown' %}

        {% if current_position != previous_position and current_position not in ['unknown', 'unavailable'] %}
          {{ now().isoformat() }}
        {% else %}
          {{ this.state if this.state is defined else now().isoformat() }}
        {% endif %}
      attributes:
        current_position: >-
          {{ states('sensor.g2_valve_position') }}
        previous_position: >-
          {# Store current position for next update comparison #}
          {{ states('sensor.g2_valve_position') }}

# ============================================================================
# BINARY SENSOR - G2 DHW Mode (for automations)
# ============================================================================
- binary_sensor:
  - name: "G2 Valve DHW Mode"
    unique_id: g2_valve_dhw_mode
    device_class: heat
    icon: mdi:water-boiler
    state: >-
      {# ON if HP running AND valve position is DHW Tank #}
      {% set hp_running = is_state('binary_sensor.heat_pump_running', 'on') %}
      {% set valve_dhw = is_state('sensor.g2_valve_position', 'DHW Tank') %}
      {{ 'on' if (hp_running and valve_dhw) else 'off' }}
