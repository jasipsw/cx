# G2 Diverter Valve Position Detection
# Detects whether G2 valve is directing flow to buffer tank or DHW tank
# Uses TREND sensors to detect which tank is actively heating
#
# TREND SENSORS are defined in sensors/binary_sensors.yaml:
#   - binary_sensor.dhw_tank_heating_trend
#   - binary_sensor.buffer_tank_heating_trend

# ============================================================================
# TRIGGER-BASED G2 VALVE POSITION SENSOR
# ============================================================================
# This sensor detects valve position by comparing both trend sensors
# Improved logic handles mode transitions when both trends might be active

- trigger:
    # Trigger on ANY DHW trend change (ON or OFF)
    - platform: state
      entity_id: binary_sensor.dhw_tank_heating_trend
      id: dhw_trend_change

    # Trigger on ANY buffer trend change (ON or OFF)
    - platform: state
      entity_id: binary_sensor.buffer_tank_heating_trend
      id: buffer_trend_change

    # Trigger when HP stops running - reset to Idle
    - platform: state
      entity_id: binary_sensor.heat_pump_running
      to: 'off'
      id: hp_stopped

    # Trigger when HP starts running - check active trends
    - platform: state
      entity_id: binary_sensor.heat_pump_running
      to: 'on'
      id: hp_started

    # Also check on startup
    - platform: homeassistant
      event: start
      id: startup

  sensor:
    # ------------------------------------------------------------------------
    # G2 Valve Position (Primary State Sensor)
    # Comparative logic: evaluates BOTH trends together
    # ------------------------------------------------------------------------
    - name: "G2 Valve Position"
      unique_id: g2_valve_position
      icon: mdi:valve
      state: >-
        {% set hp_running = is_state('binary_sensor.heat_pump_running', 'on') %}
        {% set dhw_trend = is_state('binary_sensor.dhw_tank_heating_trend', 'on') %}
        {% set buf_trend = is_state('binary_sensor.buffer_tank_heating_trend', 'on') %}

        {# G2 valve defaults to Buffer Tank position when HP is off #}
        {% if not hp_running %}
          Buffer Tank (HP Off)

        {# HP is running - use comparative trend logic #}
        {% elif dhw_trend and not buf_trend %}
          {# Only DHW rising - valve to DHW tank #}
          DHW Tank

        {% elif buf_trend and not dhw_trend %}
          {# Only buffer rising - valve to buffer tank #}
          Buffer Tank

        {% elif dhw_trend and buf_trend %}
          {# BOTH trends active - use most recent trigger OR delta-T correlation #}
          {% if trigger.id == 'dhw_trend_change' and trigger.to_state.state == 'on' %}
            {# DHW just turned ON while buffer already ON - switching to DHW #}
            DHW Tank
          {% elif trigger.id == 'buffer_trend_change' and trigger.to_state.state == 'on' %}
            {# Buffer just turned ON while DHW already ON - switching to heating #}
            Buffer Tank
          {% else %}
            {# Both on but no clear recent trigger - use delta-T correlation #}
            {% set hp_out = states('sensor.heat_pump_outlet_temperature') | float(0) %}
            {% set hp_in = states('sensor.heat_pump_inlet_temperature') | float(0) %}
            {% set dhw_supply = states('sensor.dhw_supply_from_heat_pump') | float(0) %}
            {% set buf_supply = states('sensor.supply_from_heat_pump') | float(0) %}
            {% set buf_return = states('sensor.buffer_return_to_heat_pump') | float(0) %}

            {% set hp_delta = (hp_out - hp_in) | abs %}
            {% set dhw_delta = (dhw_supply - hp_in) | abs %}
            {% set buf_delta = (buf_supply - buf_return) | abs %}

            {# Compare which delta-T is closer to HP delta-T #}
            {% set dhw_diff = (dhw_delta - hp_delta) | abs %}
            {% set buf_diff = (buf_delta - hp_delta) | abs %}

            {% if dhw_diff < buf_diff %}
              DHW Tank
            {% else %}
              Buffer Tank
            {% endif %}
          {% endif %}

        {% elif not dhw_trend and not buf_trend %}
          {# Neither trend active - use delta-T correlation #}
          {% set hp_out = states('sensor.heat_pump_outlet_temperature') | float(0) %}
          {% set hp_in = states('sensor.heat_pump_inlet_temperature') | float(0) %}
          {% set dhw_supply = states('sensor.dhw_supply_from_heat_pump') | float(0) %}
          {% set buf_supply = states('sensor.supply_from_heat_pump') | float(0) %}
          {% set buf_return = states('sensor.buffer_return_to_heat_pump') | float(0) %}

          {% set hp_delta = (hp_out - hp_in) | abs %}
          {% set dhw_delta = (dhw_supply - hp_in) | abs %}
          {% set buf_delta = (buf_supply - buf_return) | abs %}

          {# Compare which delta-T is closer to HP delta-T #}
          {% set dhw_diff = (dhw_delta - hp_delta) | abs %}
          {% set buf_diff = (buf_delta - hp_delta) | abs %}

          {% if dhw_diff < buf_diff %}
            DHW Tank
          {% else %}
            Buffer Tank
          {% endif %}

        {% else %}
          {# Fallback - use delta-T correlation #}
          {% set hp_out = states('sensor.heat_pump_outlet_temperature') | float(0) %}
          {% set hp_in = states('sensor.heat_pump_inlet_temperature') | float(0) %}
          {% set dhw_supply = states('sensor.dhw_supply_from_heat_pump') | float(0) %}
          {% set buf_supply = states('sensor.supply_from_heat_pump') | float(0) %}
          {% set buf_return = states('sensor.buffer_return_to_heat_pump') | float(0) %}

          {% set hp_delta = (hp_out - hp_in) | abs %}
          {% set dhw_delta = (dhw_supply - hp_in) | abs %}
          {% set buf_delta = (buf_supply - buf_return) | abs %}

          {# Compare which delta-T is closer to HP delta-T #}
          {% set dhw_diff = (dhw_delta - hp_delta) | abs %}
          {% set buf_diff = (buf_delta - hp_delta) | abs %}

          {% if dhw_diff < buf_diff %}
            DHW Tank
          {% else %}
            Buffer Tank
          {% endif %}
        {% endif %}
      attributes:
        dhw_trend: >-
          {{ is_state('binary_sensor.dhw_tank_heating_trend', 'on') }}
        buffer_trend: >-
          {{ is_state('binary_sensor.buffer_tank_heating_trend', 'on') }}
        hp_delta_t: >-
          {% set hp_out = states('sensor.heat_pump_outlet_temperature') | float(0) %}
          {% set hp_in = states('sensor.heat_pump_inlet_temperature') | float(0) %}
          {{ (hp_out - hp_in) | round(2) }}
        dhw_delta_t: >-
          {% set dhw_supply = states('sensor.dhw_supply_from_heat_pump') | float(0) %}
          {% set hp_in = states('sensor.heat_pump_inlet_temperature') | float(0) %}
          {{ (dhw_supply - hp_in) | round(2) }}
        buffer_delta_t: >-
          {% set buf_supply = states('sensor.supply_from_heat_pump') | float(0) %}
          {% set buf_return = states('sensor.buffer_return_to_heat_pump') | float(0) %}
          {{ (buf_supply - buf_return) | round(2) }}
        decision_method: >-
          {% set hp_running = is_state('binary_sensor.heat_pump_running', 'on') %}
          {% set dhw_trend = is_state('binary_sensor.dhw_tank_heating_trend', 'on') %}
          {% set buf_trend = is_state('binary_sensor.buffer_tank_heating_trend', 'on') %}
          {% if not hp_running %}
            HP Off
          {% elif dhw_trend and not buf_trend %}
            DHW Trend Only
          {% elif buf_trend and not dhw_trend %}
            Buffer Trend Only
          {% elif dhw_trend and buf_trend %}
            Both Trends - Delta-T or Trigger
          {% elif not dhw_trend and not buf_trend %}
            No Trends - Delta-T Correlation
          {% else %}
            Delta-T Correlation
          {% endif %}

    # ------------------------------------------------------------------------
    # G2 Valve Last Switch Time (with trigger context)
    # ------------------------------------------------------------------------
    - name: "G2 Valve Last Switch"
      unique_id: g2_valve_last_switch
      device_class: timestamp
      icon: mdi:clock-outline
      state: >-
        {{ now().isoformat() }}
      attributes:
        trigger_id: >-
          {{ trigger.id if trigger is defined else 'unknown' }}
        previous_state: >-
          {{ this.state if this.state is defined else 'never' }}

# ============================================================================
# BINARY SENSOR - G2 DHW Mode (for automations)
# ============================================================================
- binary_sensor:
  - name: "G2 Valve DHW Mode"
    unique_id: g2_valve_dhw_mode
    device_class: heat
    icon: mdi:water-boiler
    state: >-
      {# Only ON if HP running AND valve position is DHW Tank #}
      {% set hp_running = is_state('binary_sensor.heat_pump_running', 'on') %}
      {% set valve_dhw = is_state('sensor.g2_valve_position', 'DHW Tank') %}
      {{ 'on' if (hp_running and valve_dhw) else 'off' }}
