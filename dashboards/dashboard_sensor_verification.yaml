title: Sensor Verification
views:
  - type: sections
    max_columns: 3
    title: Sensor Verification
    path: sensor-verification
    icon: mdi:check-decagram
    sections:
      - type: grid
        column_span: 3
        
        cards:
          # ========================================================================
          # PRIORITY MONITORING - PRIMARY FOCUS AREAS
          # ========================================================================
          - type: custom:flex-table-card
            title: üîå Heat Pump Last Run Statistics
            auto_format: true
            clickable: true
            grid_options:
              columns: 18
            entities:
              - sensor.heat_pump_last_run_energy_input
              - sensor.heat_pump_last_run_energy_output 
              - sensor.heat_pump_last_run_timestamp
              - sensor.heat_pump_run_start_energy_input
              - sensor.heat_pump_run_start_energy_output
              - sensor.heat_pump_input_power_interval_kwh
              - sensor.heat_pump_output_power_interval_kwh
#              - sensor.heat_pump_last_run_cop

            columns:
              - name: ""
                data: icon
                align: center

              - name: Sensor Name
                data: friendly_name
                align: left

              - name: unique_id
                data: object_id
                align: left

              # COLUMN 2: VALUE
              - name: Value
                data: state
                align: center

              # - name: Status
              #   data: state
              #   align: center
              #   modify: "['unknown', 'unavailable'].includes(x) ? '‚ùå' : '‚úÖ'"

          # HEAT PUMP FLOW DETECTION
          - type: markdown
            title: üåä Heat Pump Flow Detection (NEW - Priority #1)
            grid_options:
              columns: full
            content: |
              ## Flow Status - Reliable Detection (No C34 Dependencies)

              | Sensor | State | Source | Logic | Status |
              |--------|-------|--------|-------|--------|
              | **Flow Status** | **{{ states('binary_sensor.heat_pump_flow_status') }}** | Flow meter | ON if flow > 0 L/min | {{ '‚úÖ WORKING' if states('binary_sensor.heat_pump_flow_status') == 'on' else '‚ö†Ô∏è No flow' }} |
              | **HP Running** | **{{ states('binary_sensor.heat_pump_running') }}** | Flow + Compressor/Thermal | Flow ON AND (Comp>0 OR Thermal>1kW) | {{ '‚úÖ WORKING' if states('binary_sensor.heat_pump_running') == 'on' else '‚è∏Ô∏è Off' }} |

              ### Current Measurements
              | Metric | Value | Status |
              |--------|-------|--------|
              | Flow Rate | {{ states('sensor.cx50_pump_flow_lpm') }} L/min | {{ '‚úÖ' if states('sensor.cx50_pump_flow_lpm') | float(0) > 0 else '‚ùå' }} |
              | Compressor Freq | {{ states('sensor.cx50_compressor_frequency') }} Hz | {{ '‚úÖ Running' if states('sensor.cx50_compressor_frequency') | float(0) > 0 else '‚è∏Ô∏è Off' }} |
              | Thermal Output | {{ states('sensor.heat_pump_thermal_power_output') }} W | {{ '‚úÖ Producing heat' if states('sensor.heat_pump_thermal_power_output') | float(0) > 1000 else '‚è∏Ô∏è Standby' }} |

              **Key Changes:**
              - ‚úÖ Created `binary_sensor.heat_pump_flow_status` - simple, reliable
              - ‚úÖ Eliminated all C34 modbus dependencies (unreliable)
              - ‚úÖ `binary_sensor.heat_pump_running` now uses flow_status
              - ‚úÖ Detection chain now operational!

          # ENERGY ACCUMULATION & UTILITY METERS
          - type: markdown
            title: ‚ö° Energy Accumulation & Utility Meters (Priority #2)
            grid_options:
              columns: full
            content: |
              ## Integration Sensors (Power ‚Üí Energy)

              | Sensor | Current Value | Source | Source Power | Method | Status |
              |--------|---------------|--------|--------------|--------|--------|
              | **Input Energy** | {{ states('sensor.heat_pump_input_power_interval_kwh') }} kWh | Electrical Power | {{ states('sensor.heat_pump_input_power_interval_kwh') }} W | Riemann (left) | {{ '‚úÖ' if states('sensor.heat_pump_input_power_interval_kwh') not in ['unknown', 'unavailable'] else '‚ùå' }} |
              | **Output Energy** | {{ states('sensor.heat_pump_output_power_interval_kwh') }} kWh | Thermal Power | {{ states('sensor.heat_pump_output_power_interval_kwh') }} W | Riemann (left) | {{ '‚úÖ' if states('sensor.heat_pump_output_power_interval_kwh') not in ['unknown', 'unavailable'] else '‚ùå' }} |

              **Energy-Based COP:** {{ (states('sensor.heat_pump_output_power_interval_kwh') | float(0) / states('sensor.heat_pump_input_power_interval_kwh') | float(1)) | round(2) if states('sensor.heat_pump_input_power_interval_kwh') | float(0) > 0 else 'N/A' }}

              ## Utility Meters (Energy Tracking)

              ### Input Energy Meters
              | Period | Value | Sanity Check | Status |
              |--------|-------|--------------|--------|
              | **Hourly** | {{ states('sensor.hp_electrical_energy_hourly') }} kWh | {{ '‚úÖ <100kWh' if states('sensor.hp_electrical_energy_hourly') | float(0) < 100 else '‚ùå' }} | {{ '‚úÖ' if states('sensor.hp_electrical_energy_hourly') not in ['unknown', 'unavailable'] else '‚ùå' }} |
              | **Daily** | {{ states('sensor.hp_electrical_energy_daily') }} kWh | {{ '‚úÖ <2000kWh' if states('sensor.hp_electrical_energy_daily') | float(0) < 2000 else '‚ùå' }} | {{ '‚úÖ' if states('sensor.hp_electrical_energy_daily') not in ['unknown', 'unavailable'] else '‚ùå' }} |
              | **Monthly** | {{ states('sensor.hp_electrical_energy_monthly') }} kWh | {{ '‚úÖ <60000kWh' if states('sensor.hp_electrical_energy_monthly') | float(0) < 60000 else '‚ùå' }} | {{ '‚úÖ' if states('sensor.hp_electrical_energy_monthly') not in ['unknown', 'unavailable'] else '‚ùå' }} |

              ### Output Energy Meters
              | Period | Value | Source Health | Status |
              |--------|-------|---------------|--------|
              | **Hourly** | {{ states('sensor.hp_thermal_energy_output_hourly') }} kWh | {{ '‚úÖ' if states('sensor.hp_thermal_energy_output_hourly') not in ['unknown', 'unavailable'] else '‚ùå' }} | {{ '‚úÖ' if states('sensor.hp_thermal_energy_output_hourly') | float(0) < 100 else '‚ö†Ô∏è High' }} |
              | **Daily** | {{ states('sensor.hp_thermal_energy_output_daily') }} kWh | {{ '‚úÖ' if states('sensor.hp_thermal_energy_output_daily') not in ['unknown', 'unavailable'] else '‚ùå' }} | {{ '‚úÖ' if states('sensor.hp_thermal_energy_output_daily') | float(0) < 2000 else '‚ö†Ô∏è High' }} |
              | **Monthly** | {{ states('sensor.hp_thermal_energy_output_monthly') }} kWh | {{ '‚úÖ' if states('sensor.hp_thermal_energy_output_monthly') not in ['unknown', 'unavailable'] else '‚ùå' }} | {{ '‚ö†Ô∏è Needs reset' if states('sensor.hp_thermal_energy_output_monthly') | float(0) > 10000 else '‚úÖ' }} |


              **Notes:**
              - Integration sensors accumulate power (W) over time to produce energy (kWh)
              - Utility meters reset on schedule (hourly/daily/monthly)
              - Monthly meter may need manual reset if showing total accumulated value

          # ========================================================================
          # DETAILED DIAGNOSTICS
          # ========================================================================

          # CRITICAL SENSOR AVAILABILITY CHECK
          - type: markdown
            title: üîç Critical Sensor Availability (Debug)
            grid_options:
              columns: full
            content: |
              ## Source Sensors (Direct Dependencies)
              | Sensor | State | Attributes | Status |
              |--------|-------|------------|--------|
              | `sensor.cx50_c34` | {{ states('sensor.cx50_c34') }} | unit: {{ state_attr('sensor.cx50_c34', 'unit_of_measurement') }} | {{ '‚úÖ' if states('sensor.cx50_c34') not in ['unknown', 'unavailable'] else '‚ùå' }} |
              | `sensor.cx50_pump_flow_lpm` | {{ states('sensor.cx50_pump_flow_lpm') }} | unit: {{ state_attr('sensor.cx50_pump_flow_lpm', 'unit_of_measurement') }} | {{ '‚úÖ' if states('sensor.cx50_pump_flow_lpm') not in ['unknown', 'unavailable'] else '‚ùå' }} |
              | `sensor.cx50_compressor_frequency` | {{ states('sensor.cx50_compressor_frequency') }} | unit: {{ state_attr('sensor.cx50_compressor_frequency', 'unit_of_measurement') }} | {{ '‚úÖ' if states('sensor.cx50_compressor_frequency') not in ['unknown', 'unavailable'] else '‚ùå' }} |
              | `sensor.heat_pump_thermal_power_output` | {{ states('sensor.heat_pump_thermal_power_output') }} | unit: {{ state_attr('sensor.heat_pump_thermal_power_output', 'unit_of_measurement') }} | {{ '‚úÖ' if states('sensor.heat_pump_thermal_power_output') not in ['unknown', 'unavailable'] else '‚ùå' }} |
              | `sensor.cx50_outlet_temp` | {{ states('sensor.cx50_outlet_temp') }} | unit: {{ state_attr('sensor.cx50_outlet_temp', 'unit_of_measurement') }} | {{ '‚úÖ' if states('sensor.cx50_outlet_temp') not in ['unknown', 'unavailable'] else '‚ùå MISSING' }} |

              ## Calculated Binary Sensors
              | Sensor | State | Type | Expected |
              |--------|-------|------|----------|
              | `binary_sensor.cx_c34_water_pump` | {{ states('binary_sensor.cx_c34_water_pump') }} | binary_sensor | {{ 'ON (C34=1, Flow=19)' if states('sensor.cx50_c34') == '1' and states('sensor.cx50_pump_flow_lpm') | float(0) > 1 else 'Check logic' }} |
              | `binary_sensor.heat_pump_running` | {{ states('binary_sensor.heat_pump_running') }} | binary_sensor | {{ 'ON (Pump+Compressor+Thermal)' if states('sensor.cx50_compressor_frequency') | float(0) > 0 else 'Check dependencies' }} |

              ## Logic Evaluation (Real-time)
              {% set c34_value = states('sensor.cx50_c34') | int(0) %}
              {% set flow_rate = states('sensor.cx50_pump_flow_lpm') | float(0) %}
              {% set pump_should_be_on = c34_value == 1 or flow_rate > 1.0 %}

              | Variable | Value | Logic |
              |----------|-------|-------|
              | `c34_value` | {{ c34_value }} | Modbus status |
              | `flow_rate` | {{ flow_rate }} | Actual flow |
              | `c34_value == 1` | {{ c34_value == 1 }} | Boolean check |
              | `flow_rate > 1.0` | {{ flow_rate > 1.0 }} | Flow threshold |
              | **Water Pump Should Be** | **{{ 'ON' if pump_should_be_on else 'OFF' }}** | `c34==1 OR flow>1.0` |
              | **Actual Water Pump State** | **{{ states('binary_sensor.cx_c34_water_pump') }}** | ‚ùå MISMATCH if different |

          # BINARY SENSOR LOGIC DEBUG
          - type: markdown
            title: üêõ Binary Sensor Logic Debug
            grid_options:
              columns: full
            content: |
              ## Water Pump Binary Sensor Logic
              **File:** `sensors/template/cx_sensors.yaml:338`

              ```yaml
              state: >
                {% raw %}{% set c34_value = states('sensor.cx50_c34') | int(0) %}
                {% set flow_rate = states('sensor.cx50_pump_flow_lpm') | float(0) %}
                {{ c34_value == 1 or flow_rate > 1.0 }}{% endraw %}
              ```

              **Current Evaluation:**
              {% set c34 = states('sensor.cx50_c34') | int(0) %}
              {% set flow = states('sensor.cx50_pump_flow_lpm') | float(0) %}
              - C34 Raw State: `{{ states('sensor.cx50_c34') }}`
              - C34 Parsed: `{{ c34 }}` (type: int)
              - Flow Raw State: `{{ states('sensor.cx50_pump_flow_lpm') }}`
              - Flow Parsed: `{{ flow }}` (type: float)
              - **Expression Result: `{{ c34 == 1 or flow > 1.0 }}`**
              - **Actual Sensor State: `{{ states('binary_sensor.cx_c34_water_pump') }}`**

              **Availability Template:**
              ```yaml
              {% raw %}{{ states('sensor.cx50_c34') not in ['unknown', 'unavailable']
                  and states('sensor.cx50_pump_flow_lpm') not in ['unknown', 'unavailable'] }}{% endraw %}
              ```
              - C34 available: {{ states('sensor.cx50_c34') not in ['unknown', 'unavailable'] }}
              - Flow available: {{ states('sensor.cx50_pump_flow_lpm') not in ['unknown', 'unavailable'] }}
              - **Availability Result: {{ states('sensor.cx50_c34') not in ['unknown', 'unavailable'] and states('sensor.cx50_pump_flow_lpm') not in ['unknown', 'unavailable'] }}**

              ---

              ## Heat Pump Running Binary Sensor Logic
              **File:** `sensors/template/cx_optimization_sensors.yaml:11`

              {% set pump_state = states('binary_sensor.cx_c34_water_pump') %}
              {% set pump_on = is_state('binary_sensor.cx_c34_water_pump', 'on') %}
              {% set compressor_freq = states('sensor.cx50_compressor_frequency') | float(0) %}
              {% set thermal_output = states('sensor.heat_pump_thermal_power_output') | float(0) %}

              | Dependency | Raw State | Parsed Value | Check Result |
              |------------|-----------|--------------|--------------|
              | Water Pump State | `{{ pump_state }}` | - | `is_state('...', 'on')` = {{ pump_on }} |
              | Compressor Freq | `{{ states('sensor.cx50_compressor_frequency') }}` | {{ compressor_freq }} Hz | `> 0` = {{ compressor_freq > 0 }} |
              | Thermal Output | `{{ states('sensor.heat_pump_thermal_power_output') }}` | {{ thermal_output }} W | `> 1000` = {{ thermal_output > 1000 }} |

              **Logic Flow:**
              1. IF pump_on = {{ pump_on }}
              2. THEN check: (compressor > 0 OR thermal > 1000)
              3. Compressor check: {{ compressor_freq > 0 }}
              4. Thermal check: {{ thermal_output > 1000 }}
              5. **Expected Result: {{ pump_on and (compressor_freq > 0 or thermal_output > 1000) }}**
              6. **Actual State: `{{ states('binary_sensor.heat_pump_running') }}`**

              **Issue:** {% if pump_state in ['unknown', 'unavailable'] %}‚ùå Water pump sensor is {{ pump_state }} - this blocks heat_pump_running{% elif not pump_on %}‚ö†Ô∏è Water pump is OFF or not 'on' state{% else %}‚úÖ Should be working{% endif %}

          # MODE FILTERING DEBUG
          - type: markdown
            title: üîÄ Mode Filtering Debug (Why Thermal kW = 0?)
            grid_options:
              columns: full
            content: |
              ## Raw vs Mode-Filtered Thermal Power
              | Sensor | Value | File | Status |
              |--------|-------|------|--------|
              | `sensor.heat_pump_thermal_power_output` | {{ states('sensor.heat_pump_thermal_power_output') }}W | cx_sensors.yaml | ‚úÖ Raw calculation |
              | `sensor.heat_pump_thermal_power_kw` | {{ states('sensor.heat_pump_thermal_power_kw') }}kW | cx_sensors.yaml:275 | {{ '‚úÖ' if states('sensor.heat_pump_operating_mode') == 'Heat' else '‚ö†Ô∏è Filtered to 0 (mode != Heat)' }} |

              **Current Operating Mode:** `{{ states('sensor.heat_pump_operating_mode') }}`

              ## Mode Filtering Logic (cx_sensors.yaml:295-318)
              ```yaml
              {% raw %}{% if mode == 'Heat' %}
                {# Calculate thermal power #}
                {{ result_kw | round(2) }}
              {% else %}
                {# If mode is anything else (Off, DHW, Cool, etc.), HVAC power is 0 #}
                {{ 0.0 }}
              {% endif %}{% endraw %}
              ```

              **Analysis:**
              - Current mode: `{{ states('sensor.heat_pump_operating_mode') }}`
              - Mode check: `mode == 'Heat'` ‚Üí {{ states('sensor.heat_pump_operating_mode') == 'Heat' }}
              - **Result:** {% if states('sensor.heat_pump_operating_mode') == 'Heat' %}‚úÖ Calculating thermal power{% else %}‚ùå Mode is "{{ states('sensor.heat_pump_operating_mode') }}", not "Heat" - returns 0.0kW{% endif %}

              **Issue:** This sensor intentionally returns 0 for "Heat + DHW", "DHW", "Cool", etc. modes. It only calculates for pure "Heat" mode. This is likely incorrect - should calculate for both "Heat" and "Heat + DHW".

              **Impact:**
              - Integration sensor `heat_pump_output_power_interval_kwh` uses the RAW `thermal_power_output` sensor (‚úÖ correct)
              - This filtered `thermal_power_kw` sensor is only used for mode-specific tracking
              - **Note:** The integration sensor correctly uses the unfiltered power source

          # INTEGRATION SENSOR DEEP DIVE
          - type: markdown
            title: ‚ö° Integration Sensor Status
            grid_options:
              columns: full
            content: |
              ## Integration Sensor Status
              | Sensor | State | Source | Source State | Source Value |
              |--------|-------|--------|--------------|--------------|
              | `sensor.heat_pump_input_power_interval_kwh` | {{ states('sensor.heat_pump_input_power_interval_kwh') }} kWh | `sensor.heat_pump_electrical_power_input` | {{ states('sensor.heat_pump_electrical_power_input') }} | {{ states('sensor.heat_pump_electrical_power_input') }}W |
              | `sensor.heat_pump_output_power_interval_kwh` | {{ states('sensor.heat_pump_output_power_interval_kwh') }} kWh | `sensor.heat_pump_thermal_power_output` | {{ states('sensor.heat_pump_thermal_power_output') }} | {{ states('sensor.heat_pump_thermal_power_output') }}W |

              ## Integration Sensor Attributes
              **Heat Pump Output Power Interval:**
              - State: `{{ states('sensor.heat_pump_output_power_interval_kwh') }}`
              - Last Reset: {{ state_attr('sensor.heat_pump_output_power_interval_kwh', 'last_reset') }}
              - Source: {{ state_attr('sensor.heat_pump_output_power_interval_kwh', 'source') }}
              - Unit: {{ state_attr('sensor.heat_pump_output_power_interval_kwh', 'unit_of_measurement') }}
              - Device Class: {{ state_attr('sensor.heat_pump_output_power_interval_kwh', 'device_class') }}
              - State Class: {{ state_attr('sensor.heat_pump_output_power_interval_kwh', 'state_class') }}

              **Issue Analysis:**
              {% if states('sensor.heat_pump_output_power_interval_kwh') in ['unknown', 'unavailable'] %}
              ‚ùå **Integration sensor not initialized**
              - Check: Is `sensor.heat_pump_thermal_power_output` available? {{ '‚úÖ Yes' if states('sensor.heat_pump_thermal_power_output') not in ['unknown', 'unavailable'] else '‚ùå No' }}
              - Check: Has enough time passed for integration? (needs source sensor history)
              - Check: Integration platform configuration in `legacy_sensors.yaml`
              {% else %}
              ‚úÖ Integration sensor working
              {% endif %}

          # SHELLY INTEGRATION DIAGNOSTIC
          - type: markdown
            title: üîç Shelly Integration Temperature Sensors (Diagnostic)
            grid_options:
              columns: full
            content: |
              ## Shelly Temperature Sensors (By Entity ID Pattern)

              | Friendly Name | Entity ID | Current Value | Unit | Status |
              |---------------|-----------|---------------|------|--------|
              {%- for entity in states.sensor %}
                {%- if 'shelly' in entity.entity_id | lower and 'temperature' in entity.entity_id | lower %}
              | {{ entity.name }} | `{{ entity.entity_id }}` | {{ entity.state }} | {{ state_attr(entity.entity_id, 'unit_of_measurement') }} | {{ '‚úÖ' if entity.state not in ['unknown', 'unavailable'] else '‚ùå' }} |
                {%- endif %}
              {%- endfor %}

              ## All Temperature Sensors (Any Source)
              **This shows ALL temperature sensors in the system, including renamed or wrapped Shelly sensors:**

              | Friendly Name | Entity ID | Current Value | Unit | Device Class | Status |
              |---------------|-----------|---------------|------|--------------|--------|
              {%- for entity in states.sensor %}
                {%- if state_attr(entity.entity_id, 'device_class') == 'temperature' %}
              | {{ entity.name }} | `{{ entity.entity_id }}` | {{ entity.state }} | {{ state_attr(entity.entity_id, 'unit_of_measurement') }} | {{ state_attr(entity.entity_id, 'device_class') }} | {{ '‚úÖ' if entity.state not in ['unknown', 'unavailable'] else '‚ùå' }} |
                {%- endif %}
              {%- endfor %}

              ## Buffer Tank Wrapper Sensors (Expected)
              | Wrapper Sensor | Source | Status |
              |----------------|--------|--------|
              | `sensor.buffer_supply_from_heat_pump` | `sensor.shellyplus1_c4d8d5543fc0_temperature` | {{ '‚úÖ' if states('sensor.buffer_supply_from_heat_pump') not in ['unknown', 'unavailable'] else '‚ùå Not found' }} |
              | `sensor.buffer_return_to_heat_pump` | `sensor.shellyplus1_c4d8d5543fc0_temperature_3` | {{ '‚úÖ' if states('sensor.buffer_return_to_heat_pump') not in ['unknown', 'unavailable'] else '‚ùå Not found' }} |

              **Purpose:** Verify Shelly integration sensor names match our configuration

          # ALL UTILITY METERS DIAGNOSTIC
          - type: markdown
            title: üìä All Utility Meters (Diagnostic)
            grid_options:
              columns: full
            content: |
              ## All Utility Meters in System
              **This shows ALL utility meters and energy tracking sensors (state_class: total_increasing):**

              | Friendly Name | Entity ID | Current Value | Unit | Source | Last Reset | Status |
              |---------------|-----------|---------------|------|--------|------------|--------|
              {%- for entity in states.sensor %}
                {%- if state_attr(entity.entity_id, 'state_class') == 'total_increasing' %}
              | {{ entity.name }} | `{{ entity.entity_id }}` | {{ entity.state }} | {{ state_attr(entity.entity_id, 'unit_of_measurement') }} | {{ state_attr(entity.entity_id, 'source') if state_attr(entity.entity_id, 'source') else '-' }} | {{ state_attr(entity.entity_id, 'last_reset')[:19] if state_attr(entity.entity_id, 'last_reset') else '-' }} | {{ '‚úÖ' if entity.state not in ['unknown', 'unavailable'] else '‚ùå' }} |
                {%- endif %}
              {%- endfor %}

              **Purpose:** Verify all utility meters are created and tracking correctly

              **Key Utility Meters to Check:**
              - `hp_electrical_energy_hourly/daily/monthly` - HP electrical input
              - `hp_thermal_energy_output_hourly/daily/monthly` - HP thermal output
              - `buffer_tank_energy_input_hourly/daily/monthly` - Buffer tank energy (NEW)
              - `dhw_tank_energy_input_hourly/daily/monthly` - DHW tank energy (NEW)

          # ALL INTEGRATION SENSORS DIAGNOSTIC
          - type: markdown
            title: ‚à´ All Integration Sensors (Diagnostic)
            grid_options:
              columns: full
            content: |
              ## All Integration/Accumulation Sensors in System
              **This shows ALL sensors that accumulate power into energy (state_class: total):**

              | Friendly Name | Entity ID | Current Value | Unit | Source Sensor | Method | Status |
              |---------------|-----------|---------------|------|---------------|--------|--------|
              {%- for entity in states.sensor %}
                {%- if state_attr(entity.entity_id, 'state_class') == 'total' %}
              | {{ entity.name }} | `{{ entity.entity_id }}` | {{ entity.state }} | {{ state_attr(entity.entity_id, 'unit_of_measurement') }} | {{ state_attr(entity.entity_id, 'source') if state_attr(entity.entity_id, 'source') else '-' }} | {{ state_attr(entity.entity_id, 'integration_method') if state_attr(entity.entity_id, 'integration_method') else '-' }} | {{ '‚úÖ' if entity.state not in ['unknown', 'unavailable'] else '‚ùå' }} |
                {%- endif %}
              {%- endfor %}

              **Purpose:** Verify all integration sensors are created and accumulating correctly

              **How Integration Works:**
              - Takes instantaneous power measurement (W)
              - Integrates over time using Riemann sum (usually "left" method)
              - Produces accumulated energy (kWh)
              - Feeds into utility meters for hourly/daily/monthly tracking

              **Key Integration Sensors to Check:**
              - `heat_pump_input_power_interval_kwh` - Accumulates electrical power ‚Üí energy
              - `heat_pump_output_power_interval_kwh` - Accumulates thermal power ‚Üí energy
              - `buffer_tank_energy_input` - **NEW** Accumulates buffer thermal power
              - `dhw_tank_energy_input` - **NEW** Accumulates DHW thermal power


          # G2 VALVE & DHW SYSTEM STATUS
          - type: markdown
            title: üîÄ G2 Valve Position Detection (Delta-T Correlation)
            grid_options:
              columns: full
            content: |
              ## Detection Method: Temperature Correlation
              The G2 diverter valve routes heat pump output to either **Buffer Tank** (heating) or **DHW Tank** (hot water).

              **Method:** Compare HP outlet temperature with buffer and DHW supply temperatures.
              **Rule:** Whichever supply line is closest to HP outlet is currently receiving flow.

              ## Current System Status
              | Item | Value | Status |
              |------|-------|--------|
              | HP Running | {{ states('binary_sensor.heat_pump_running') }} | {{ '‚úÖ Active' if is_state('binary_sensor.heat_pump_running', 'on') else '‚è∏Ô∏è Idle' }} |
              | Operating Mode | {{ states('sensor.heat_pump_operating_mode') }} | Modbus |
              | **G2 Valve Position** | **{{ states('sensor.g2_valve_position') }}** | {{ '‚úÖ' if states('sensor.g2_valve_position') not in ['unknown', 'unavailable', 'Unknown'] else '‚ùå' }} |
              | G2 DHW Mode | {{ states('binary_sensor.g2_valve_dhw_mode') }} | Binary sensor |

              ## Temperature Correlation Analysis
              {% set hp_outlet = state_attr('sensor.g2_valve_position', 'hp_outlet_temp') | float(0) %}
              {% set buffer_supply = state_attr('sensor.g2_valve_position', 'buffer_supply_temp') | float(0) %}
              {% set dhw_supply = state_attr('sensor.g2_valve_position', 'dhw_supply_temp') | float(0) %}
              {% set buffer_diff = state_attr('sensor.g2_valve_position', 'buffer_temp_diff') | float(0) %}
              {% set dhw_diff = state_attr('sensor.g2_valve_position', 'dhw_temp_diff') | float(0) %}

              | Measurement | Temperature | Temp Diff from HP Outlet | Match |
              |-------------|-------------|--------------------------|-------|
              | **HP Outlet** | **{{ hp_outlet }}¬∞F** | - | Heat source |
              | Buffer Supply | {{ buffer_supply }}¬∞F | {{ buffer_diff }}¬∞F | {{ '‚úÖ MATCH' if buffer_diff < dhw_diff and buffer_diff < 10 else '‚ûñ' }} |
              | DHW Supply | {{ dhw_supply }}¬∞F | {{ dhw_diff }}¬∞F | {{ '‚úÖ MATCH' if dhw_diff < buffer_diff and dhw_diff < 10 else '‚ûñ' }} |

              **Decision:** {{ 'üî• **Buffer Tank**' if buffer_diff < dhw_diff and buffer_diff < 10 else 'üöø **DHW Tank**' if dhw_diff < buffer_diff and dhw_diff < 10 else '‚ùì **Unknown**' }}

              **Why this works:**
              - Active flow path stays close to HP outlet temp (accounting for pipe losses)
              - Inactive path cools down to ambient/tank temperature
              - Works during idle, defrost, and differential cooling scenarios
              - No time windows needed - updates instantly

              ## Tank Temperatures
              | Tank | Current Temp | Supply from HP | Return to HP | Delta-T |
              |------|--------------|----------------|--------------|---------|
              | Buffer | {{ states('sensor.buffer_tank_temperature') }}¬∞F | {{ states('sensor.supply_from_heat_pump') }}¬∞F | {{ states('sensor.buffer_return_to_heat_pump') }}¬∞F | {{ (states('sensor.supply_from_heat_pump') | float(0) - states('sensor.buffer_return_to_heat_pump') | float(0)) | round(2) }}¬∞F |
              | DHW | {{ states('sensor.dhw_tank_temperature') }}¬∞F | {{ states('sensor.dhw_supply_from_heat_pump') }}¬∞F | {{ states('sensor.dhw_return_to_heat_pump') }}¬∞F | {{ (states('sensor.dhw_supply_from_heat_pump') | float(0) - states('sensor.dhw_return_to_heat_pump') | float(0)) | round(2) }}¬∞F |

              ## DHW System Sensors
              | Sensor | Value | Status |
              |--------|-------|--------|
              | DHW Supply (to house) | {{ states('sensor.dhw_hot_water_out') }}¬∞F | {{ '‚úÖ' if states('sensor.dhw_hot_water_out') not in ['unknown', 'unavailable'] else '‚ö†Ô∏è' }} |
              | DHW Cold Water In | {{ states('sensor.dhw_cold_water_in') }}¬∞F | {{ '‚úÖ' if states('sensor.dhw_cold_water_in') not in ['unknown', 'unavailable'] else '‚ö†Ô∏è' }} |

              ## Detection Status
              {% set valve_pos = states('sensor.g2_valve_position') %}
              {% set hp_running = is_state('binary_sensor.heat_pump_running', 'on') %}

              {% if not hp_running %}
              - ‚è∏Ô∏è **Heat Pump OFF** ‚Üí Position: {{ valve_pos }}
              {% elif 'Buffer Tank' in valve_pos %}
              - üî• **Heating Mode** ‚Üí G2 directing to buffer tank (space heating)
              - Buffer temp diff: {{ buffer_diff }}¬∞F (closest to HP outlet)
              {% elif 'DHW Tank' in valve_pos %}
              - üöø **DHW Mode** ‚Üí G2 directing to DHW tank (hot water)
              - DHW temp diff: {{ dhw_diff }}¬∞F (closest to HP outlet)
              {% else %}
              - ‚ùì **Unknown** ‚Üí Cannot determine position (temp differences > 10¬∞F threshold)
              {% endif %}

              **Future Enhancement:** Add temperature sensor immediately downstream of G2 valve for instant detection (~10s vs ~3min lag)

          # RADIANT ZONE STATUS
          - type: markdown
            title: üå°Ô∏è Radiant Zone Status
            grid_options:
              columns: full
            content: |
              ## Buffer Tank Distribution
              **Buffer Tank Status:**
              | Metric | Value |
              |--------|-------|
              | Supply Temp | {{ states('sensor.hvac_buffer_tank_supply_temperature') }}¬∞F |
              | Return Temp | {{ states('sensor.hvac_buffer_tank_return_temperature') }}¬∞F |
              | Delta-T | {{ states('sensor.hvac_buffer_tank_delta_t') }}¬∞F |
              | Flow Rate | {{ states('sensor.hvac_buffer_tank_flow_rate') }} LPM |
              | HVAC Thermal Power | {{ states('sensor.hvac_thermal_power_used') }}W ({{ (states('sensor.hvac_thermal_power_used') | float(0) / 1000) | round(2) }}kW) |

              ## Radiant Floor Zones
              | Zone | Call Status | Flow Temp | Return Temp | Status |
              |------|-------------|-----------|-------------|--------|
              | Master Suite | {{ states('binary_sensor.master_suite_radiant') }} | {{ states('sensor.master_suite_radiant_flow_temp') }}¬∞F | {{ states('sensor.master_suite_radiant_return_temp') }}¬∞F | {{ 'üî• Active' if is_state('binary_sensor.master_suite_radiant', 'on') else '‚è∏Ô∏è Idle' }} |
              | Lower Level | {{ states('binary_sensor.lower_level_radiant') }} | {{ states('sensor.lower_level_radiant_flow_temp') }}¬∞F | {{ states('sensor.lower_level_radiant_return_temp') }}¬∞F | {{ 'üî• Active' if is_state('binary_sensor.lower_level_radiant', 'on') else '‚è∏Ô∏è Idle' }} |

              ## Air Handler Units (AHUs)
              | AHU | Status | Supply Temp | Room Temp | Coil Active |
              |-----|--------|-------------|-----------|-------------|
              | Master Suite AHU | {{ states('binary_sensor.master_suite_ahu') }} | {{ states('sensor.master_suite_ahu_supply_temp') }}¬∞F | {{ states('sensor.shellyplus1_8813bf9fc014_temperature_4') }}¬∞F | {{ '‚úÖ' if is_state('binary_sensor.master_suite_ahu', 'on') else '‚è∏Ô∏è' }} |
              | Lower Level AHU | {{ states('binary_sensor.lower_level_ahu') }} | {{ states('sensor.lower_level_ahu_supply_temp') }}¬∞F | {{ states('sensor.shellyplus1_048308d6a208_temperature_2') }}¬∞F | {{ '‚úÖ' if is_state('binary_sensor.lower_level_ahu', 'on') else '‚è∏Ô∏è' }} |

              ## Heat Distribution Analysis
              {% set hp_thermal = states('sensor.heat_pump_thermal_power_output') | float(0) / 1000 %}
              {% set hvac_load = states('sensor.hvac_thermal_power_used') | float(0) / 1000 %}
              {% set efficiency = states('sensor.system_distribution_efficiency') | float(0) %}
              {% set master_on = is_state('binary_sensor.master_suite_radiant', 'on') %}
              {% set lower_on = is_state('binary_sensor.lower_level_radiant', 'on') %}

              | Metric | Value | Analysis |
              |--------|-------|----------|
              | HP Output | {{ hp_thermal | round(2) }}kW | Total heat produced |
              | HVAC Load | {{ hvac_load | round(2) }}kW | Heat to distribution |
              | Distribution Efficiency | {{ efficiency | round(1) }}% | {{ '‚úÖ Good' if efficiency > 80 else '‚ö†Ô∏è Low - check for DHW mode' }} |
              | Active Zones | {{ (1 if master_on else 0) + (1 if lower_on else 0) }} zones | {{ 'Master' if master_on else '' }}{{ ', ' if master_on and lower_on else '' }}{{ 'Lower' if lower_on else '' }} |

              **Expected Behavior:**
              - Pure "Heat" mode: Efficiency > 80% (most heat to zones)
              - "Heat + DHW" mode: Efficiency 20-50% (heat split between zones and DHW)
              - Pure "DHW" mode: Efficiency < 20% (most heat to DHW tank)

              **Current:** {% if 'DHW' in states('sensor.heat_pump_operating_mode') %}{{ '‚ö†Ô∏è In DHW mode - low efficiency expected' }}{% else %}{{ '‚úÖ Heating mode - efficiency should be high' }}{% endif %}

          # MODBUS COMMUNICATION STATUS
          - type: markdown
            title: üì° Modbus Communication Status
            grid_options:
              columns: full
            content: |
              ## CX50 Heat Pump Modbus Sensors
              | Sensor | Entity ID | Current Value | Unit | Status |
              |--------|-----------|---------------|------|--------|
              | Operating Mode | `sensor.heat_pump_operating_mode` | {{ states('sensor.heat_pump_operating_mode') }} | - | {{ '‚úÖ' if states('sensor.heat_pump_operating_mode') not in ['unknown', 'unavailable'] else '‚ùå' }} |
              | Input Voltage | `sensor.cx50_input_ac_voltage` | {{ states('sensor.cx50_input_ac_voltage') }} | V | {{ '‚úÖ' if states('sensor.cx50_input_ac_voltage') not in ['unknown', 'unavailable'] else '‚ùå' }} |
              | Input Current | `sensor.cx50_input_ac_current` | {{ states('sensor.cx50_input_ac_current') }} | A | {{ '‚úÖ' if states('sensor.cx50_input_ac_current') not in ['unknown', 'unavailable'] else '‚ùå' }} |
              | Compressor Freq | `sensor.cx50_compressor_frequency` | {{ states('sensor.cx50_compressor_frequency') }} | Hz | {{ '‚úÖ' if states('sensor.cx50_compressor_frequency') not in ['unknown', 'unavailable'] else '‚ùå' }} |
              | Inlet Temp | `sensor.heat_pump_inlet_temperature` | {{ states('sensor.heat_pump_inlet_temperature') }} | ¬∞F | {{ '‚úÖ' if states('sensor.heat_pump_inlet_temperature') not in ['unknown', 'unavailable'] else '‚ùå' }} |
              | Outlet Temp | `sensor.heat_pump_outlet_temperature` | {{ states('sensor.heat_pump_outlet_temperature') }} | ¬∞F | {{ '‚úÖ' if states('sensor.heat_pump_outlet_temperature') not in ['unknown', 'unavailable'] else '‚ùå MISSING' }} |
              | Flow Rate (GPM) | `sensor.cx50_pump_flow_gpm` | {{ states('sensor.cx50_pump_flow_gpm') }} | GPM | {{ '‚úÖ' if states('sensor.cx50_pump_flow_gpm') not in ['unknown', 'unavailable'] else '‚ùå' }} |
              | Flow Rate (LPM) | `sensor.cx50_pump_flow_lpm` | {{ states('sensor.cx50_pump_flow_lpm') }} | LPM | {{ '‚úÖ' if states('sensor.cx50_pump_flow_lpm') not in ['unknown', 'unavailable'] else '‚ùå' }} |
              | C34 Water Pump | `sensor.cx50_c34` | {{ states('sensor.cx50_c34') }} | - | {{ '‚úÖ' if states('sensor.cx50_c34') not in ['unknown', 'unavailable'] else '‚ùå' }} |

              ## Communication Health
              {% set sensors_to_check = [
                'sensor.heat_pump_operating_mode',
                'sensor.cx50_input_ac_voltage',
                'sensor.cx50_input_ac_current',
                'sensor.cx50_compressor_frequency',
                'sensor.heat_pump_inlet_temperature',
                'sensor.cx50_pump_flow_gpm',
                'sensor.cx50_pump_flow_lpm',
                'sensor.cx50_c34'
              ] %}
              {% set available_count = namespace(value=0) %}
              {% for sensor in sensors_to_check %}
                {% if states(sensor) not in ['unknown', 'unavailable'] %}
                  {% set available_count.value = available_count.value + 1 %}
                {% endif %}
              {% endfor %}

              - **Total Modbus Sensors Checked:** {{ sensors_to_check | length }}
              - **Available:** {{ available_count.value }}
              - **Unavailable:** {{ sensors_to_check | length - available_count.value }}
              - **Health:** {{ (available_count.value / sensors_to_check | length * 100) | round(0) }}%

              {% if available_count.value == sensors_to_check | length %}
              ‚úÖ **All Modbus sensors responding correctly**
              {% elif available_count.value > (sensors_to_check | length * 0.8) %}
              ‚ö†Ô∏è **Mostly working** - {{ sensors_to_check | length - available_count.value }} sensor(s) unavailable
              {% else %}
              ‚ùå **Communication issues** - Check Modbus connection to CX50 heat pump
              {% endif %}

              ## Missing/Failed Sensors
              | Sensor | Status | Action Needed |
              |--------|--------|---------------|
              {% for sensor in sensors_to_check %}
                {% if states(sensor) in ['unknown', 'unavailable'] %}
              | `{{ sensor }}` | {{ states(sensor) }} | Check Modbus register mapping |
                {% endif %}
              {% endfor %}
              {% if states('sensor.heat_pump_outlet_temperature') in ['unknown', 'unavailable'] %}
              | `sensor.heat_pump_outlet_temperature` | {{ states('sensor.heat_pump_outlet_temperature') }} | ‚ùå **CRITICAL** - Needed for G2 valve detection |
              {% endif %}

              **Note:** Missing outlet temperature sensor is blocking G2 valve position detection.

          # ENTITY REGISTRY CHECK
          - type: markdown
            title: üìã Entity Registry Check
            grid_options:
              columns: full
            content: |
              ## Template Sensors by File
              This section helps identify which sensor files are loaded and which entities exist.

              ### Critical Binary Sensors
              | Entity | Exists? | Current State | File |
              |--------|---------|---------------|------|
              | `binary_sensor.cx_c34_water_pump` | {{ '‚úÖ Yes' if states('binary_sensor.cx_c34_water_pump') not in ['unknown', 'unavailable'] or states('binary_sensor.cx_c34_water_pump') in ['on', 'off'] else '‚ùå No' }} | {{ states('binary_sensor.cx_c34_water_pump') }} | cx_sensors.yaml:338 |
              | `binary_sensor.heat_pump_running` | {{ '‚úÖ Yes' if states('binary_sensor.heat_pump_running') not in ['unknown', 'unavailable'] or states('binary_sensor.heat_pump_running') in ['on', 'off'] else '‚ùå No' }} | {{ states('binary_sensor.heat_pump_running') }} | cx_optimization_sensors.yaml:11 |
              | `binary_sensor.g2_valve_dhw_mode` | {{ '‚úÖ Yes' if states('binary_sensor.g2_valve_dhw_mode') not in ['unknown', 'unavailable'] or states('binary_sensor.g2_valve_dhw_mode') in ['on', 'off'] else '‚ùå No' }} | {{ states('binary_sensor.g2_valve_dhw_mode') }} | g2_valve_sensors.yaml |

              ### Critical Sensors
              | Entity | Exists? | Current Value | File |
              |--------|---------|---------------|------|
              | `sensor.heat_pump_thermal_power_output` | {{ '‚úÖ Yes' if states('sensor.heat_pump_thermal_power_output') not in ['unknown', 'unavailable'] else '‚ùå No' }} | {{ states('sensor.heat_pump_thermal_power_output') }}W | cx_sensors.yaml |
              | `sensor.heat_pump_thermal_power_kw` | {{ '‚úÖ Yes' if states('sensor.heat_pump_thermal_power_kw') not in ['unknown', 'unavailable'] else '‚ùå No' }} | {{ states('sensor.heat_pump_thermal_power_kw') }}kW | cx_sensors.yaml:275 |
              | `sensor.heat_pump_output_power_interval_kwh` | {{ '‚úÖ Yes' if states('sensor.heat_pump_output_power_interval_kwh') not in ['unknown', 'unavailable'] else '‚ùå No' }} | {{ states('sensor.heat_pump_output_power_interval_kwh') }}kWh | legacy_sensors.yaml:227 |
              | `sensor.g2_valve_position` | {{ '‚úÖ Yes' if states('sensor.g2_valve_position') not in ['unknown', 'unavailable'] else '‚ùå No' }} | {{ states('sensor.g2_valve_position') }} | g2_valve_sensors.yaml |
              | `sensor.heat_pump_outlet_temperature` | {{ '‚úÖ Yes' if states('sensor.heat_pump_outlet_temperature') not in ['unknown', 'unavailable'] else '‚ùå No' }} | {{ states('sensor.heat_pump_outlet_temperature') }}¬∞F | **MISSING** |
              | `sensor.cx50_outlet_temp` | {{ '‚úÖ Yes' if states('sensor.cx50_outlet_temp') not in ['unknown', 'unavailable'] else '‚ùå No' }} | {{ states('sensor.cx50_outlet_temp') }}¬∞F | cx_sensors.yaml (Modbus) |

              ### Shelly Buffer Tank Sensors
              | Entity | Exists? | Current Value | File |
              |--------|---------|---------------|------|
              | `sensor.buffer_supply_from_heat_pump` | {{ '‚úÖ Yes' if states('sensor.buffer_supply_from_heat_pump') not in ['unknown', 'unavailable'] else '‚ùå No' }} | {{ states('sensor.buffer_supply_from_heat_pump') }}¬∞F | shelly_buffer_tank_sensors.yaml |
              | `sensor.buffer_return_to_heat_pump` | {{ '‚úÖ Yes' if states('sensor.buffer_return_to_heat_pump') not in ['unknown', 'unavailable'] else '‚ùå No' }} | {{ states('sensor.buffer_return_to_heat_pump') }}¬∞F | shelly_buffer_tank_sensors.yaml |

              ## Sensor File Load Status
              Check `configuration.yaml` for these includes:
              - ‚úÖ `sensor: !include_dir_merge_list sensors/template/`
              - ‚úÖ `sensor: !include sensors/legacy_sensors.yaml`
              - ‚úÖ `utility_meter: !include sensors/utility_meters/utility_meters.yaml`

              # (Replace the "Issues Found:" block in the Entity Registry Check card with the following)
              **Issues Found:**
              {% set issues = [] %}
              {% if states('binary_sensor.cx_c34_water_pump') in ['unknown', 'unavailable'] %}
                {% set issues = issues + ['Water pump binary sensor not working'] %}
              {% endif %}
              {% if states('binary_sensor.heat_pump_running') in ['unknown', 'unavailable'] %}
                {% set issues = issues + ['Heat pump running sensor not working (depends on water pump)'] %}
              {% endif %}
              {% if states('sensor.heat_pump_output_power_interval_kwh') in ['unknown', 'unavailable'] %}
                {% set issues = issues + ['Integration sensor not initialized'] %}
              {% endif %}
              {% if states('sensor.heat_pump_outlet_temperature') in ['unknown', 'unavailable'] and states('sensor.cx50_outlet_temp') in ['unknown', 'unavailable'] %}
                {% set issues = issues + ['CRITICAL: No outlet temperature sensor available'] %}
              {% endif %}

              {% if issues | length > 0 %}
              {% for issue in issues %}
              - ‚ùå {{ issue }}
              {% endfor %}
              {% else %}
              ‚úÖ All critical sensors are loaded and available
              {% endif %}
          # EVENT TIMELINE CARD
          - type: logbook
            title: üîî Heat Pump Event Timeline
            hours_to_show: 24
            grid_options:
              columns: full
            entities:
              # Core state changes
              - binary_sensor.heat_pump_running
              - sensor.heat_pump_operating_mode

              # Cycle tracking
              - sensor.heat_pump_last_cycle_duration
              - sensor.heat_pump_last_cycle_cop

              # Phase transitions
              - binary_sensor.heat_pump_in_startup_phase
              - binary_sensor.heat_pump_steady_state
              - binary_sensor.heat_pump_last_cycle_was_short

              # Performance alerts
              - sensor.heat_pump_cop
              - sensor.heat_pump_efficiency_rating

              # Integration sensors (to see when they initialize)
              - sensor.heat_pump_output_power_interval_kwh
              - sensor.heat_pump_input_power_interval_kwh

          - type: markdown
            title: üîå Raw Heat Pump Sensors (cx_sensors.yaml)
            grid_options:
              columns: full
            content: |
              ## Primary Inputs (Direct from Modbus)
              | Sensor | Value | Status |
              |--------|-------|--------|
              | Operating Mode | {{ states('sensor.heat_pump_operating_mode') }} | {{ '‚úÖ' if states('sensor.heat_pump_operating_mode') not in ['unknown', 'unavailable'] else '‚ùå' }} |
              | Inlet Temp | {{ states('sensor.heat_pump_inlet_temperature') }}¬∞F | {{ '‚úÖ' if states('sensor.heat_pump_inlet_temperature') not in ['unknown', 'unavailable'] else '‚ùå' }} |
              | Outlet Temp | {{ states('sensor.heat_pump_outlet_temperature') }}¬∞F | {{ '‚úÖ' if states('sensor.heat_pump_outlet_temperature') not in ['unknown', 'unavailable'] else '‚ùå' }} |
              | Delta T | {{ states('sensor.heat_pump_delta_t') }}¬∞F | {{ '‚úÖ' if states('sensor.heat_pump_delta_t') not in ['unknown', 'unavailable'] else '‚ùå' }} |
              | Flow Rate | {{ states('sensor.cx50_pump_flow_gpm') }} GPM | {{ '‚úÖ' if states('sensor.cx50_pump_flow_gpm') | float(0) > 0 else '‚ö†Ô∏è Zero/Low' }} |
              | Flow Rate | {{ states('sensor.cx50_pump_flow_lpm') }} LPM | {{ '‚úÖ' if states('sensor.cx50_pump_flow_lpm') | float(0) > 0 else '‚ö†Ô∏è Zero/Low' }} |
              | AC Voltage | {{ states('sensor.cx50_input_ac_voltage') }}V | {{ '‚úÖ' if states('sensor.cx50_input_ac_voltage') not in ['unknown', 'unavailable'] else '‚ùå' }} |
              | AC Current | {{ states('sensor.cx50_input_ac_current') }}A | {{ '‚úÖ' if states('sensor.cx50_input_ac_current') not in ['unknown', 'unavailable'] else '‚ùå' }} |

              ## Calculated Power (V √ó I)
              | Sensor | Value | Formula | Status |
              |--------|-------|---------|--------|
              | Electrical Input | {{ states('sensor.heat_pump_electrical_power_input') }}W | V √ó I | {{ '‚úÖ' if states('sensor.heat_pump_electrical_power_input') | float(0) > 0 or is_state('binary_sensor.heat_pump_running', 'off') else '‚ö†Ô∏è' }} |
              | Electrical Input | {{ states('sensor.heat_pump_electrical_power_input_kw') }}kW | / 1000 | {{ '‚úÖ' if states('sensor.heat_pump_electrical_power_input_kw') not in ['unknown', 'unavailable'] else '‚ùå' }} |

              ## Calculated Thermal (Q = ·πÅ √ó Cp √ó ŒîT)
              | Sensor | Value | Dependencies | Status |
              |--------|-------|--------------|--------|
              | Thermal Output | {{ states('sensor.heat_pump_thermal_power_output') }}W | Flow, ŒîT, Cp, œÅ | {{ '‚úÖ' if states('sensor.heat_pump_thermal_power_output') not in ['unknown', 'unavailable'] else '‚ùå' }} |
              | Thermal (kW) | {{ states('sensor.heat_pump_thermal_power_kw') }}kW | Mode-filtered | {{ '‚úÖ' if states('sensor.heat_pump_thermal_power_kw') not in ['unknown', 'unavailable'] else '‚ùå' }} |

              ## COP Calculation
              | Sensor | Value | Formula | Status |
              |--------|-------|---------|--------|
              | Current COP | {{ states('sensor.heat_pump_cop') }} | Thermal / Electrical | {{ '‚úÖ Good (1.5-5.5)' if 1.5 < states('sensor.heat_pump_cop') | float(0) < 6 else ('N/A (off)' if is_state('binary_sensor.heat_pump_running', 'off') else '‚ö†Ô∏è') }} |
              | Efficiency Rating | {{ states('sensor.heat_pump_efficiency_rating') }} | COP ‚Üí Text | {{ '‚úÖ' if states('sensor.heat_pump_efficiency_rating') != 'Unknown' else '‚ö†Ô∏è' }} |

              **Data Flow:** Modbus ‚Üí Raw Readings ‚Üí Power Calc (V√óI) ‚Üí Thermal Calc (Q=·πÅCpŒîT) ‚Üí COP

          # CARD 2: INTEGRATION SENSORS
          - type: markdown
            title: ‚ö° Integration Sensors (legacy_sensors.yaml)
            grid_options:
              columns: full
            content: |
              ## Integration Platform (Power ‚Üí Energy over time)
              | Sensor | Source | Value | Method | Status |
              |--------|--------|-------|--------|--------|
              | **Heat Pump Input Power Interval** | hwat_pump_input_power_interval_kwh (W) | {{ states('sensor.hwat_pump_input_power_interval_kwh') }} kWh | Riemann (left) | {{ '‚úÖ Accumulating' if states('sensor.hwat_pump_input_power_interval_kwh') not in ['unknown', 'unavailable'] and states('sensor.hwat_pump_input_power_interval_kwh') | float(-1) >= 0 else '‚ùå' }} |
              | **Heat Pump Output Power Interval** | heat_pump_output_power_interval_kwh (W) | {{ states('sensor.heat_pump_output_power_interval_kwh') }} kWh | Riemann (left) | {{ '‚úÖ Accumulating' if states('sensor.heat_pump_output_power_interval_kwh') not in ['unknown', 'unavailable'] and states('sensor.heat_pump_output_power_interval_kwh') | float(-1) >= 0 else '‚ùå Not initialized yet' }} |

              ## Expected Relationship (Energy-Based COP)
              {% set input = states('sensor.hwat_pump_input_power_interval_kwh') | float(0) %}
              {% set output = states('sensor.heat_pump_output_power_interval_kwh') | float(0) %}
              {% if input > 1 and output > 0 %}
              | Metric | Value | Status |
              |--------|-------|--------|
              | Input Energy | {{ input | round(3) }} kWh | - |
              | Output Energy | {{ output | round(3) }} kWh | - |
              | **COP (Energy-based)** | **{{ (output / input) | round(2) }}** | {{ '‚úÖ Reasonable (1.5-5.5)' if 1.5 < (output / input) < 6 else '‚ö†Ô∏è Check values' }} |
              {% else %}
              **Status:** ‚è≥ Waiting for both sensors to accumulate (need > 1 kWh input)
              {% endif %}

              **Data Flow:** Power (W) ‚Üí Integration ‚Üí Energy (kWh) ‚Üí Utility Meters

              **Note:** Integration sensors created on 2025-11-12 to fix missing sensor definitions

          # CARD 3: CYCLE TRACKING SENSORS
          - type: markdown
            title: üîÑ Cycle Tracking Sensors (heat_pump_cycle_sensors.yaml)
            grid_options:
              columns: full
            content: |
              ## Binary Sensor Source (Improved Logic - 2025-11-12)
              | Sensor | Value | Based On |
              |--------|-------|----------|
              | Heat Pump Running | {{ states('binary_sensor.heat_pump_running') }} | **Pump ON** AND (**Compressor Running** OR **Heat Transfer**) |

              **Detection Logic:**
              - **Water Pump**: {{ states('binary_sensor.cx_c34_water_pump') }} (Modbus C34: {{ states('sensor.cx50_c34') }}, Flow: {{ states('sensor.cx50_pump_flow_lpm') }}L/min)
              - **Compressor Freq**: {{ states('sensor.cx50_compressor_frequency') }}Hz
              - **Thermal Output**: {{ (states('sensor.heat_pump_thermal_power_output') | float(0) / 1000) | round(1) }}kW

              **Water Pump Detection:** C34=1 OR Flow>1.0 L/min (validates actual circulation)
              **HP Running:** Pump ON AND (Freq>0 OR Thermal>1kW)

              ## Trigger-Based Cycle Sensors (NEW 2025-11-12)
              | Sensor | Value | Unit | Status |
              |--------|-------|------|--------|
              | Current Cycle Duration | {{ states('sensor.heat_pump_current_cycle_duration') }} | seconds | {{ '‚úÖ Incrementing' if states('sensor.heat_pump_current_cycle_duration') | float(0) > 0 and is_state('binary_sensor.heat_pump_running', 'on') else ('‚úÖ Zero (off)' if is_state('binary_sensor.heat_pump_running', 'off') else '‚ö†Ô∏è') }} |
              | Current Cycle Duration | {{ states('sensor.heat_pump_current_cycle_duration_minutes') }} | minutes | {{ '‚úÖ Matches' if ((states('sensor.heat_pump_current_cycle_duration') | float(0) / 60) | round(2) - states('sensor.heat_pump_current_cycle_duration_minutes') | float(0)) | abs < 0.1 else '‚ö†Ô∏è Mismatch' }} |
              | Last Cycle Duration | {{ states('sensor.heat_pump_last_cycle_duration') }} | seconds | {{ '‚úÖ Has data' if states('sensor.heat_pump_last_cycle_duration') | float(0) > 0 else '‚ö†Ô∏è Waiting for cycle' }} |
              | Last Cycle COP | {{ states('sensor.heat_pump_last_cycle_cop') }} | - | {{ '‚úÖ Captured' if states('sensor.heat_pump_last_cycle_cop') not in ['unknown', 'unavailable'] else '‚ö†Ô∏è Waiting' }} |

              ## Standby Power Sensors (NEW 2025-11-12)
              | Sensor | Value | Unit | Status |
              |--------|-------|------|--------|
              | Current Standby Power | {{ states('sensor.heat_pump_standby_power') }} | W | {{ '‚úÖ Tracking' if is_state('binary_sensor.heat_pump_running', 'off') else '‚úÖ Preserved' }} |
              | Last Standby Power | {{ states('sensor.heat_pump_last_standby_power') }} | W | {{ '‚úÖ Captured' if states('sensor.heat_pump_last_standby_power') | float(0) > 0 else '‚ö†Ô∏è Waiting' }} |

              ## Cycle Phases (Calculated from Duration)
              | Sensor | Value | Formula | Expected When |
              |--------|-------|---------|---------------|
              | Startup Phase | {{ states('binary_sensor.heat_pump_in_startup_phase') }} | cycle < 180s | ON during first 3min |
              | Steady State | {{ states('binary_sensor.heat_pump_steady_state') }} | cycle > 180s | ON after 3min |
              | Last Cycle Short | {{ states('binary_sensor.heat_pump_last_cycle_was_short') }} | last < 300s | ON if < 5min cycle |

              **Data Flow:** binary_sensor.heat_pump_running ‚Üí Cycle Duration ‚Üí Binary States

          # CARD 4: UTILITY METERS
          - type: markdown
            title: üìä Utility Meters (utility_meters.yaml)
            grid_options:
              columns: full
            content: |
              ## Energy Input Meters (Source: heat_pump_input_power_interval_kwh)
              | Meter | Value | Sanity Check | Status |
              |-------|-------|--------------|--------|
              | Hourly | {{ states('sensor.hp_electrical_energy_hourly') }} kWh | {{ '‚úÖ <100kWh' if states('sensor.hp_electrical_energy_hourly') | float(0) < 100 else '‚ùå TOO HIGH - Corrupted' }} | {{ '‚úÖ' if states('sensor.hp_electrical_energy_hourly') not in ['unknown', 'unavailable'] else '‚ùå' }} |
              | Daily | {{ states('sensor.hp_electrical_energy_daily') }} kWh | {{ '‚úÖ <2000kWh' if states('sensor.hp_electrical_energy_daily') | float(0) < 2000 else '‚ùå TOO HIGH - Corrupted' }} | {{ '‚úÖ' if states('sensor.hp_electrical_energy_daily') not in ['unknown', 'unavailable'] else '‚ùå' }} |
              | Monthly | {{ states('sensor.hp_electrical_energy_monthly') }} kWh | {{ '‚úÖ <60000kWh' if states('sensor.hp_electrical_energy_monthly') | float(0) < 60000 else '‚ùå TOO HIGH - Corrupted' }} | {{ '‚úÖ' if states('sensor.hp_electrical_energy_monthly') not in ['unknown', 'unavailable'] else '‚ùå' }} |

              ## Energy Output Meters (Source: heat_pump_output_power_interval_kwh)
              | Meter | Value | Source Status | Meter Status |
              |-------|-------|---------------|--------------|
              | Hourly | {{ states('sensor.hp_thermal_energy_output_hourly') }} kWh | {{ '‚úÖ' if states('sensor.hp_thermal_energy_output_hourly') not in ['unknown', 'unavailable'] else '‚ùå Source unavailable' }} | {{ '‚úÖ' if states('sensor.hp_thermal_energy_output_hourly') not in ['unknown', 'unavailable'] else '‚ùå' }} |
              | Daily | {{ states('sensor.hp_thermal_energy_output_daily') }} kWh | {{ '‚úÖ' if states('sensor.hp_thermal_energy_output_daily') not in ['unknown', 'unavailable'] else '‚ùå Source unavailable' }} | {{ '‚úÖ' if states('sensor.hp_thermal_energy_output_daily') not in ['unknown', 'unavailable'] else '‚ùå' }} |
              | Monthly | {{ states('sensor.hp_thermal_energy_output_monthly') }} kWh | {{ '‚úÖ' if states('sensor.hp_thermal_energy_output_monthly') not in ['unknown', 'unavailable'] else '‚ùå Source unavailable' }} | {{ '‚úÖ' if states('sensor.hp_thermal_energy_output_monthly') not in ['unknown', 'unavailable'] else '‚ùå' }} |


              **Data Flow:** Integration Sensors ‚Üí Utility Meters ‚Üí Reset on Cycle

          # CARD 5: HVAC DISTRIBUTION
          - type: markdown
            title: üè† HVAC Distribution (hvac_sensors.yaml)
            grid_options:
              columns: full
            content: |
              ## Buffer Tank Sensors
              | Sensor | Value | Source | Status |
              |--------|-------|--------|--------|
              | Supply Temp | {{ states('sensor.hvac_buffer_tank_supply_temperature') }}¬∞F | Shelly | {{ '‚úÖ' if states('sensor.hvac_buffer_tank_supply_temperature') not in ['unknown', 'unavailable'] else '‚ùå' }} |
              | Return Temp | {{ states('sensor.hvac_buffer_tank_return_temperature') }}¬∞F | Shelly | {{ '‚úÖ' if states('sensor.hvac_buffer_tank_return_temperature') not in ['unknown', 'unavailable'] else '‚ùå' }} |
              | Delta T | {{ states('sensor.hvac_buffer_tank_delta_t') }}¬∞F | Calculated | {{ '‚úÖ' if states('sensor.hvac_buffer_tank_delta_t') not in ['unknown', 'unavailable'] else '‚ùå' }} |
              | Flow Rate | {{ states('sensor.hvac_buffer_tank_flow_rate') }} LPM | Hydronic | {{ '‚úÖ' if states('sensor.hvac_buffer_tank_flow_rate') | float(0) > 0 else '‚ö†Ô∏è Zero' }} |

              ## Thermal Power & Load
              | Sensor | Value | Formula | Status |
              |--------|-------|---------|--------|
              | HVAC Thermal Power | {{ states('sensor.hvac_thermal_power_used') }}W | Q = ·πÅ √ó Cp √ó ŒîT | {{ '‚úÖ' if states('sensor.hvac_thermal_power_used') not in ['unknown', 'unavailable'] else '‚ùå' }} |
              | House Heat Loss | {{ states('sensor.house_heat_loss_kw') }}kW | Same formula | {{ '‚úÖ' if states('sensor.house_heat_loss_kw') not in ['unknown', 'unavailable'] else '‚ùå' }} |

              ## Buffer Energy Storage (buffer_energy.yaml)
              | Sensor | Value | Status | Dependencies |
              |--------|-------|--------|--------------|
              | Buffer Energy (kWh) | {{ states('sensor.buffer_energy_kwh') }}kWh | {{ '‚úÖ' if states('sensor.buffer_energy_kwh') not in ['unknown', 'unavailable'] else '‚ùå' }} | Temp + Volume + Fluid Props |
              | Buffer Energy (%) | {{ states('sensor.buffer_energy_percent') }}% | {{ '‚úÖ' if states('sensor.buffer_energy_percent') not in ['unknown', 'unavailable'] else '‚ùå' }} | Above + Max Temp |

              ### Required Inputs (Debug)
              | Input | Value | Status | Notes |
              |-------|-------|--------|-------|
              | Buffer Tank Temp | {{ states('sensor.buffer_tank_temperature') }}¬∞F | {{ '‚úÖ' if states('sensor.buffer_tank_temperature') not in ['unknown', 'unavailable'] else '‚ùå' }} | Primary temp sensor |
              | Buffer Volume | {{ states('input_number.buffer_tank_volume_gal') }}gal | {{ '‚úÖ' if states('input_number.buffer_tank_volume_gal') not in ['unknown', 'unavailable'] else '‚ùå' }} | Number input helper |
              | Fluid Specific Heat | {{ states('input_number.cx_fluid_specific_heat') }} kJ/(kg¬∑¬∞C) | {{ '‚úÖ' if states('input_number.cx_fluid_specific_heat') not in ['unknown', 'unavailable'] else '‚ùå' }} | Required |
              | Fluid Density | {{ states('input_number.cx_fluid_density') }} kg/m¬≥ | {{ '‚úÖ' if states('input_number.cx_fluid_density') not in ['unknown', 'unavailable'] else '‚ùå' }} | Required |
              | Base Temperature | {{ states('input_number.buffer_base_temp_c') }}¬∞C | {{ '‚ö†Ô∏è Using default 40¬∞C' if states('input_number.buffer_base_temp_c') in ['unknown', 'unavailable'] or states('input_number.buffer_base_temp_c') | float(0) == 0 else '‚úÖ' }} | Reference temp |
              | Max Temperature | {{ states('input_number.buffer_max_temp_c') }}¬∞C | {{ '‚ö†Ô∏è Using base+20¬∞C' if states('input_number.buffer_max_temp_c') in ['unknown', 'unavailable'] or states('input_number.buffer_max_temp_c') | float(0) == 0 else '‚úÖ' }} | For % calc only |

              ## Distribution Efficiency
              | Metric | Value | Status |
              |--------|-------|--------|
              | HP Output | {{ (states('sensor.heat_pump_thermal_power_output') | float(0) / 1000) | round(2) }}kW | - |
              | HVAC Load | {{ (states('sensor.hvac_thermal_power_used') | float(0) / 1000) | round(2) }}kW | - |
              | Efficiency | {{ states('sensor.system_distribution_efficiency') }}% | {{ '‚úÖ >80%' if states('sensor.system_distribution_efficiency') | float(0) > 80 else ('‚ö†Ô∏è Expected in Heat+DHW' if states('sensor.heat_pump_operating_mode') in ['Heat + DHW', 'HEAT + DHW'] else '‚ùå') }} |

              **Data Flow:** Buffer Tank Sensors ‚Üí HVAC Load ‚Üí Distribution Efficiency

          # CARD 5.5: G2 VALVE POSITION DETECTION (NEW)
          - type: markdown
            title: üîÄ G2 Valve Position Detection (g2_valve_sensors.yaml)
            grid_options:
              columns: full
            content: |
              ## G2 Diverter Valve (Heat Routing - Delta-T Correlation)
              **Purpose:** Detects whether G2 valve is directing heat pump output to buffer tank (heating) or DHW tank

              | Sensor | Value | Detection Method |
              |--------|-------|------------------|
              | G2 Valve Position | {{ states('sensor.g2_valve_position') }} | Delta-T correlation |
              | G2 DHW Mode Active | {{ states('binary_sensor.g2_valve_dhw_mode') }} | Binary state |

              ## Temperature Correlation (When HP Running)
              {% set hp_outlet = state_attr('sensor.g2_valve_position', 'hp_outlet_temp') | float(0) %}
              {% set buffer_diff = state_attr('sensor.g2_valve_position', 'buffer_temp_diff') | float(0) %}
              {% set dhw_diff = state_attr('sensor.g2_valve_position', 'dhw_temp_diff') | float(0) %}

              | Temperature | Value | Temp Diff from HP Outlet |
              |-------------|-------|--------------------------|
              | HP Outlet | {{ hp_outlet }}¬∞F | - (heat source) |
              | Buffer Supply | {{ states('sensor.supply_from_heat_pump') }}¬∞F | {{ buffer_diff }}¬∞F {{ '‚úÖ' if buffer_diff < dhw_diff and buffer_diff < 10 else '' }} |
              | DHW Supply | {{ states('sensor.dhw_supply_from_heat_pump') }}¬∞F | {{ dhw_diff }}¬∞F {{ '‚úÖ' if dhw_diff < buffer_diff and dhw_diff < 10 else '' }} |

              **Detection Rule:** Whichever supply line (buffer or DHW) is closest to HP outlet temp is receiving flow

              **Current Decision:** {{ 'üî• Buffer Tank' if buffer_diff < dhw_diff and buffer_diff < 10 else 'üöø DHW Tank' if dhw_diff < buffer_diff and dhw_diff < 10 else '‚ùì Unknown' }}

              **Why This Method:**
              - Works during idle periods, defrost cycles, differential cooling
              - No time windows or trend detection needed
              - Updates instantly when temps change
              - Simple, robust logic

              **Data Flow:** HP Outlet Temp ‚Üí Compare with Buffer/DHW Supply Temps ‚Üí Closest Match = Active Path

          # CARD 5.6: ENERGY BALANCE TRACKING (NEW - 2025-11-17)
          - type: markdown
            title: ‚öñÔ∏è Energy Balance Tracking (thermal_power_sensors.yaml + legacy_sensors.yaml)
            grid_options:
              columns: full
            content: |
              ## Overview
              Tracks energy at each stage: **HP Output ‚Üí G2 Valve ‚Üí Buffer/DHW Tanks ‚Üí HVAC Load**

              This enables calculation of:
              - Piping losses between HP and tanks
              - Distribution efficiency
              - System calibration
              - Separate DHW vs heating tracking

              ---

              ## Current System State
              | Parameter | Value | Status |
              |-----------|-------|--------|
              | Heat Pump Running | {{ states('binary_sensor.heat_pump_running') }} | {{ 'üî• Active' if is_state('binary_sensor.heat_pump_running', 'on') else '‚è∏Ô∏è Idle' }} |
              | G2 Valve Position | {{ states('sensor.g2_valve_position') }} | {{ 'üè† Heating' if states('sensor.g2_valve_position') == 'Buffer Tank' else ('üöø DHW' if states('sensor.g2_valve_position') == 'DHW Tank' else '‚è∏Ô∏è Idle') }} |
              | Operating Mode | {{ states('sensor.heat_pump_operating_mode') }} | {{ '‚úÖ' if states('sensor.heat_pump_operating_mode') not in ['unknown', 'unavailable'] else '‚ùå' }} |

              ---

              ## Thermal Power Sensors (Instantaneous - Watts)
              | Sensor | Value | G2 Position | Status |
              |--------|-------|-------------|--------|
              | **HP Thermal Output** | {{ states('sensor.heat_pump_thermal_power_output') }}W ({{ (states('sensor.heat_pump_thermal_power_output') \| float(0) / 1000) \| round(2) }}kW) | - | {{ '‚úÖ Producing' if states('sensor.heat_pump_thermal_power_output') \| float(0) > 1000 else '‚è∏Ô∏è Standby' }} |
              | **Buffer Tank Input** | {{ states('sensor.buffer_tank_thermal_power_input') }}W ({{ (states('sensor.buffer_tank_thermal_power_input') \| float(0) / 1000) \| round(2) }}kW) | {{ states('sensor.g2_valve_position') }} | {{ '‚úÖ Receiving' if states('sensor.buffer_tank_thermal_power_input') \| float(0) > 100 else ('‚è∏Ô∏è Idle' if states('sensor.g2_valve_position') != 'Buffer Tank' else '‚ö†Ô∏è Should be receiving') }} |
              | **DHW Tank Input** | {{ states('sensor.dhw_tank_thermal_power_input') }}W ({{ (states('sensor.dhw_tank_thermal_power_input') \| float(0) / 1000) \| round(2) }}kW) | {{ states('sensor.g2_valve_position') }} | {{ '‚úÖ Receiving' if states('sensor.dhw_tank_thermal_power_input') \| float(0) > 100 else ('‚è∏Ô∏è Idle' if states('sensor.g2_valve_position') != 'DHW Tank' else '‚ö†Ô∏è Should be receiving') }} |
              | **HVAC Load Output** | {{ states('sensor.hvac_thermal_power_used') }}W ({{ (states('sensor.hvac_thermal_power_used') \| float(0) / 1000) \| round(2) }}kW) | - | {{ '‚úÖ Delivering' if states('sensor.hvac_thermal_power_used') \| float(0) > 100 else '‚è∏Ô∏è No demand' }} |

              **Expected Behavior:**
              - When G2 ‚Üí Buffer: Buffer Input > 0, DHW Input = 0
              - When G2 ‚Üí DHW: DHW Input > 0, Buffer Input = 0
              - HP Output ‚âà Buffer Input OR DHW Input (whichever is active)

              ---

              ## Integration Sensors (Accumulated Energy - kWh)
              | Sensor | Value | Source Power | Status |
              |--------|-------|--------------|--------|
              | **HP Electrical Input** | {{ states('sensor.cx_input_power_kwh') }} kWh | {{ states('sensor.heat_pump_electrical_power_input') }}W | {{ '‚úÖ' if states('sensor.cx_input_power_kwh') not in ['unknown', 'unavailable'] else '‚ùå' }} |
              | **HP Thermal Output** | {{ states('sensor.cx_output_power_interval') }} kWh | {{ states('sensor.heat_pump_thermal_power_output') }}W | {{ '‚úÖ' if states('sensor.cx_output_power_interval') not in ['unknown', 'unavailable'] else '‚ùå' }} |
              | **Buffer Tank Input** | {{ states('sensor.buffer_tank_energy_input') }} kWh | {{ states('sensor.buffer_tank_thermal_power_input') }}W | {{ '‚úÖ' if states('sensor.buffer_tank_energy_input') not in ['unknown', 'unavailable'] else '‚ùå' }} |
              | **DHW Tank Input** | {{ states('sensor.dhw_tank_energy_input') }} kWh | {{ states('sensor.dhw_tank_thermal_power_input') }}W | {{ '‚úÖ' if states('sensor.dhw_tank_energy_input') not in ['unknown', 'unavailable'] else '‚ùå' }} |
              | **HVAC Load Used** | {{ states('sensor.hvac_thermal_energy_used') }} kWh | {{ states('sensor.hvac_thermal_power_used') }}W | {{ '‚úÖ' if states('sensor.hvac_thermal_energy_used') not in ['unknown', 'unavailable'] else '‚ùå' }} |

              ---

              ## Utility Meters - Hourly Tracking
              | Meter | Value | Source Health | Meter Status |
              |-------|-------|---------------|--------------|
              | HP Electrical (Hourly) | {{ states('sensor.hp_electrical_energy_hourly') }} kWh | {{ '‚úÖ' if states('sensor.cx_input_power_kwh') not in ['unknown', 'unavailable'] else '‚ùå' }} | {{ '‚úÖ' if states('sensor.hp_electrical_energy_hourly') not in ['unknown', 'unavailable'] else '‚ùå' }} |
              | HP Thermal (Hourly) | {{ states('sensor.hp_thermal_energy_output_hourly') }} kWh | {{ '‚úÖ' if states('sensor.cx_output_power_interval') not in ['unknown', 'unavailable'] else '‚ùå' }} | {{ '‚úÖ' if states('sensor.hp_thermal_energy_output_hourly') not in ['unknown', 'unavailable'] else '‚ùå' }} |
              | Buffer Input (Hourly) | {{ states('sensor.buffer_tank_energy_input_hourly') }} kWh | {{ '‚úÖ' if states('sensor.buffer_tank_energy_input') not in ['unknown', 'unavailable'] else '‚ùå' }} | {{ '‚úÖ' if states('sensor.buffer_tank_energy_input_hourly') not in ['unknown', 'unavailable'] else '‚ùå' }} |
              | DHW Input (Hourly) | {{ states('sensor.dhw_tank_energy_input_hourly') }} kWh | {{ '‚úÖ' if states('sensor.dhw_tank_energy_input') not in ['unknown', 'unavailable'] else '‚ùå' }} | {{ '‚úÖ' if states('sensor.dhw_tank_energy_input_hourly') not in ['unknown', 'unavailable'] else '‚ùå' }} |

              ## Utility Meters - Daily Tracking
              | Meter | Value | Source Health | Meter Status |
              |-------|-------|---------------|--------------|
              | HP Electrical (Daily) | {{ states('sensor.hp_electrical_energy_daily') }} kWh | {{ '‚úÖ' if states('sensor.cx_input_power_kwh') not in ['unknown', 'unavailable'] else '‚ùå' }} | {{ '‚úÖ' if states('sensor.hp_electrical_energy_daily') not in ['unknown', 'unavailable'] else '‚ùå' }} |
              | HP Thermal (Daily) | {{ states('sensor.hp_thermal_energy_output_daily') }} kWh | {{ '‚úÖ' if states('sensor.cx_output_power_interval') not in ['unknown', 'unavailable'] else '‚ùå' }} | {{ '‚úÖ' if states('sensor.hp_thermal_energy_output_daily') not in ['unknown', 'unavailable'] else '‚ùå' }} |
              | Buffer Input (Daily) | {{ states('sensor.buffer_tank_energy_input_daily') }} kWh | {{ '‚úÖ' if states('sensor.buffer_tank_energy_input') not in ['unknown', 'unavailable'] else '‚ùå' }} | {{ '‚úÖ' if states('sensor.buffer_tank_energy_input_daily') not in ['unknown', 'unavailable'] else '‚ùå' }} |
              | DHW Input (Daily) | {{ states('sensor.dhw_tank_energy_input_daily') }} kWh | {{ '‚úÖ' if states('sensor.dhw_tank_energy_input') not in ['unknown', 'unavailable'] else '‚ùå' }} | {{ '‚úÖ' if states('sensor.dhw_tank_energy_input_daily') not in ['unknown', 'unavailable'] else '‚ùå' }} |

              ---

              ## Energy Balance Analysis (Daily Values)
              {% set hp_out = states('sensor.hp_thermal_energy_output_daily') | float(0) %}
              {% set buf_in = states('sensor.buffer_tank_energy_input_daily') | float(0) %}
              {% set dhw_in = states('sensor.dhw_tank_energy_input_daily') | float(0) %}
              {% set hvac_out = states('sensor.hvac_thermal_energy_used') | float(0) %}
              {% set hp_elec = states('sensor.hp_electrical_energy_daily') | float(0) %}
              {% set total_tank_in = buf_in + dhw_in %}
              {% set piping_loss = hp_out - total_tank_in %}
              {% set piping_loss_pct = (piping_loss / hp_out * 100) if hp_out > 0 else 0 %}
              {% set dist_eff = (hvac_out / buf_in * 100) if buf_in > 0.1 else 0 %}
              {% set system_cop = (hp_out / hp_elec) if hp_elec > 0.1 else 0 %}

              | Metric | Calculation | Value | Status |
              |--------|-------------|-------|--------|
              | **HP Thermal Output** | Integration sensor | {{ hp_out \| round(2) }} kWh | {{ '‚úÖ' if hp_out > 0 else '‚è∏Ô∏è Not running yet' }} |
              | **Total Tank Input** | Buffer + DHW | {{ total_tank_in \| round(2) }} kWh | {{ '‚úÖ' if total_tank_in > 0 else '‚è∏Ô∏è Not running yet' }} |
              | **Piping Loss** | HP Out - Tank In | {{ piping_loss \| round(2) }} kWh ({{ piping_loss_pct \| round(1) }}%) | {{ '‚úÖ <10%' if piping_loss_pct < 10 and hp_out > 0 else ('‚ö†Ô∏è High losses' if piping_loss_pct >= 10 else '‚è∏Ô∏è Waiting for data') }} |
              | **Buffer Input** | Integration sensor | {{ buf_in \| round(2) }} kWh | {{ '‚úÖ' if buf_in > 0 else '‚è∏Ô∏è' }} |
              | **DHW Input** | Integration sensor | {{ dhw_in \| round(2) }} kWh | {{ '‚úÖ' if dhw_in > 0 else '‚è∏Ô∏è' }} |
              | **HVAC Load** | Integration sensor | {{ hvac_out \| round(2) }} kWh | {{ '‚úÖ' if hvac_out > 0 else '‚è∏Ô∏è' }} |
              | **Distribution Efficiency** | HVAC / Buffer √ó 100 | {{ dist_eff \| round(1) }}% | {{ '‚úÖ Good' if 70 < dist_eff < 150 and buf_in > 0.1 else ('‚ö†Ô∏è Check sensors' if buf_in > 0.1 else '‚è∏Ô∏è Waiting for data') }} |
              | **Daily COP** | HP Out / HP Elec | {{ system_cop \| round(2) }} | {{ '‚úÖ Good' if 2 < system_cop < 6 and hp_elec > 0.1 else ('‚ö†Ô∏è Check range' if hp_elec > 0.1 else '‚è∏Ô∏è Waiting for data') }} |

              **Notes:**
              - Piping losses should be <10% (well-insulated system)
              - Distribution efficiency >100% means buffer is releasing stored heat
              - Distribution efficiency <100% means buffer is storing heat
              - Over full heating cycles, distribution efficiency should average 80-100%

              **Data Flow:** HP Output ‚Üí Buffer/DHW Input (via G2) ‚Üí HVAC Load ‚Üí Energy Balance

          # CARD 6: OPTIMIZATION SENSORS
          - type: markdown
            title: üéØ Optimization Sensors (cx_optimization_sensors.yaml)
            grid_options:
              columns: full
            content: |
              ## Performance Metrics
              | Sensor | Value | Status |
              |--------|-------|--------|
              | Current COP | {{ states('sensor.heat_pump_cop') }} | {{ '‚úÖ Good' if 1.5 < states('sensor.heat_pump_cop') | float(0) < 6 else 'N/A' }} |
              | Last Cycle COP | {{ states('sensor.heat_pump_last_cycle_cop') }} | {{ '‚úÖ' if states('sensor.heat_pump_last_cycle_cop') not in ['unknown', 'unavailable'] else '‚ö†Ô∏è' }} |
              | Avg Steady State COP | {{ states('sensor.heat_pump_average_steady_state_cop') }} | {{ '‚úÖ' if states('sensor.heat_pump_average_steady_state_cop') not in ['unknown', 'unavailable'] else '‚ö†Ô∏è Needs cycles' }} |

              ## Binary Status Sensors
              | Sensor | State | Based On |
              |--------|-------|----------|
              | HP Running | {{ states('binary_sensor.heat_pump_running') }} | Power > 500W |
              | In Startup Phase | {{ states('binary_sensor.heat_pump_in_startup_phase') }} | Cycle < 180s |
              | Steady State | {{ states('binary_sensor.heat_pump_steady_state') }} | Cycle > 180s |
              | Last Cycle Short | {{ states('binary_sensor.heat_pump_last_cycle_was_short') }} | Last < 300s |

              **Data Flow:** Operating Mode ‚Üí Filter Power Sensors ‚Üí COP Tracking
          # OVERVIEW CARD
          - type: markdown
            title: üìã Sensor Verification Overview
            grid_options:
              columns: full
            content: |
              ## Purpose
              This dashboard traces data flow through all sensor calculation layers to identify issues.

              ## Recent Changes (2025-11-17)
              - ‚úÖ Renamed integration sensors to reset accumulated values (from ~21,000 kWh)
              - ‚úÖ Created `sensor.heat_pump_input_power_interval_kwh` (electrical energy accumulation)
              - ‚úÖ Created `sensor.heat_pump_output_power_interval_kwh` (thermal energy accumulation)
              - ‚úÖ Fixed utility meters to reference correct integration sensors with `delta_values: true`
              - ‚úÖ Removed duplicate `cx_*` utility meters (kept `hp_*` versions)
              - ‚úÖ Created `binary_sensor.heat_pump_flow_status` (reliable flow-based detection)
              - ‚úÖ Eliminated all C34 modbus dependencies (unreliable register)
              - ‚úÖ Energy-based COP now showing realistic values (~3.08)

              ## Previous Changes (2025-11-15)
              - ‚úÖ **NEW: Buffer energy storage sensors** (`sensor.buffer_energy_kwh` and `sensor.buffer_energy_percent`)
              - ‚úÖ Fixed `buffer_energy.yaml` sensor references (now uses `sensor.buffer_tank_temperature`)
              - ‚úÖ Fixed `buffer_energy.yaml` and `cx_trigger_sensors.yaml` template syntax errors
              - ‚úÖ Created cycle tracking sensors (current/last duration, cycle remaining)
              - ‚úÖ Created `sensor.heat_pump_last_cycle_cop` (COP at cycle completion)
              - ‚úÖ Fixed `radiant_sensors.yaml` template syntax errors
              - ‚úÖ Improved heat pump running detection (pump + compressor + heat transfer)
              - ‚úÖ Added standby power tracking sensors
              - ‚úÖ **G2 valve position detection** (temperature-based, shows actual heat routing)

              ## Known Issues
              - ‚ö†Ô∏è Modbus operating mode may not match actual G2 valve position (now detected by temperature analysis)
              - ‚ö†Ô∏è Cycle duration sensor may not be tracking correctly (shows 0.016 seconds)

              ## Data Flow
              ```
              Modbus ‚Üí Raw Sensors (cx_sensors.yaml)
                ‚Üì
              Calculated Power (electrical & thermal)
                ‚Üì
              Integration Sensors (legacy_sensors.yaml) ‚Üí Energy (kWh)
                ‚Üì
              Utility Meters (utility_meters.yaml) ‚Üí Hourly/Daily/Monthly
                ‚Üì
              Optimization Sensors (cx_optimization_sensors.yaml) ‚Üí Mode filtering
              ```

              **Last Updated:** {{ now().strftime('%Y-%m-%d %H:%M:%S') }}

