title: Sensor Verification
views:
  - type: sections
    max_columns: 1
    title: Sensor Verification
    path: sensor-verification
    icon: mdi:check-decagram
    sections:
      - type: grid
        column_span: 1
        cards:
          # OVERVIEW CARD
          - type: markdown
            title: ğŸ“‹ Sensor Verification Overview
            grid_options:
              columns: full
            content: |
              ## Purpose
              This dashboard traces data flow through all sensor calculation layers to identify issues.

              ## Recent Changes (2025-11-12)
              - âœ… Created `sensor.cx_output_power_interval` (integration sensor for thermal energy)
              - âœ… Created cycle tracking sensors (current/last duration, cycle remaining)
              - âœ… Created `sensor.heat_pump_last_cycle_cop` (COP at cycle completion)
              - âœ… Fixed `radiant_sensors.yaml` template syntax errors
              - âœ… Improved heat pump running detection (pump + compressor + heat transfer)
              - âœ… Fixed water pump binary sensor (proper boolean values)
              - âœ… Added standby power tracking sensors
              - âœ… **NEW: G2 valve position detection** (temperature-based, shows actual heat routing)

              ## Known Issues
              - âš ï¸ Input energy utility meters have corrupted historical state (need reset)
              - âš ï¸ Modbus operating mode may not match actual G2 valve position (now detected by temperature analysis)

              ## Data Flow
              ```
              Modbus â†’ Raw Sensors (cx_sensors.yaml)
                â†“
              Calculated Power (electrical & thermal)
                â†“
              Integration Sensors (legacy_sensors.yaml) â†’ Energy (kWh)
                â†“
              Utility Meters (utility_meters.yaml) â†’ Hourly/Daily/Monthly
                â†“
              Optimization Sensors (cx_optimization_sensors.yaml) â†’ Mode filtering
              ```

              **Last Updated:** {{ now().strftime('%Y-%m-%d %H:%M:%S') }}

          # CRITICAL SENSOR AVAILABILITY CHECK
          - type: markdown
            title: ğŸ” Critical Sensor Availability (Debug)
            grid_options:
              columns: full
            content: |
              ## Source Sensors (Direct Dependencies)
              | Sensor | State | Attributes | Status |
              |--------|-------|------------|--------|
              | `sensor.cx50_c34` | {{ states('sensor.cx50_c34') }} | unit: {{ state_attr('sensor.cx50_c34', 'unit_of_measurement') }} | {{ 'âœ…' if states('sensor.cx50_c34') not in ['unknown', 'unavailable'] else 'âŒ' }} |
              | `sensor.cx50_pump_flow_lpm` | {{ states('sensor.cx50_pump_flow_lpm') }} | unit: {{ state_attr('sensor.cx50_pump_flow_lpm', 'unit_of_measurement') }} | {{ 'âœ…' if states('sensor.cx50_pump_flow_lpm') not in ['unknown', 'unavailable'] else 'âŒ' }} |
              | `sensor.cx50_compressor_frequency` | {{ states('sensor.cx50_compressor_frequency') }} | unit: {{ state_attr('sensor.cx50_compressor_frequency', 'unit_of_measurement') }} | {{ 'âœ…' if states('sensor.cx50_compressor_frequency') not in ['unknown', 'unavailable'] else 'âŒ' }} |
              | `sensor.heat_pump_thermal_power_output` | {{ states('sensor.heat_pump_thermal_power_output') }} | unit: {{ state_attr('sensor.heat_pump_thermal_power_output', 'unit_of_measurement') }} | {{ 'âœ…' if states('sensor.heat_pump_thermal_power_output') not in ['unknown', 'unavailable'] else 'âŒ' }} |
              | `sensor.cx50_outlet_temp` | {{ states('sensor.cx50_outlet_temp') }} | unit: {{ state_attr('sensor.cx50_outlet_temp', 'unit_of_measurement') }} | {{ 'âœ…' if states('sensor.cx50_outlet_temp') not in ['unknown', 'unavailable'] else 'âŒ MISSING' }} |

              ## Calculated Binary Sensors
              | Sensor | State | Type | Expected |
              |--------|-------|------|----------|
              | `binary_sensor.cx_c34_water_pump` | {{ states('binary_sensor.cx_c34_water_pump') }} | binary_sensor | {{ 'ON (C34=1, Flow=19)' if states('sensor.cx50_c34') == '1' and states('sensor.cx50_pump_flow_lpm') | float(0) > 1 else 'Check logic' }} |
              | `binary_sensor.heat_pump_running` | {{ states('binary_sensor.heat_pump_running') }} | binary_sensor | {{ 'ON (Pump+Compressor+Thermal)' if states('sensor.cx50_compressor_frequency') | float(0) > 0 else 'Check dependencies' }} |

              ## Logic Evaluation (Real-time)
              {% set c34_value = states('sensor.cx50_c34') | int(0) %}
              {% set flow_rate = states('sensor.cx50_pump_flow_lpm') | float(0) %}
              {% set pump_should_be_on = c34_value == 1 or flow_rate > 1.0 %}

              | Variable | Value | Logic |
              |----------|-------|-------|
              | `c34_value` | {{ c34_value }} | Modbus status |
              | `flow_rate` | {{ flow_rate }} | Actual flow |
              | `c34_value == 1` | {{ c34_value == 1 }} | Boolean check |
              | `flow_rate > 1.0` | {{ flow_rate > 1.0 }} | Flow threshold |
              | **Water Pump Should Be** | **{{ 'ON' if pump_should_be_on else 'OFF' }}** | `c34==1 OR flow>1.0` |
              | **Actual Water Pump State** | **{{ states('binary_sensor.cx_c34_water_pump') }}** | âŒ MISMATCH if different |

          # BINARY SENSOR LOGIC DEBUG
          - type: markdown
            title: ğŸ› Binary Sensor Logic Debug
            grid_options:
              columns: full
            content: |
              ## Water Pump Binary Sensor Logic
              **File:** `sensors/template/cx_sensors.yaml:338`

              ```yaml
              state: >
                {% raw %}{% set c34_value = states('sensor.cx50_c34') | int(0) %}
                {% set flow_rate = states('sensor.cx50_pump_flow_lpm') | float(0) %}
                {{ c34_value == 1 or flow_rate > 1.0 }}{% endraw %}
              ```

              **Current Evaluation:**
              {% set c34 = states('sensor.cx50_c34') | int(0) %}
              {% set flow = states('sensor.cx50_pump_flow_lpm') | float(0) %}
              - C34 Raw State: `{{ states('sensor.cx50_c34') }}`
              - C34 Parsed: `{{ c34 }}` (type: int)
              - Flow Raw State: `{{ states('sensor.cx50_pump_flow_lpm') }}`
              - Flow Parsed: `{{ flow }}` (type: float)
              - **Expression Result: `{{ c34 == 1 or flow > 1.0 }}`**
              - **Actual Sensor State: `{{ states('binary_sensor.cx_c34_water_pump') }}`**

              **Availability Template:**
              ```yaml
              {% raw %}{{ states('sensor.cx50_c34') not in ['unknown', 'unavailable']
                  and states('sensor.cx50_pump_flow_lpm') not in ['unknown', 'unavailable'] }}{% endraw %}
              ```
              - C34 available: {{ states('sensor.cx50_c34') not in ['unknown', 'unavailable'] }}
              - Flow available: {{ states('sensor.cx50_pump_flow_lpm') not in ['unknown', 'unavailable'] }}
              - **Availability Result: {{ states('sensor.cx50_c34') not in ['unknown', 'unavailable'] and states('sensor.cx50_pump_flow_lpm') not in ['unknown', 'unavailable'] }}**

              ---

              ## Heat Pump Running Binary Sensor Logic
              **File:** `sensors/template/cx_optimization_sensors.yaml:11`

              {% set pump_state = states('binary_sensor.cx_c34_water_pump') %}
              {% set pump_on = is_state('binary_sensor.cx_c34_water_pump', 'on') %}
              {% set compressor_freq = states('sensor.cx50_compressor_frequency') | float(0) %}
              {% set thermal_output = states('sensor.heat_pump_thermal_power_output') | float(0) %}

              | Dependency | Raw State | Parsed Value | Check Result |
              |------------|-----------|--------------|--------------|
              | Water Pump State | `{{ pump_state }}` | - | `is_state('...', 'on')` = {{ pump_on }} |
              | Compressor Freq | `{{ states('sensor.cx50_compressor_frequency') }}` | {{ compressor_freq }} Hz | `> 0` = {{ compressor_freq > 0 }} |
              | Thermal Output | `{{ states('sensor.heat_pump_thermal_power_output') }}` | {{ thermal_output }} W | `> 1000` = {{ thermal_output > 1000 }} |

              **Logic Flow:**
              1. IF pump_on = {{ pump_on }}
              2. THEN check: (compressor > 0 OR thermal > 1000)
              3. Compressor check: {{ compressor_freq > 0 }}
              4. Thermal check: {{ thermal_output > 1000 }}
              5. **Expected Result: {{ pump_on and (compressor_freq > 0 or thermal_output > 1000) }}**
              6. **Actual State: `{{ states('binary_sensor.heat_pump_running') }}`**

              **Issue:** {% if pump_state in ['unknown', 'unavailable'] %}âŒ Water pump sensor is {{ pump_state }} - this blocks heat_pump_running{% elif not pump_on %}âš ï¸ Water pump is OFF or not 'on' state{% else %}âœ… Should be working{% endif %}

          # MODE FILTERING DEBUG
          - type: markdown
            title: ğŸ”€ Mode Filtering Debug (Why Thermal kW = 0?)
            grid_options:
              columns: full
            content: |
              ## Raw vs Mode-Filtered Thermal Power
              | Sensor | Value | File | Status |
              |--------|-------|------|--------|
              | `sensor.heat_pump_thermal_power_output` | {{ states('sensor.heat_pump_thermal_power_output') }}W | cx_sensors.yaml | âœ… Raw calculation |
              | `sensor.heat_pump_thermal_power_kw` | {{ states('sensor.heat_pump_thermal_power_kw') }}kW | cx_sensors.yaml:275 | {{ 'âœ…' if states('sensor.heat_pump_operating_mode') == 'Heat' else 'âš ï¸ Filtered to 0 (mode != Heat)' }} |

              **Current Operating Mode:** `{{ states('sensor.heat_pump_operating_mode') }}`

              ## Mode Filtering Logic (cx_sensors.yaml:295-318)
              ```yaml
              {% raw %}{% if mode == 'Heat' %}
                {# Calculate thermal power #}
                {{ result_kw | round(2) }}
              {% else %}
                {# If mode is anything else (Off, DHW, Cool, etc.), HVAC power is 0 #}
                {{ 0.0 }}
              {% endif %}{% endraw %}
              ```

              **Analysis:**
              - Current mode: `{{ states('sensor.heat_pump_operating_mode') }}`
              - Mode check: `mode == 'Heat'` â†’ {{ states('sensor.heat_pump_operating_mode') == 'Heat' }}
              - **Result:** {% if states('sensor.heat_pump_operating_mode') == 'Heat' %}âœ… Calculating thermal power{% else %}âŒ Mode is "{{ states('sensor.heat_pump_operating_mode') }}", not "Heat" - returns 0.0kW{% endif %}

              **Issue:** This sensor intentionally returns 0 for "Heat + DHW", "DHW", "Cool", etc. modes. It only calculates for pure "Heat" mode. This is likely incorrect - should calculate for both "Heat" and "Heat + DHW".

              **Impact:**
              - Integration sensor `cx_output_power_interval` may be using this filtered sensor (hence "unknown")
              - Energy meters downstream also affected
              - **Fix needed:** Either use raw `thermal_power_output` or add "Heat + DHW" to the mode check

          # INTEGRATION SENSOR DEEP DIVE
          - type: markdown
            title: âš¡ Integration Sensor Debug (Why CX Output = unknown?)
            grid_options:
              columns: full
            content: |
              ## Integration Sensor Status
              | Sensor | State | Source | Source State | Source Value |
              |--------|-------|--------|--------------|--------------|
              | `sensor.cx_input_power_kwh` | {{ states('sensor.cx_input_power_kwh') }} kWh | `sensor.heat_pump_electrical_power_input` | {{ states('sensor.heat_pump_electrical_power_input') }} | {{ states('sensor.heat_pump_electrical_power_input') }}W |
              | `sensor.cx_output_power_interval` | {{ states('sensor.cx_output_power_interval') }} kWh | `sensor.heat_pump_thermal_power_output` | {{ states('sensor.heat_pump_thermal_power_output') }} | {{ states('sensor.heat_pump_thermal_power_output') }}W |

              ## Integration Sensor Attributes
              **CX Output Power Interval:**
              - State: `{{ states('sensor.cx_output_power_interval') }}`
              - Last Reset: {{ state_attr('sensor.cx_output_power_interval', 'last_reset') }}
              - Source: {{ state_attr('sensor.cx_output_power_interval', 'source') }}
              - Unit: {{ state_attr('sensor.cx_output_power_interval', 'unit_of_measurement') }}
              - Device Class: {{ state_attr('sensor.cx_output_power_interval', 'device_class') }}
              - State Class: {{ state_attr('sensor.cx_output_power_interval', 'state_class') }}

              **Issue Analysis:**
              {% if states('sensor.cx_output_power_interval') in ['unknown', 'unavailable'] %}
              âŒ **Integration sensor not initialized**
              - Check: Is `sensor.heat_pump_thermal_power_output` available? {{ 'âœ… Yes' if states('sensor.heat_pump_thermal_power_output') not in ['unknown', 'unavailable'] else 'âŒ No' }}
              - Check: Has enough time passed for integration? (needs source sensor history)
              - Check: Integration platform configuration in `legacy_sensors.yaml`
              {% else %}
              âœ… Integration sensor working
              {% endif %}

          # SHELLY INTEGRATION DIAGNOSTIC
          - type: markdown
            title: ğŸ” Shelly Integration Temperature Sensors (Diagnostic)
            grid_options:
              columns: full
            content: |
              ## All Shelly Temperature Sensors Detected

              | Friendly Name | Entity ID | Current Value | Unit | Status |
              |---------------|-----------|---------------|------|--------|
              {%- for entity in states.sensor %}
                {%- if 'shelly' in entity.entity_id | lower and 'temperature' in entity.entity_id | lower %}
              | {{ entity.name }} | `{{ entity.entity_id }}` | {{ entity.state }} | {{ state_attr(entity.entity_id, 'unit_of_measurement') }} | {{ 'âœ…' if entity.state not in ['unknown', 'unavailable'] else 'âŒ' }} |
                {%- endif %}
              {%- endfor %}

              ## Buffer Tank Wrapper Sensors (Expected)
              | Wrapper Sensor | Source | Status |
              |----------------|--------|--------|
              | `sensor.buffer_supply_from_heat_pump` | `sensor.shellyplus1_c4d8d5543fc0_temperature` | {{ 'âœ…' if states('sensor.buffer_supply_from_heat_pump') not in ['unknown', 'unavailable'] else 'âŒ Not found' }} |
              | `sensor.buffer_return_to_heat_pump` | `sensor.shellyplus1_c4d8d5543fc0_temperature_3` | {{ 'âœ…' if states('sensor.buffer_return_to_heat_pump') not in ['unknown', 'unavailable'] else 'âŒ Not found' }} |

              **Purpose:** Verify Shelly integration sensor names match our configuration

          # DHW SYSTEM STATUS
          - type: markdown
            title: ğŸš¿ DHW System Status (Domestic Hot Water)
            grid_options:
              columns: full
            content: |
              ## DHW Mode Detection
              **Current Operating Mode:** `{{ states('sensor.heat_pump_operating_mode') }}`
              - In DHW Mode: {{ 'âœ… Yes' if 'DHW' in states('sensor.heat_pump_operating_mode') else 'âŒ No' }}

              ## G2 Valve Position (Heat Routing)
              | Sensor | Value | Status |
              |--------|-------|--------|
              | G2 Valve Position | {{ states('sensor.g2_valve_position') }} | {{ 'âœ…' if states('sensor.g2_valve_position') not in ['unknown', 'unavailable', 'Unknown'] else 'âŒ' }} |
              | G2 DHW Mode Active | {{ states('binary_sensor.g2_valve_dhw_mode') }} | {{ 'âœ…' if states('binary_sensor.g2_valve_dhw_mode') not in ['unknown', 'unavailable'] else 'âŒ' }} |

              ## Temperature Analysis for G2 Valve
              {% set hp_outlet = states('sensor.heat_pump_outlet_temperature') | float(0) %}
              {% set buf_supply = states('sensor.hvac_buffer_tank_supply_temperature') | float(0) %}
              {% set buf_return = states('sensor.hvac_buffer_tank_return_temperature') | float(0) %}
              {% set buf_delta = buf_supply - buf_return %}
              {% set compressor_freq = states('sensor.cx50_compressor_frequency') | float(0) %}

              | Measurement | Value | Analysis |
              |-------------|-------|----------|
              | HP Outlet Temp | {{ hp_outlet }}Â°F | {{ 'âœ… Available' if hp_outlet > 0 else 'âŒ Missing/Zero' }} |
              | Buffer Supply | {{ buf_supply }}Â°F | From heat pump to buffer |
              | Buffer Return | {{ buf_return }}Â°F | From buffer to heat pump |
              | **Buffer Delta-T** | **{{ buf_delta | round(2) }}Â°F** | {{ 'âœ… Heating buffer (>1Â°F)' if buf_delta > 1.0 else ('âš ï¸ Minimal heating' if buf_delta > 0.5 else 'âŒ G2 to DHW tank') }} |
              | Compressor Freq | {{ compressor_freq }}Hz | {{ 'âœ… Running' if compressor_freq > 0 else 'âš ï¸ Off' }}|

              **G2 Valve Logic:**
              {% if compressor_freq > 0 %}
                {% if buf_delta > 1.0 %}
              - âœ… **G2 â†’ Buffer Tank** (heating mode, buffer Î”T = {{ buf_delta | round(2) }}Â°F)
                {% elif buf_delta < 0.5 %}
              - âš ï¸ **G2 â†’ DHW Tank** (DHW mode, buffer Î”T = {{ buf_delta | round(2) }}Â°F)
                {% else %}
              - ğŸ”„ **Transitioning** (buffer Î”T = {{ buf_delta | round(2) }}Â°F between thresholds)
                {% endif %}
              {% else %}
              - â¸ï¸ **Heat Pump Off** (compressor not running)
              {% endif %}

              ## DHW Tank Sensors (if available)
              | Sensor | Value | Status |
              |--------|-------|--------|
              | DHW Tank Temp Top | {{ states('sensor.dhw_tank_temperature_top') }}Â°F | {{ 'âœ…' if states('sensor.dhw_tank_temperature_top') not in ['unknown', 'unavailable'] else 'âš ï¸ Not configured' }} |
              | DHW Tank Temp Bottom | {{ states('sensor.dhw_tank_temperature_bottom') }}Â°F | {{ 'âœ…' if states('sensor.dhw_tank_temperature_bottom') not in ['unknown', 'unavailable'] else 'âš ï¸ Not configured' }} |
              | DHW Circulation Pump | {{ states('binary_sensor.dhw_circulation_pump') }} | {{ 'âœ…' if states('binary_sensor.dhw_circulation_pump') not in ['unknown', 'unavailable'] else 'âš ï¸ Not configured' }} |

              **Note:** DHW sensors may not exist yet. G2 valve detection uses buffer tank temperature rise.

          # G2 VALVE DETAILED LOGIC
          - type: markdown
            title: ğŸ”€ G2 Valve Detection - Detailed Logic
            grid_options:
              columns: full
            content: |
              ## Purpose
              The G2 diverter valve routes heat pump output to either:
              - **Buffer Tank** (space heating via radiant floors/AHUs)
              - **DHW Tank** (domestic hot water)

              We detect actual valve position by measuring buffer tank temperature rise.

              ## Step-by-Step Logic Evaluation
              {% set hp_running = is_state('binary_sensor.heat_pump_running', 'on') %}
              {% set compressor_freq = states('sensor.cx50_compressor_frequency') | float(0) %}
              {% set hp_outlet = states('sensor.heat_pump_outlet_temperature') | float(0) %}
              {% set buf_supply = states('sensor.hvac_buffer_tank_supply_temperature') | float(0) %}
              {% set buf_return = states('sensor.hvac_buffer_tank_return_temperature') | float(0) %}
              {% set buf_delta = buf_supply - buf_return %}

              ### Step 1: Is Heat Pump Running?
              - `binary_sensor.heat_pump_running`: {{ states('binary_sensor.heat_pump_running') }}
              - `sensor.cx50_compressor_frequency`: {{ compressor_freq }}Hz
              - **Running?** {{ 'âœ… Yes' if compressor_freq > 0 else 'âŒ No - G2 detection requires HP running' }}

              ### Step 2: Temperature Sensor Availability
              | Sensor | Raw State | Parsed Value | Available? |
              |--------|-----------|--------------|------------|
              | HP Outlet | `{{ states('sensor.heat_pump_outlet_temperature') }}` | {{ hp_outlet }}Â°F | {{ 'âœ…' if hp_outlet > 0 else 'âŒ Missing' }} |
              | Buffer Supply | `{{ states('sensor.hvac_buffer_tank_supply_temperature') }}` | {{ buf_supply }}Â°F | {{ 'âœ…' if buf_supply > 0 else 'âŒ' }} |
              | Buffer Return | `{{ states('sensor.hvac_buffer_tank_return_temperature') }}` | {{ buf_return }}Â°F | {{ 'âœ…' if buf_return > 0 else 'âŒ' }} |

              ### Step 3: Calculate Buffer Tank Delta-T
              - Formula: `buffer_supply - buffer_return`
              - Calculation: {{ buf_supply }}Â°F - {{ buf_return }}Â°F
              - **Result: {{ buf_delta | round(2) }}Â°F**

              ### Step 4: Apply G2 Detection Thresholds
              {% if compressor_freq > 0 %}
              **Compressor is running ({{ compressor_freq }}Hz):**

              | Threshold | Check | Result |
              |-----------|-------|--------|
              | Î”T > 1.0Â°F | {{ buf_delta | round(2) }} > 1.0 | {{ 'âœ… TRUE - G2 to Buffer Tank' if buf_delta > 1.0 else 'âŒ FALSE' }} |
              | Î”T < 0.5Â°F | {{ buf_delta | round(2) }} < 0.5 | {{ 'âœ… TRUE - G2 to DHW Tank' if buf_delta < 0.5 else 'âŒ FALSE' }} |
              | 0.5 â‰¤ Î”T â‰¤ 1.0 | 0.5 â‰¤ {{ buf_delta | round(2) }} â‰¤ 1.0 | {{ 'âš ï¸ TRUE - Transitioning' if 0.5 <= buf_delta <= 1.0 else 'âŒ FALSE' }} |

              **G2 Valve Position Decision:**
              {% if buf_delta > 1.0 %}
              - âœ… **"Buffer Tank"** - Heat going to buffer tank for space heating
              - Buffer is gaining heat ({{ buf_delta | round(2) }}Â°F rise)
              - DHW tank bypassed
              {% elif buf_delta < 0.5 %}
              - âš ï¸ **"DHW Tank"** - Heat going to DHW tank
              - Buffer not gaining significant heat ({{ buf_delta | round(2) }}Â°F)
              - Most output going to DHW
              {% else %}
              - ğŸ”„ **"Transitioning"** - Valve may be moving or split flow
              - Buffer Î”T in gray zone ({{ buf_delta | round(2) }}Â°F)
              {% endif %}
              {% else %}
              **Compressor is OFF:**
              - â¸ï¸ Cannot determine G2 position when heat pump not running
              - G2 valve state is "Unknown" until compressor starts
              {% endif %}

              ### Step 5: Sensor State vs Expected
              | Sensor | Expected | Actual | Match? |
              |--------|----------|--------|--------|
              | `sensor.g2_valve_position` | {% if compressor_freq > 0 %}{{ 'Buffer Tank' if buf_delta > 1.0 else ('DHW Tank' if buf_delta < 0.5 else 'Transitioning') }}{% else %}Unknown{% endif %} | {{ states('sensor.g2_valve_position') }} | {{ 'âœ…' if states('sensor.g2_valve_position') == ('Buffer Tank' if buf_delta > 1.0 and compressor_freq > 0 else ('DHW Tank' if buf_delta < 0.5 and compressor_freq > 0 else 'Unknown')) else 'âŒ' }} |
              | `binary_sensor.g2_valve_dhw_mode` | {% if compressor_freq > 0 %}{{ 'on' if buf_delta < 0.5 else 'off' }}{% else %}unavailable{% endif %} | {{ states('binary_sensor.g2_valve_dhw_mode') }} | {{ 'âœ…' if states('binary_sensor.g2_valve_dhw_mode') in ['unknown', 'unavailable'] or is_state('binary_sensor.g2_valve_dhw_mode', 'on' if buf_delta < 0.5 and compressor_freq > 0 else 'off') else 'âŒ' }} |

              **Issues Found:**
              {% if states('sensor.g2_valve_position') in ['unknown', 'unavailable', 'Unknown'] %}
              - âŒ G2 position sensor not working - check `sensors/template/g2_valve_sensors.yaml`
              {% endif %}
              {% if hp_outlet == 0 %}
              - âŒ HP outlet temperature missing - needed for validation
              {% endif %}
              {% if buf_supply == 0 or buf_return == 0 %}
              - âŒ Buffer tank temperature sensors missing
              {% endif %}

          # RADIANT ZONE STATUS
          - type: markdown
            title: ğŸŒ¡ï¸ Radiant Zone Status
            grid_options:
              columns: full
            content: |
              ## Buffer Tank Distribution
              **Buffer Tank Status:**
              | Metric | Value |
              |--------|-------|
              | Supply Temp | {{ states('sensor.hvac_buffer_tank_supply_temperature') }}Â°F |
              | Return Temp | {{ states('sensor.hvac_buffer_tank_return_temperature') }}Â°F |
              | Delta-T | {{ states('sensor.hvac_buffer_tank_delta_t') }}Â°F |
              | Flow Rate | {{ states('sensor.hvac_buffer_tank_flow_rate') }} LPM |
              | HVAC Thermal Power | {{ states('sensor.hvac_thermal_power_used') }}W ({{ (states('sensor.hvac_thermal_power_used') | float(0) / 1000) | round(2) }}kW) |

              ## Radiant Floor Zones
              | Zone | Call Status | Flow Temp | Return Temp | Status |
              |------|-------------|-----------|-------------|--------|
              | Master Suite | {{ states('binary_sensor.master_suite_radiant') }} | {{ states('sensor.master_suite_radiant_flow_temp') }}Â°F | {{ states('sensor.master_suite_radiant_return_temp') }}Â°F | {{ 'ğŸ”¥ Active' if is_state('binary_sensor.master_suite_radiant', 'on') else 'â¸ï¸ Idle' }} |
              | Lower Level | {{ states('binary_sensor.lower_level_radiant') }} | {{ states('sensor.lower_level_radiant_flow_temp') }}Â°F | {{ states('sensor.lower_level_radiant_return_temp') }}Â°F | {{ 'ğŸ”¥ Active' if is_state('binary_sensor.lower_level_radiant', 'on') else 'â¸ï¸ Idle' }} |

              ## Air Handler Units (AHUs)
              | AHU | Status | Supply Temp | Room Temp | Coil Active |
              |-----|--------|-------------|-----------|-------------|
              | Master Suite AHU | {{ states('binary_sensor.master_suite_ahu') }} | {{ states('sensor.master_suite_ahu_supply_temp') }}Â°F | {{ states('sensor.shellyplus1_8813bf9fc014_temperature_4') }}Â°F | {{ 'âœ…' if is_state('binary_sensor.master_suite_ahu', 'on') else 'â¸ï¸' }} |
              | Lower Level AHU | {{ states('binary_sensor.lower_level_ahu') }} | {{ states('sensor.lower_level_ahu_supply_temp') }}Â°F | {{ states('sensor.shellyplus1_048308d6a208_temperature_2') }}Â°F | {{ 'âœ…' if is_state('binary_sensor.lower_level_ahu', 'on') else 'â¸ï¸' }} |

              ## Heat Distribution Analysis
              {% set hp_thermal = states('sensor.heat_pump_thermal_power_output') | float(0) / 1000 %}
              {% set hvac_load = states('sensor.hvac_thermal_power_used') | float(0) / 1000 %}
              {% set efficiency = states('sensor.system_distribution_efficiency') | float(0) %}
              {% set master_on = is_state('binary_sensor.master_suite_radiant', 'on') %}
              {% set lower_on = is_state('binary_sensor.lower_level_radiant', 'on') %}

              | Metric | Value | Analysis |
              |--------|-------|----------|
              | HP Output | {{ hp_thermal | round(2) }}kW | Total heat produced |
              | HVAC Load | {{ hvac_load | round(2) }}kW | Heat to distribution |
              | Distribution Efficiency | {{ efficiency | round(1) }}% | {{ 'âœ… Good' if efficiency > 80 else 'âš ï¸ Low - check for DHW mode' }} |
              | Active Zones | {{ (1 if master_on else 0) + (1 if lower_on else 0) }} zones | {{ 'Master' if master_on else '' }}{{ ', ' if master_on and lower_on else '' }}{{ 'Lower' if lower_on else '' }} |

              **Expected Behavior:**
              - Pure "Heat" mode: Efficiency > 80% (most heat to zones)
              - "Heat + DHW" mode: Efficiency 20-50% (heat split between zones and DHW)
              - Pure "DHW" mode: Efficiency < 20% (most heat to DHW tank)

              **Current:** {% if 'DHW' in states('sensor.heat_pump_operating_mode') %}{{ 'âš ï¸ In DHW mode - low efficiency expected' }}{% else %}{{ 'âœ… Heating mode - efficiency should be high' }}{% endif %}

          # MODBUS COMMUNICATION STATUS
          - type: markdown
            title: ğŸ“¡ Modbus Communication Status
            grid_options:
              columns: full
            content: |
              ## CX50 Heat Pump Modbus Sensors
              | Sensor | Entity ID | Current Value | Unit | Status |
              |--------|-----------|---------------|------|--------|
              | Operating Mode | `sensor.heat_pump_operating_mode` | {{ states('sensor.heat_pump_operating_mode') }} | - | {{ 'âœ…' if states('sensor.heat_pump_operating_mode') not in ['unknown', 'unavailable'] else 'âŒ' }} |
              | Input Voltage | `sensor.cx50_input_ac_voltage` | {{ states('sensor.cx50_input_ac_voltage') }} | V | {{ 'âœ…' if states('sensor.cx50_input_ac_voltage') not in ['unknown', 'unavailable'] else 'âŒ' }} |
              | Input Current | `sensor.cx50_input_ac_current` | {{ states('sensor.cx50_input_ac_current') }} | A | {{ 'âœ…' if states('sensor.cx50_input_ac_current') not in ['unknown', 'unavailable'] else 'âŒ' }} |
              | Compressor Freq | `sensor.cx50_compressor_frequency` | {{ states('sensor.cx50_compressor_frequency') }} | Hz | {{ 'âœ…' if states('sensor.cx50_compressor_frequency') not in ['unknown', 'unavailable'] else 'âŒ' }} |
              | Inlet Temp | `sensor.heat_pump_inlet_temperature` | {{ states('sensor.heat_pump_inlet_temperature') }} | Â°F | {{ 'âœ…' if states('sensor.heat_pump_inlet_temperature') not in ['unknown', 'unavailable'] else 'âŒ' }} |
              | Outlet Temp | `sensor.heat_pump_outlet_temperature` | {{ states('sensor.heat_pump_outlet_temperature') }} | Â°F | {{ 'âœ…' if states('sensor.heat_pump_outlet_temperature') not in ['unknown', 'unavailable'] else 'âŒ MISSING' }} |
              | Flow Rate (GPM) | `sensor.cx50_pump_flow_gpm` | {{ states('sensor.cx50_pump_flow_gpm') }} | GPM | {{ 'âœ…' if states('sensor.cx50_pump_flow_gpm') not in ['unknown', 'unavailable'] else 'âŒ' }} |
              | Flow Rate (LPM) | `sensor.cx50_pump_flow_lpm` | {{ states('sensor.cx50_pump_flow_lpm') }} | LPM | {{ 'âœ…' if states('sensor.cx50_pump_flow_lpm') not in ['unknown', 'unavailable'] else 'âŒ' }} |
              | C34 Water Pump | `sensor.cx50_c34` | {{ states('sensor.cx50_c34') }} | - | {{ 'âœ…' if states('sensor.cx50_c34') not in ['unknown', 'unavailable'] else 'âŒ' }} |

              ## Communication Health
              {% set sensors_to_check = [
                'sensor.heat_pump_operating_mode',
                'sensor.cx50_input_ac_voltage',
                'sensor.cx50_input_ac_current',
                'sensor.cx50_compressor_frequency',
                'sensor.heat_pump_inlet_temperature',
                'sensor.cx50_pump_flow_gpm',
                'sensor.cx50_pump_flow_lpm',
                'sensor.cx50_c34'
              ] %}
              {% set available_count = namespace(value=0) %}
              {% for sensor in sensors_to_check %}
                {% if states(sensor) not in ['unknown', 'unavailable'] %}
                  {% set available_count.value = available_count.value + 1 %}
                {% endif %}
              {% endfor %}

              - **Total Modbus Sensors Checked:** {{ sensors_to_check | length }}
              - **Available:** {{ available_count.value }}
              - **Unavailable:** {{ sensors_to_check | length - available_count.value }}
              - **Health:** {{ (available_count.value / sensors_to_check | length * 100) | round(0) }}%

              {% if available_count.value == sensors_to_check | length %}
              âœ… **All Modbus sensors responding correctly**
              {% elif available_count.value > (sensors_to_check | length * 0.8) %}
              âš ï¸ **Mostly working** - {{ sensors_to_check | length - available_count.value }} sensor(s) unavailable
              {% else %}
              âŒ **Communication issues** - Check Modbus connection to CX50 heat pump
              {% endif %}

              ## Missing/Failed Sensors
              | Sensor | Status | Action Needed |
              |--------|--------|---------------|
              {% for sensor in sensors_to_check %}
                {% if states(sensor) in ['unknown', 'unavailable'] %}
              | `{{ sensor }}` | {{ states(sensor) }} | Check Modbus register mapping |
                {% endif %}
              {% endfor %}
              {% if states('sensor.heat_pump_outlet_temperature') in ['unknown', 'unavailable'] %}
              | `sensor.heat_pump_outlet_temperature` | {{ states('sensor.heat_pump_outlet_temperature') }} | âŒ **CRITICAL** - Needed for G2 valve detection |
              {% endif %}

              **Note:** Missing outlet temperature sensor is blocking G2 valve position detection.

          # ENTITY REGISTRY CHECK
          - type: markdown
            title: ğŸ“‹ Entity Registry Check
            grid_options:
              columns: full
            content: |
              ## Template Sensors by File
              This section helps identify which sensor files are loaded and which entities exist.

              ### Critical Binary Sensors
              | Entity | Exists? | Current State | File |
              |--------|---------|---------------|------|
              | `binary_sensor.cx_c34_water_pump` | {{ 'âœ… Yes' if states('binary_sensor.cx_c34_water_pump') not in ['unknown', 'unavailable'] or states('binary_sensor.cx_c34_water_pump') in ['on', 'off'] else 'âŒ No' }} | {{ states('binary_sensor.cx_c34_water_pump') }} | cx_sensors.yaml:338 |
              | `binary_sensor.heat_pump_running` | {{ 'âœ… Yes' if states('binary_sensor.heat_pump_running') not in ['unknown', 'unavailable'] or states('binary_sensor.heat_pump_running') in ['on', 'off'] else 'âŒ No' }} | {{ states('binary_sensor.heat_pump_running') }} | cx_optimization_sensors.yaml:11 |
              | `binary_sensor.g2_valve_dhw_mode` | {{ 'âœ… Yes' if states('binary_sensor.g2_valve_dhw_mode') not in ['unknown', 'unavailable'] or states('binary_sensor.g2_valve_dhw_mode') in ['on', 'off'] else 'âŒ No' }} | {{ states('binary_sensor.g2_valve_dhw_mode') }} | g2_valve_sensors.yaml |

              ### Critical Sensors
              | Entity | Exists? | Current Value | File |
              |--------|---------|---------------|------|
              | `sensor.heat_pump_thermal_power_output` | {{ 'âœ… Yes' if states('sensor.heat_pump_thermal_power_output') not in ['unknown', 'unavailable'] else 'âŒ No' }} | {{ states('sensor.heat_pump_thermal_power_output') }}W | cx_sensors.yaml |
              | `sensor.heat_pump_thermal_power_kw` | {{ 'âœ… Yes' if states('sensor.heat_pump_thermal_power_kw') not in ['unknown', 'unavailable'] else 'âŒ No' }} | {{ states('sensor.heat_pump_thermal_power_kw') }}kW | cx_sensors.yaml:275 |
              | `sensor.cx_output_power_interval` | {{ 'âœ… Yes' if states('sensor.cx_output_power_interval') not in ['unknown', 'unavailable'] else 'âŒ No' }} | {{ states('sensor.cx_output_power_interval') }}kWh | legacy_sensors.yaml:227 |
              | `sensor.g2_valve_position` | {{ 'âœ… Yes' if states('sensor.g2_valve_position') not in ['unknown', 'unavailable'] else 'âŒ No' }} | {{ states('sensor.g2_valve_position') }} | g2_valve_sensors.yaml |
              | `sensor.heat_pump_outlet_temperature` | {{ 'âœ… Yes' if states('sensor.heat_pump_outlet_temperature') not in ['unknown', 'unavailable'] else 'âŒ No' }} | {{ states('sensor.heat_pump_outlet_temperature') }}Â°F | **MISSING** |
              | `sensor.cx50_outlet_temp` | {{ 'âœ… Yes' if states('sensor.cx50_outlet_temp') not in ['unknown', 'unavailable'] else 'âŒ No' }} | {{ states('sensor.cx50_outlet_temp') }}Â°F | cx_sensors.yaml (Modbus) |

              ### Shelly Buffer Tank Sensors
              | Entity | Exists? | Current Value | File |
              |--------|---------|---------------|------|
              | `sensor.buffer_supply_from_heat_pump` | {{ 'âœ… Yes' if states('sensor.buffer_supply_from_heat_pump') not in ['unknown', 'unavailable'] else 'âŒ No' }} | {{ states('sensor.buffer_supply_from_heat_pump') }}Â°F | shelly_buffer_tank_sensors.yaml |
              | `sensor.buffer_return_to_heat_pump` | {{ 'âœ… Yes' if states('sensor.buffer_return_to_heat_pump') not in ['unknown', 'unavailable'] else 'âŒ No' }} | {{ states('sensor.buffer_return_to_heat_pump') }}Â°F | shelly_buffer_tank_sensors.yaml |

              ## Sensor File Load Status
              Check `configuration.yaml` for these includes:
              - âœ… `sensor: !include_dir_merge_list sensors/template/`
              - âœ… `sensor: !include sensors/legacy_sensors.yaml`
              - âœ… `utility_meter: !include sensors/utility_meters/utility_meters.yaml`

              **Issues Found:**
              {% set issues = [] %}
              {% if states('binary_sensor.cx_c34_water_pump') in ['unknown', 'unavailable'] %}
                {% set _ = issues.append('Water pump binary sensor not working') %}
              {% endif %}
              {% if states('binary_sensor.heat_pump_running') in ['unknown', 'unavailable'] %}
                {% set _ = issues.append('Heat pump running sensor not working (depends on water pump)') %}
              {% endif %}
              {% if states('sensor.cx_output_power_interval') in ['unknown', 'unavailable'] %}
                {% set _ = issues.append('Integration sensor not initialized') %}
              {% endif %}
              {% if states('sensor.heat_pump_outlet_temperature') in ['unknown', 'unavailable'] and states('sensor.cx50_outlet_temp') in ['unknown', 'unavailable'] %}
                {% set _ = issues.append('CRITICAL: No outlet temperature sensor available') %}
              {% endif %}

              {% if issues | length > 0 %}
              {% for issue in issues %}
              - âŒ {{ issue }}
              {% endfor %}
              {% else %}
              âœ… All critical sensors are loaded and available
              {% endif %}

          # EVENT TIMELINE CARD
          - type: logbook
            title: ğŸ”” Heat Pump Event Timeline
            hours_to_show: 24
            grid_options:
              columns: full
            entities:
              # Core state changes
              - binary_sensor.heat_pump_running
              - sensor.heat_pump_operating_mode

              # Cycle tracking
              - sensor.heat_pump_last_cycle_duration
              - sensor.heat_pump_last_cycle_cop

              # Phase transitions
              - binary_sensor.heat_pump_in_startup_phase
              - binary_sensor.heat_pump_steady_state
              - binary_sensor.heat_pump_last_cycle_was_short

              # Performance alerts
              - sensor.heat_pump_cop
              - sensor.heat_pump_efficiency_rating

              # Integration sensors (to see when they initialize)
              - sensor.cx_output_power_interval
              - sensor.cx_input_power_kwh

          # CARD 1: RAW HEAT PUMP SENSORS
          - type: markdown
            title: ğŸ”Œ Raw Heat Pump Sensors (cx_sensors.yaml)
            grid_options:
              columns: full
            content: |
              ## Primary Inputs (Direct from Modbus)
              | Sensor | Value | Status |
              |--------|-------|--------|
              | Operating Mode | {{ states('sensor.heat_pump_operating_mode') }} | {{ 'âœ…' if states('sensor.heat_pump_operating_mode') not in ['unknown', 'unavailable'] else 'âŒ' }} |
              | Inlet Temp | {{ states('sensor.heat_pump_inlet_temperature') }}Â°F | {{ 'âœ…' if states('sensor.heat_pump_inlet_temperature') not in ['unknown', 'unavailable'] else 'âŒ' }} |
              | Outlet Temp | {{ states('sensor.heat_pump_outlet_temperature') }}Â°F | {{ 'âœ…' if states('sensor.heat_pump_outlet_temperature') not in ['unknown', 'unavailable'] else 'âŒ' }} |
              | Delta T | {{ states('sensor.heat_pump_delta_t') }}Â°F | {{ 'âœ…' if states('sensor.heat_pump_delta_t') not in ['unknown', 'unavailable'] else 'âŒ' }} |
              | Flow Rate | {{ states('sensor.cx50_pump_flow_gpm') }} GPM | {{ 'âœ…' if states('sensor.cx50_pump_flow_gpm') | float(0) > 0 else 'âš ï¸ Zero/Low' }} |
              | Flow Rate | {{ states('sensor.cx50_pump_flow_lpm') }} LPM | {{ 'âœ…' if states('sensor.cx50_pump_flow_lpm') | float(0) > 0 else 'âš ï¸ Zero/Low' }} |
              | AC Voltage | {{ states('sensor.cx50_input_ac_voltage') }}V | {{ 'âœ…' if states('sensor.cx50_input_ac_voltage') not in ['unknown', 'unavailable'] else 'âŒ' }} |
              | AC Current | {{ states('sensor.cx50_input_ac_current') }}A | {{ 'âœ…' if states('sensor.cx50_input_ac_current') not in ['unknown', 'unavailable'] else 'âŒ' }} |

              ## Calculated Power (V Ã— I)
              | Sensor | Value | Formula | Status |
              |--------|-------|---------|--------|
              | Electrical Input | {{ states('sensor.heat_pump_electrical_power_input') }}W | V Ã— I | {{ 'âœ…' if states('sensor.heat_pump_electrical_power_input') | float(0) > 0 or is_state('binary_sensor.heat_pump_running', 'off') else 'âš ï¸' }} |
              | Electrical Input | {{ states('sensor.heat_pump_electrical_power_input_kw') }}kW | / 1000 | {{ 'âœ…' if states('sensor.heat_pump_electrical_power_input_kw') not in ['unknown', 'unavailable'] else 'âŒ' }} |

              ## Calculated Thermal (Q = á¹ Ã— Cp Ã— Î”T)
              | Sensor | Value | Dependencies | Status |
              |--------|-------|--------------|--------|
              | Thermal Output | {{ states('sensor.heat_pump_thermal_power_output') }}W | Flow, Î”T, Cp, Ï | {{ 'âœ…' if states('sensor.heat_pump_thermal_power_output') not in ['unknown', 'unavailable'] else 'âŒ' }} |
              | Thermal (kW) | {{ states('sensor.heat_pump_thermal_power_kw') }}kW | Mode-filtered | {{ 'âœ…' if states('sensor.heat_pump_thermal_power_kw') not in ['unknown', 'unavailable'] else 'âŒ' }} |

              ## COP Calculation
              | Sensor | Value | Formula | Status |
              |--------|-------|---------|--------|
              | Current COP | {{ states('sensor.heat_pump_cop') }} | Thermal / Electrical | {{ 'âœ… Good (1.5-5.5)' if 1.5 < states('sensor.heat_pump_cop') | float(0) < 6 else ('N/A (off)' if is_state('binary_sensor.heat_pump_running', 'off') else 'âš ï¸') }} |
              | Efficiency Rating | {{ states('sensor.heat_pump_efficiency_rating') }} | COP â†’ Text | {{ 'âœ…' if states('sensor.heat_pump_efficiency_rating') != 'Unknown' else 'âš ï¸' }} |

              **Data Flow:** Modbus â†’ Raw Readings â†’ Power Calc (VÃ—I) â†’ Thermal Calc (Q=á¹CpÎ”T) â†’ COP

          # CARD 2: INTEGRATION SENSORS
          - type: markdown
            title: âš¡ Integration Sensors (legacy_sensors.yaml)
            grid_options:
              columns: full
            content: |
              ## Integration Platform (Power â†’ Energy over time)
              | Sensor | Source | Value | Method | Status |
              |--------|--------|-------|--------|--------|
              | **CX Input Power kWh** | heat_pump_electrical_power_input (W) | {{ states('sensor.cx_input_power_kwh') }} kWh | Riemann (left) | {{ 'âœ… Accumulating' if states('sensor.cx_input_power_kwh') not in ['unknown', 'unavailable'] and states('sensor.cx_input_power_kwh') | float(-1) >= 0 else 'âŒ' }} |
              | **CX Output Power Interval** | heat_pump_thermal_power_output (W) | {{ states('sensor.cx_output_power_interval') }} kWh | Riemann (left) | {{ 'âœ… Accumulating' if states('sensor.cx_output_power_interval') not in ['unknown', 'unavailable'] and states('sensor.cx_output_power_interval') | float(-1) >= 0 else 'âŒ Not initialized yet' }} |

              ## Expected Relationship (Energy-Based COP)
              {% set input = states('sensor.cx_input_power_kwh') | float(0) %}
              {% set output = states('sensor.cx_output_power_interval') | float(0) %}
              {% if input > 1 and output > 0 %}
              | Metric | Value | Status |
              |--------|-------|--------|
              | Input Energy | {{ input | round(3) }} kWh | - |
              | Output Energy | {{ output | round(3) }} kWh | - |
              | **COP (Energy-based)** | **{{ (output / input) | round(2) }}** | {{ 'âœ… Reasonable (1.5-5.5)' if 1.5 < (output / input) < 6 else 'âš ï¸ Check values' }} |
              {% else %}
              **Status:** â³ Waiting for both sensors to accumulate (need > 1 kWh input)
              {% endif %}

              **Data Flow:** Power (W) â†’ Integration â†’ Energy (kWh) â†’ Utility Meters

              **Note:** Integration sensors created on 2025-11-12 to fix missing sensor definitions

          # CARD 3: CYCLE TRACKING SENSORS
          - type: markdown
            title: ğŸ”„ Cycle Tracking Sensors (heat_pump_cycle_sensors.yaml)
            grid_options:
              columns: full
            content: |
              ## Binary Sensor Source (Improved Logic - 2025-11-12)
              | Sensor | Value | Based On |
              |--------|-------|----------|
              | Heat Pump Running | {{ states('binary_sensor.heat_pump_running') }} | **Pump ON** AND (**Compressor Running** OR **Heat Transfer**) |

              **Detection Logic:**
              - **Water Pump**: {{ states('binary_sensor.cx_c34_water_pump') }} (Modbus C34: {{ states('sensor.cx50_c34') }}, Flow: {{ states('sensor.cx50_pump_flow_lpm') }}L/min)
              - **Compressor Freq**: {{ states('sensor.cx50_compressor_frequency') }}Hz
              - **Thermal Output**: {{ (states('sensor.heat_pump_thermal_power_output') | float(0) / 1000) | round(1) }}kW

              **Water Pump Detection:** C34=1 OR Flow>1.0 L/min (validates actual circulation)
              **HP Running:** Pump ON AND (Freq>0 OR Thermal>1kW)

              ## Trigger-Based Cycle Sensors (NEW 2025-11-12)
              | Sensor | Value | Unit | Status |
              |--------|-------|------|--------|
              | Current Cycle Duration | {{ states('sensor.heat_pump_current_cycle_duration') }} | seconds | {{ 'âœ… Incrementing' if states('sensor.heat_pump_current_cycle_duration') | float(0) > 0 and is_state('binary_sensor.heat_pump_running', 'on') else ('âœ… Zero (off)' if is_state('binary_sensor.heat_pump_running', 'off') else 'âš ï¸') }} |
              | Current Cycle Duration | {{ states('sensor.heat_pump_current_cycle_duration_minutes') }} | minutes | {{ 'âœ… Matches' if ((states('sensor.heat_pump_current_cycle_duration') | float(0) / 60) | round(2) - states('sensor.heat_pump_current_cycle_duration_minutes') | float(0)) | abs < 0.1 else 'âš ï¸ Mismatch' }} |
              | Last Cycle Duration | {{ states('sensor.heat_pump_last_cycle_duration') }} | seconds | {{ 'âœ… Has data' if states('sensor.heat_pump_last_cycle_duration') | float(0) > 0 else 'âš ï¸ Waiting for cycle' }} |
              | Last Cycle COP | {{ states('sensor.heat_pump_last_cycle_cop') }} | - | {{ 'âœ… Captured' if states('sensor.heat_pump_last_cycle_cop') not in ['unknown', 'unavailable'] else 'âš ï¸ Waiting' }} |

              ## Standby Power Sensors (NEW 2025-11-12)
              | Sensor | Value | Unit | Status |
              |--------|-------|------|--------|
              | Current Standby Power | {{ states('sensor.heat_pump_standby_power') }} | W | {{ 'âœ… Tracking' if is_state('binary_sensor.heat_pump_running', 'off') else 'âœ… Preserved' }} |
              | Last Standby Power | {{ states('sensor.heat_pump_last_standby_power') }} | W | {{ 'âœ… Captured' if states('sensor.heat_pump_last_standby_power') | float(0) > 0 else 'âš ï¸ Waiting' }} |

              ## Cycle Phases (Calculated from Duration)
              | Sensor | Value | Formula | Expected When |
              |--------|-------|---------|---------------|
              | Startup Phase | {{ states('binary_sensor.heat_pump_in_startup_phase') }} | cycle < 180s | ON during first 3min |
              | Steady State | {{ states('binary_sensor.heat_pump_steady_state') }} | cycle > 180s | ON after 3min |
              | Last Cycle Short | {{ states('binary_sensor.heat_pump_last_cycle_was_short') }} | last < 300s | ON if < 5min cycle |

              **Data Flow:** binary_sensor.heat_pump_running â†’ Cycle Duration â†’ Binary States

          # CARD 4: UTILITY METERS
          - type: markdown
            title: ğŸ“Š Utility Meters (utility_meters.yaml)
            grid_options:
              columns: full
            content: |
              ## Energy Output Meters (Source: cx_output_power_interval)
              | Meter | Value | Source Status | Meter Status |
              |-------|-------|---------------|--------------|
              | Hourly | {{ states('sensor.cx_hourly_energy_output') }} kWh | {{ 'âœ…' if states('sensor.cx_output_power_interval') not in ['unknown', 'unavailable'] else 'âŒ Source unavailable' }} | {{ 'âœ…' if states('sensor.cx_hourly_energy_output') not in ['unknown', 'unavailable'] else 'âŒ' }} |
              | Daily | {{ states('sensor.cx_daily_energy_output') }} kWh | {{ 'âœ…' if states('sensor.cx_output_power_interval') not in ['unknown', 'unavailable'] else 'âŒ Source unavailable' }} | {{ 'âœ…' if states('sensor.cx_daily_energy_output') not in ['unknown', 'unavailable'] else 'âŒ' }} |
              | Monthly | {{ states('sensor.cx_monthly_energy_output') }} kWh | {{ 'âœ…' if states('sensor.cx_output_power_interval') not in ['unknown', 'unavailable'] else 'âŒ Source unavailable' }} | {{ 'âœ…' if states('sensor.cx_monthly_energy_output') not in ['unknown', 'unavailable'] else 'âŒ' }} |

              ## Energy Input Meters (Source: cx_input_power_kwh)
              | Meter | Value | Sanity Check | Status |
              |-------|-------|--------------|--------|
              | Hourly | {{ states('sensor.cx_hourly_energy_input') }} kWh | {{ 'âœ… <100kWh' if states('sensor.cx_hourly_energy_input') | float(0) < 100 else 'âŒ TOO HIGH - Corrupted' }} | {{ 'âœ…' if states('sensor.cx_hourly_energy_input') not in ['unknown', 'unavailable'] else 'âŒ' }} |
              | Daily | {{ states('sensor.cx_daily_energy_input') }} kWh | {{ 'âœ… <2000kWh' if states('sensor.cx_daily_energy_input') | float(0) < 2000 else 'âŒ TOO HIGH - Corrupted' }} | {{ 'âœ…' if states('sensor.cx_daily_energy_input') not in ['unknown', 'unavailable'] else 'âŒ' }} |
              | Monthly | {{ states('sensor.cx_monthly_energy_input') }} kWh | {{ 'âœ… <60000kWh' if states('sensor.cx_monthly_energy_input') | float(0) < 60000 else 'âŒ TOO HIGH - Corrupted' }} | {{ 'âœ…' if states('sensor.cx_monthly_energy_input') not in ['unknown', 'unavailable'] else 'âŒ' }} |

              **Data Flow:** Integration Sensors â†’ Utility Meters â†’ Reset on Cycle

          # CARD 5: HVAC DISTRIBUTION
          - type: markdown
            title: ğŸ  HVAC Distribution (hvac_sensors.yaml)
            grid_options:
              columns: full
            content: |
              ## Buffer Tank Sensors
              | Sensor | Value | Source | Status |
              |--------|-------|--------|--------|
              | Supply Temp | {{ states('sensor.hvac_buffer_tank_supply_temperature') }}Â°F | Shelly | {{ 'âœ…' if states('sensor.hvac_buffer_tank_supply_temperature') not in ['unknown', 'unavailable'] else 'âŒ' }} |
              | Return Temp | {{ states('sensor.hvac_buffer_tank_return_temperature') }}Â°F | Shelly | {{ 'âœ…' if states('sensor.hvac_buffer_tank_return_temperature') not in ['unknown', 'unavailable'] else 'âŒ' }} |
              | Delta T | {{ states('sensor.hvac_buffer_tank_delta_t') }}Â°F | Calculated | {{ 'âœ…' if states('sensor.hvac_buffer_tank_delta_t') not in ['unknown', 'unavailable'] else 'âŒ' }} |
              | Flow Rate | {{ states('sensor.hvac_buffer_tank_flow_rate') }} LPM | Hydronic | {{ 'âœ…' if states('sensor.hvac_buffer_tank_flow_rate') | float(0) > 0 else 'âš ï¸ Zero' }} |

              ## Thermal Power & Load
              | Sensor | Value | Formula | Status |
              |--------|-------|---------|--------|
              | HVAC Thermal Power | {{ states('sensor.hvac_thermal_power_used') }}W | Q = á¹ Ã— Cp Ã— Î”T | {{ 'âœ…' if states('sensor.hvac_thermal_power_used') not in ['unknown', 'unavailable'] else 'âŒ' }} |
              | House Heat Loss | {{ states('sensor.house_heat_loss_kw') }}kW | Same formula | {{ 'âœ…' if states('sensor.house_heat_loss_kw') not in ['unknown', 'unavailable'] else 'âŒ' }} |

              ## Distribution Efficiency
              | Metric | Value | Status |
              |--------|-------|--------|
              | HP Output | {{ (states('sensor.heat_pump_thermal_power_output') | float(0) / 1000) | round(2) }}kW | - |
              | HVAC Load | {{ (states('sensor.hvac_thermal_power_used') | float(0) / 1000) | round(2) }}kW | - |
              | Efficiency | {{ states('sensor.system_distribution_efficiency') }}% | {{ 'âœ… >80%' if states('sensor.system_distribution_efficiency') | float(0) > 80 else ('âš ï¸ Expected in Heat+DHW' if states('sensor.heat_pump_operating_mode') in ['Heat + DHW', 'HEAT + DHW'] else 'âŒ') }} |

              **Data Flow:** Buffer Tank Sensors â†’ HVAC Load â†’ Distribution Efficiency

          # CARD 5.5: G2 VALVE POSITION DETECTION (NEW)
          - type: markdown
            title: ğŸ”€ G2 Valve Position Detection (g2_valve_sensors.yaml)
            grid_options:
              columns: full
            content: |
              ## G2 Diverter Valve (Heat Routing)
              **Purpose:** Detects whether G2 valve is directing heat pump output to buffer tank (heating) or DHW tank

              | Sensor | Value | Detection Method |
              |--------|-------|------------------|
              | G2 Valve Position | {{ states('sensor.g2_valve_position') }} | Temperature rise analysis |
              | G2 DHW Mode Active | {{ states('binary_sensor.g2_valve_dhw_mode') }} | Binary state |

              ## Detection Logic (When HP Running)
              | Condition | Value | Indicates |
              |-----------|-------|-----------|
              | Compressor Running | {{ states('sensor.cx50_compressor_frequency') }}Hz | HP active |
              | Buffer Supply Temp | {{ states('sensor.hvac_buffer_tank_supply_temperature') }}Â°F | - |
              | Buffer Return Temp | {{ states('sensor.hvac_buffer_tank_return_temperature') }}Â°F | - |
              | Buffer Delta T | {{ (states('sensor.hvac_buffer_tank_supply_temperature') | float(0) - states('sensor.hvac_buffer_tank_return_temperature') | float(0)) | round(2) }}Â°F | {{ 'âœ… Heating Buffer' if (states('sensor.hvac_buffer_tank_supply_temperature') | float(0) - states('sensor.hvac_buffer_tank_return_temperature') | float(0)) > 1.0 else 'âš ï¸ Not heating buffer' }} |
              | HP Outlet Temp | {{ states('sensor.cx50_outlet_temp') }}Â°F | Heat pump output |

              **Logic:**
              - Buffer Î”T > 1.0Â°F + HP running â†’ **G2 to Buffer Tank (Heating)**
              - Buffer Î”T < 0.5Â°F + HP running â†’ **G2 to DHW Tank (DHW Mode)**

              **Why This Matters:**
              - Modbus operating mode may not reflect actual G2 valve position
              - Temperature-based detection shows where heat is ACTUALLY going
              - Helps explain low distribution efficiency during DHW cycles
              - Improves accuracy of heating vs DHW COP calculations

              **Data Flow:** HP Running + Buffer Temps â†’ G2 Position â†’ Mode Classification

          # CARD 6: OPTIMIZATION SENSORS
          - type: markdown
            title: ğŸ¯ Optimization Sensors (cx_optimization_sensors.yaml)
            grid_options:
              columns: full
            content: |
              ## Performance Metrics
              | Sensor | Value | Status |
              |--------|-------|--------|
              | Current COP | {{ states('sensor.heat_pump_cop') }} | {{ 'âœ… Good' if 1.5 < states('sensor.heat_pump_cop') | float(0) < 6 else 'N/A' }} |
              | Last Cycle COP | {{ states('sensor.heat_pump_last_cycle_cop') }} | {{ 'âœ…' if states('sensor.heat_pump_last_cycle_cop') not in ['unknown', 'unavailable'] else 'âš ï¸' }} |
              | Avg Steady State COP | {{ states('sensor.heat_pump_average_steady_state_cop') }} | {{ 'âœ…' if states('sensor.heat_pump_average_steady_state_cop') not in ['unknown', 'unavailable'] else 'âš ï¸ Needs cycles' }} |

              ## Binary Status Sensors
              | Sensor | State | Based On |
              |--------|-------|----------|
              | HP Running | {{ states('binary_sensor.heat_pump_running') }} | Power > 500W |
              | In Startup Phase | {{ states('binary_sensor.heat_pump_in_startup_phase') }} | Cycle < 180s |
              | Steady State | {{ states('binary_sensor.heat_pump_steady_state') }} | Cycle > 180s |
              | Last Cycle Short | {{ states('binary_sensor.heat_pump_last_cycle_was_short') }} | Last < 300s |

              **Data Flow:** Operating Mode â†’ Filter Power Sensors â†’ COP Tracking
