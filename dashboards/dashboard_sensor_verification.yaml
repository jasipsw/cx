title: Sensor Verification
views:
  - title: Sensor Verification
    path: sensor-verification
    icon: mdi:check-decagram
    badges: []
    cards:
      # OVERVIEW CARD
      - type: markdown
        title: ğŸ“‹ Sensor Verification Overview
        content: |
          ## Purpose
          This dashboard traces data flow through all sensor calculation layers to identify issues.

          ## Recent Changes (2025-11-12)
          - âœ… Created `sensor.cx_output_power_interval` (integration sensor for thermal energy)
          - âœ… Created cycle tracking sensors (current/last duration, cycle remaining)
          - âœ… Created `sensor.heat_pump_last_cycle_cop` (COP at cycle completion)
          - âœ… Fixed `radiant_sensors.yaml` template syntax errors
          - âœ… Improved heat pump running detection (pump + compressor + heat transfer)
          - âœ… Fixed water pump binary sensor (proper boolean values)
          - âœ… Added standby power tracking sensors
          - âœ… **NEW: G2 valve position detection** (temperature-based, shows actual heat routing)

          ## Known Issues
          - âš ï¸ Input energy utility meters have corrupted historical state (need reset)
          - âš ï¸ Modbus operating mode may not match actual G2 valve position (now detected by temperature analysis)

          ## Data Flow
          ```
          Modbus â†’ Raw Sensors (cx_sensors.yaml)
            â†“
          Calculated Power (electrical & thermal)
            â†“
          Integration Sensors (legacy_sensors.yaml) â†’ Energy (kWh)
            â†“
          Utility Meters (utility_meters.yaml) â†’ Hourly/Daily/Monthly
            â†“
          Optimization Sensors (cx_optimization_sensors.yaml) â†’ Mode filtering
          ```

          **Last Updated:** {{ now().strftime('%Y-%m-%d %H:%M:%S') }}

      # EVENT TIMELINE CARD
      - type: logbook
        title: ğŸ”” Heat Pump Event Timeline
        hours_to_show: 24
        entities:
          # Core state changes
          - binary_sensor.heat_pump_running
          - sensor.heat_pump_operating_mode

          # Cycle tracking
          - sensor.heat_pump_last_cycle_duration
          - sensor.heat_pump_last_cycle_cop

          # Phase transitions
          - binary_sensor.heat_pump_in_startup_phase
          - binary_sensor.heat_pump_steady_state
          - binary_sensor.heat_pump_last_cycle_was_short

          # Performance alerts
          - sensor.heat_pump_cop
          - sensor.heat_pump_efficiency_rating

          # Integration sensors (to see when they initialize)
          - sensor.cx_output_power_interval
          - sensor.cx_input_power_kwh

      # CARD 1: RAW HEAT PUMP SENSORS
      - type: markdown
        title: ğŸ”Œ Raw Heat Pump Sensors (cx_sensors.yaml)
        content: |
          ## Primary Inputs (Direct from Modbus)
          | Sensor | Value | Status |
          |--------|-------|--------|
          | Operating Mode | {{ states('sensor.heat_pump_operating_mode') }} | {{ 'âœ…' if states('sensor.heat_pump_operating_mode') not in ['unknown', 'unavailable'] else 'âŒ' }} |
          | Inlet Temp | {{ states('sensor.heat_pump_inlet_temperature') }}Â°F | {{ 'âœ…' if states('sensor.heat_pump_inlet_temperature') not in ['unknown', 'unavailable'] else 'âŒ' }} |
          | Outlet Temp | {{ states('sensor.heat_pump_outlet_temperature') }}Â°F | {{ 'âœ…' if states('sensor.heat_pump_outlet_temperature') not in ['unknown', 'unavailable'] else 'âŒ' }} |
          | Delta T | {{ states('sensor.heat_pump_delta_t') }}Â°F | {{ 'âœ…' if states('sensor.heat_pump_delta_t') not in ['unknown', 'unavailable'] else 'âŒ' }} |
          | Flow Rate | {{ states('sensor.cx50_pump_flow_gpm') }} GPM | {{ 'âœ…' if states('sensor.cx50_pump_flow_gpm') | float(0) > 0 else 'âš ï¸ Zero/Low' }} |
          | Flow Rate | {{ states('sensor.cx50_pump_flow_lpm') }} LPM | {{ 'âœ…' if states('sensor.cx50_pump_flow_lpm') | float(0) > 0 else 'âš ï¸ Zero/Low' }} |
          | AC Voltage | {{ states('sensor.cx50_input_ac_voltage') }}V | {{ 'âœ…' if states('sensor.cx50_input_ac_voltage') not in ['unknown', 'unavailable'] else 'âŒ' }} |
          | AC Current | {{ states('sensor.cx50_input_ac_current') }}A | {{ 'âœ…' if states('sensor.cx50_input_ac_current') not in ['unknown', 'unavailable'] else 'âŒ' }} |

          ## Calculated Power (V Ã— I)
          | Sensor | Value | Formula | Status |
          |--------|-------|---------|--------|
          | Electrical Input | {{ states('sensor.heat_pump_electrical_power_input') }}W | V Ã— I | {{ 'âœ…' if states('sensor.heat_pump_electrical_power_input') | float(0) > 0 or is_state('binary_sensor.heat_pump_running', 'off') else 'âš ï¸' }} |
          | Electrical Input | {{ states('sensor.heat_pump_electrical_power_input_kw') }}kW | / 1000 | {{ 'âœ…' if states('sensor.heat_pump_electrical_power_input_kw') not in ['unknown', 'unavailable'] else 'âŒ' }} |

          ## Calculated Thermal (Q = á¹ Ã— Cp Ã— Î”T)
          | Sensor | Value | Dependencies | Status |
          |--------|-------|--------------|--------|
          | Thermal Output | {{ states('sensor.heat_pump_thermal_power_output') }}W | Flow, Î”T, Cp, Ï | {{ 'âœ…' if states('sensor.heat_pump_thermal_power_output') not in ['unknown', 'unavailable'] else 'âŒ' }} |
          | Thermal (kW) | {{ states('sensor.heat_pump_thermal_power_kw') }}kW | Mode-filtered | {{ 'âœ…' if states('sensor.heat_pump_thermal_power_kw') not in ['unknown', 'unavailable'] else 'âŒ' }} |

          ## COP Calculation
          | Sensor | Value | Formula | Status |
          |--------|-------|---------|--------|
          | Current COP | {{ states('sensor.heat_pump_cop') }} | Thermal / Electrical | {{ 'âœ… Good (1.5-5.5)' if 1.5 < states('sensor.heat_pump_cop') | float(0) < 6 else ('N/A (off)' if is_state('binary_sensor.heat_pump_running', 'off') else 'âš ï¸') }} |
          | Efficiency Rating | {{ states('sensor.heat_pump_efficiency_rating') }} | COP â†’ Text | {{ 'âœ…' if states('sensor.heat_pump_efficiency_rating') != 'Unknown' else 'âš ï¸' }} |

          **Data Flow:** Modbus â†’ Raw Readings â†’ Power Calc (VÃ—I) â†’ Thermal Calc (Q=á¹CpÎ”T) â†’ COP

      # CARD 2: INTEGRATION SENSORS
      - type: markdown
        title: âš¡ Integration Sensors (legacy_sensors.yaml)
        content: |
          ## Integration Platform (Power â†’ Energy over time)
          | Sensor | Source | Value | Method | Status |
          |--------|--------|-------|--------|--------|
          | **CX Input Power kWh** | heat_pump_electrical_power_input (W) | {{ states('sensor.cx_input_power_kwh') }} kWh | Riemann (left) | {{ 'âœ… Accumulating' if states('sensor.cx_input_power_kwh') not in ['unknown', 'unavailable'] and states('sensor.cx_input_power_kwh') | float(-1) >= 0 else 'âŒ' }} |
          | **CX Output Power Interval** | heat_pump_thermal_power_output (W) | {{ states('sensor.cx_output_power_interval') }} kWh | Riemann (left) | {{ 'âœ… Accumulating' if states('sensor.cx_output_power_interval') not in ['unknown', 'unavailable'] and states('sensor.cx_output_power_interval') | float(-1) >= 0 else 'âŒ Not initialized yet' }} |

          ## Expected Relationship (Energy-Based COP)
          {% set input = states('sensor.cx_input_power_kwh') | float(0) %}
          {% set output = states('sensor.cx_output_power_interval') | float(0) %}
          {% if input > 1 and output > 0 %}
          | Metric | Value | Status |
          |--------|-------|--------|
          | Input Energy | {{ input | round(3) }} kWh | - |
          | Output Energy | {{ output | round(3) }} kWh | - |
          | **COP (Energy-based)** | **{{ (output / input) | round(2) }}** | {{ 'âœ… Reasonable (1.5-5.5)' if 1.5 < (output / input) < 6 else 'âš ï¸ Check values' }} |
          {% else %}
          **Status:** â³ Waiting for both sensors to accumulate (need > 1 kWh input)
          {% endif %}

          **Data Flow:** Power (W) â†’ Integration â†’ Energy (kWh) â†’ Utility Meters

          **Note:** Integration sensors created on 2025-11-12 to fix missing sensor definitions

      # CARD 3: CYCLE TRACKING SENSORS
      - type: markdown
        title: ğŸ”„ Cycle Tracking Sensors (heat_pump_cycle_sensors.yaml)
        content: |
          ## Binary Sensor Source (Improved Logic - 2025-11-12)
          | Sensor | Value | Based On |
          |--------|-------|----------|
          | Heat Pump Running | {{ states('binary_sensor.heat_pump_running') }} | **Pump ON** AND (**Compressor Running** OR **Heat Transfer**) |

          **Detection Logic:**
          - **Water Pump**: {{ states('binary_sensor.cx_c34_water_pump') }} (Modbus C34: {{ states('sensor.cx50_c34') }}, Flow: {{ states('sensor.cx50_pump_flow_lpm') }}L/min)
          - **Compressor Freq**: {{ states('sensor.cx50_compressor_frequency') }}Hz
          - **Thermal Output**: {{ (states('sensor.heat_pump_thermal_power_output') | float(0) / 1000) | round(1) }}kW

          **Water Pump Detection:** C34=1 OR Flow>1.0 L/min (validates actual circulation)
          **HP Running:** Pump ON AND (Freq>0 OR Thermal>1kW)

          ## Trigger-Based Cycle Sensors (NEW 2025-11-12)
          | Sensor | Value | Unit | Status |
          |--------|-------|------|--------|
          | Current Cycle Duration | {{ states('sensor.heat_pump_current_cycle_duration') }} | seconds | {{ 'âœ… Incrementing' if states('sensor.heat_pump_current_cycle_duration') | float(0) > 0 and is_state('binary_sensor.heat_pump_running', 'on') else ('âœ… Zero (off)' if is_state('binary_sensor.heat_pump_running', 'off') else 'âš ï¸') }} |
          | Current Cycle Duration | {{ states('sensor.heat_pump_current_cycle_duration_minutes') }} | minutes | {{ 'âœ… Matches' if ((states('sensor.heat_pump_current_cycle_duration') | float(0) / 60) | round(2) - states('sensor.heat_pump_current_cycle_duration_minutes') | float(0)) | abs < 0.1 else 'âš ï¸ Mismatch' }} |
          | Last Cycle Duration | {{ states('sensor.heat_pump_last_cycle_duration') }} | seconds | {{ 'âœ… Has data' if states('sensor.heat_pump_last_cycle_duration') | float(0) > 0 else 'âš ï¸ Waiting for cycle' }} |
          | Last Cycle COP | {{ states('sensor.heat_pump_last_cycle_cop') }} | - | {{ 'âœ… Captured' if states('sensor.heat_pump_last_cycle_cop') not in ['unknown', 'unavailable'] else 'âš ï¸ Waiting' }} |

          ## Standby Power Sensors (NEW 2025-11-12)
          | Sensor | Value | Unit | Status |
          |--------|-------|------|--------|
          | Current Standby Power | {{ states('sensor.heat_pump_standby_power') }} | W | {{ 'âœ… Tracking' if is_state('binary_sensor.heat_pump_running', 'off') else 'âœ… Preserved' }} |
          | Last Standby Power | {{ states('sensor.heat_pump_last_standby_power') }} | W | {{ 'âœ… Captured' if states('sensor.heat_pump_last_standby_power') | float(0) > 0 else 'âš ï¸ Waiting' }} |

          ## Cycle Phases (Calculated from Duration)
          | Sensor | Value | Formula | Expected When |
          |--------|-------|---------|---------------|
          | Startup Phase | {{ states('binary_sensor.heat_pump_in_startup_phase') }} | cycle < 180s | ON during first 3min |
          | Steady State | {{ states('binary_sensor.heat_pump_steady_state') }} | cycle > 180s | ON after 3min |
          | Last Cycle Short | {{ states('binary_sensor.heat_pump_last_cycle_was_short') }} | last < 300s | ON if < 5min cycle |

          **Data Flow:** binary_sensor.heat_pump_running â†’ Cycle Duration â†’ Binary States

      # CARD 4: UTILITY METERS
      - type: markdown
        title: ğŸ“Š Utility Meters (utility_meters.yaml)
        content: |
          ## Energy Output Meters (Source: cx_output_power_interval)
          | Meter | Value | Source Status | Meter Status |
          |-------|-------|---------------|--------------|
          | Hourly | {{ states('sensor.cx_hourly_energy_output') }} kWh | {{ 'âœ…' if states('sensor.cx_output_power_interval') not in ['unknown', 'unavailable'] else 'âŒ Source unavailable' }} | {{ 'âœ…' if states('sensor.cx_hourly_energy_output') not in ['unknown', 'unavailable'] else 'âŒ' }} |
          | Daily | {{ states('sensor.cx_daily_energy_output') }} kWh | {{ 'âœ…' if states('sensor.cx_output_power_interval') not in ['unknown', 'unavailable'] else 'âŒ Source unavailable' }} | {{ 'âœ…' if states('sensor.cx_daily_energy_output') not in ['unknown', 'unavailable'] else 'âŒ' }} |
          | Monthly | {{ states('sensor.cx_monthly_energy_output') }} kWh | {{ 'âœ…' if states('sensor.cx_output_power_interval') not in ['unknown', 'unavailable'] else 'âŒ Source unavailable' }} | {{ 'âœ…' if states('sensor.cx_monthly_energy_output') not in ['unknown', 'unavailable'] else 'âŒ' }} |

          ## Energy Input Meters (Source: cx_input_power_kwh)
          | Meter | Value | Sanity Check | Status |
          |-------|-------|--------------|--------|
          | Hourly | {{ states('sensor.cx_hourly_energy_input') }} kWh | {{ 'âœ… <100kWh' if states('sensor.cx_hourly_energy_input') | float(0) < 100 else 'âŒ TOO HIGH - Corrupted' }} | {{ 'âœ…' if states('sensor.cx_hourly_energy_input') not in ['unknown', 'unavailable'] else 'âŒ' }} |
          | Daily | {{ states('sensor.cx_daily_energy_input') }} kWh | {{ 'âœ… <2000kWh' if states('sensor.cx_daily_energy_input') | float(0) < 2000 else 'âŒ TOO HIGH - Corrupted' }} | {{ 'âœ…' if states('sensor.cx_daily_energy_input') not in ['unknown', 'unavailable'] else 'âŒ' }} |
          | Monthly | {{ states('sensor.cx_monthly_energy_input') }} kWh | {{ 'âœ… <60000kWh' if states('sensor.cx_monthly_energy_input') | float(0) < 60000 else 'âŒ TOO HIGH - Corrupted' }} | {{ 'âœ…' if states('sensor.cx_monthly_energy_input') not in ['unknown', 'unavailable'] else 'âŒ' }} |

          **Data Flow:** Integration Sensors â†’ Utility Meters â†’ Reset on Cycle

      # CARD 5: HVAC DISTRIBUTION
      - type: markdown
        title: ğŸ  HVAC Distribution (hvac_sensors.yaml)
        content: |
          ## Buffer Tank Sensors
          | Sensor | Value | Source | Status |
          |--------|-------|--------|--------|
          | Supply Temp | {{ states('sensor.hvac_buffer_tank_supply_temperature') }}Â°F | Shelly | {{ 'âœ…' if states('sensor.hvac_buffer_tank_supply_temperature') not in ['unknown', 'unavailable'] else 'âŒ' }} |
          | Return Temp | {{ states('sensor.hvac_buffer_tank_return_temperature') }}Â°F | Shelly | {{ 'âœ…' if states('sensor.hvac_buffer_tank_return_temperature') not in ['unknown', 'unavailable'] else 'âŒ' }} |
          | Delta T | {{ states('sensor.hvac_buffer_tank_delta_t') }}Â°F | Calculated | {{ 'âœ…' if states('sensor.hvac_buffer_tank_delta_t') not in ['unknown', 'unavailable'] else 'âŒ' }} |
          | Flow Rate | {{ states('sensor.hvac_buffer_tank_flow_rate') }} LPM | Hydronic | {{ 'âœ…' if states('sensor.hvac_buffer_tank_flow_rate') | float(0) > 0 else 'âš ï¸ Zero' }} |

          ## Thermal Power & Load
          | Sensor | Value | Formula | Status |
          |--------|-------|---------|--------|
          | HVAC Thermal Power | {{ states('sensor.hvac_thermal_power_used') }}W | Q = á¹ Ã— Cp Ã— Î”T | {{ 'âœ…' if states('sensor.hvac_thermal_power_used') not in ['unknown', 'unavailable'] else 'âŒ' }} |
          | House Heat Loss | {{ states('sensor.house_heat_loss_kw') }}kW | Same formula | {{ 'âœ…' if states('sensor.house_heat_loss_kw') not in ['unknown', 'unavailable'] else 'âŒ' }} |

          ## Distribution Efficiency
          | Metric | Value | Status |
          |--------|-------|--------|
          | HP Output | {{ (states('sensor.heat_pump_thermal_power_output') | float(0) / 1000) | round(2) }}kW | - |
          | HVAC Load | {{ (states('sensor.hvac_thermal_power_used') | float(0) / 1000) | round(2) }}kW | - |
          | Efficiency | {{ states('sensor.system_distribution_efficiency') }}% | {{ 'âœ… >80%' if states('sensor.system_distribution_efficiency') | float(0) > 80 else ('âš ï¸ Expected in Heat+DHW' if states('sensor.heat_pump_operating_mode') in ['Heat + DHW', 'HEAT + DHW'] else 'âŒ') }} |

          **Data Flow:** Buffer Tank Sensors â†’ HVAC Load â†’ Distribution Efficiency

      # CARD 5.5: G2 VALVE POSITION DETECTION (NEW)
      - type: markdown
        title: ğŸ”€ G2 Valve Position Detection (g2_valve_sensors.yaml)
        content: |
          ## G2 Diverter Valve (Heat Routing)
          **Purpose:** Detects whether G2 valve is directing heat pump output to buffer tank (heating) or DHW tank

          | Sensor | Value | Detection Method |
          |--------|-------|------------------|
          | G2 Valve Position | {{ states('sensor.g2_valve_position') }} | Temperature rise analysis |
          | G2 DHW Mode Active | {{ states('binary_sensor.g2_valve_dhw_mode') }} | Binary state |

          ## Detection Logic (When HP Running)
          | Condition | Value | Indicates |
          |-----------|-------|-----------|
          | Compressor Running | {{ states('sensor.cx50_compressor_frequency') }}Hz | HP active |
          | Buffer Supply Temp | {{ states('sensor.hvac_buffer_tank_supply_temperature') }}Â°F | - |
          | Buffer Return Temp | {{ states('sensor.hvac_buffer_tank_return_temperature') }}Â°F | - |
          | Buffer Delta T | {{ (states('sensor.hvac_buffer_tank_supply_temperature') | float(0) - states('sensor.hvac_buffer_tank_return_temperature') | float(0)) | round(2) }}Â°F | {{ 'âœ… Heating Buffer' if (states('sensor.hvac_buffer_tank_supply_temperature') | float(0) - states('sensor.hvac_buffer_tank_return_temperature') | float(0)) > 1.0 else 'âš ï¸ Not heating buffer' }} |
          | HP Outlet Temp | {{ states('sensor.cx50_outlet_temp') }}Â°F | Heat pump output |

          **Logic:**
          - Buffer Î”T > 1.0Â°F + HP running â†’ **G2 to Buffer Tank (Heating)**
          - Buffer Î”T < 0.5Â°F + HP running â†’ **G2 to DHW Tank (DHW Mode)**

          **Why This Matters:**
          - Modbus operating mode may not reflect actual G2 valve position
          - Temperature-based detection shows where heat is ACTUALLY going
          - Helps explain low distribution efficiency during DHW cycles
          - Improves accuracy of heating vs DHW COP calculations

          **Data Flow:** HP Running + Buffer Temps â†’ G2 Position â†’ Mode Classification

      # CARD 6: OPTIMIZATION SENSORS
      - type: markdown
        title: ğŸ¯ Optimization Sensors (cx_optimization_sensors.yaml)
        content: |
          ## Performance Metrics
          | Sensor | Value | Status |
          |--------|-------|--------|
          | Current COP | {{ states('sensor.heat_pump_cop') }} | {{ 'âœ… Good' if 1.5 < states('sensor.heat_pump_cop') | float(0) < 6 else 'N/A' }} |
          | Last Cycle COP | {{ states('sensor.heat_pump_last_cycle_cop') }} | {{ 'âœ…' if states('sensor.heat_pump_last_cycle_cop') not in ['unknown', 'unavailable'] else 'âš ï¸' }} |
          | Avg Steady State COP | {{ states('sensor.heat_pump_average_steady_state_cop') }} | {{ 'âœ…' if states('sensor.heat_pump_average_steady_state_cop') not in ['unknown', 'unavailable'] else 'âš ï¸ Needs cycles' }} |

          ## Binary Status Sensors
          | Sensor | State | Based On |
          |--------|-------|----------|
          | HP Running | {{ states('binary_sensor.heat_pump_running') }} | Power > 500W |
          | In Startup Phase | {{ states('binary_sensor.heat_pump_in_startup_phase') }} | Cycle < 180s |
          | Steady State | {{ states('binary_sensor.heat_pump_steady_state') }} | Cycle > 180s |
          | Last Cycle Short | {{ states('binary_sensor.heat_pump_last_cycle_was_short') }} | Last < 300s |

          **Data Flow:** Operating Mode â†’ Filter Power Sensors â†’ COP Tracking
