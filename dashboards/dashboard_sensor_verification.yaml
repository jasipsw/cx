title: Sensor Verification
views:
  - title: Sensor Verification
    path: sensor-verification
    icon: mdi:check-decagram
    badges: []
    cards:
      # OVERVIEW CARD
      - type: markdown
        title: üìã Sensor Verification Overview
        content: |
          ## Purpose
          This dashboard traces data flow through all sensor calculation layers to identify issues.

          ## Recent Changes (2025-11-12)
          - ‚úÖ Created `sensor.cx_output_power_interval` (integration sensor for thermal energy)
          - ‚úÖ Created cycle tracking sensors (current/last duration, cycle remaining)
          - ‚úÖ Created `sensor.heat_pump_last_cycle_cop` (COP at cycle completion)
          - ‚úÖ Fixed `radiant_sensors.yaml` template syntax errors

          ## Known Issues
          - ‚ö†Ô∏è Input energy utility meters have corrupted historical state (need reset)
          - ‚ö†Ô∏è Distribution efficiency shows low when in "Heat + DHW" mode (expected - energy goes to hot water)

          ## Data Flow
          ```
          Modbus ‚Üí Raw Sensors (cx_sensors.yaml)
            ‚Üì
          Calculated Power (electrical & thermal)
            ‚Üì
          Integration Sensors (legacy_sensors.yaml) ‚Üí Energy (kWh)
            ‚Üì
          Utility Meters (utility_meters.yaml) ‚Üí Hourly/Daily/Monthly
            ‚Üì
          Optimization Sensors (cx_optimization_sensors.yaml) ‚Üí Mode filtering
          ```

          **Last Updated:** {{ now().strftime('%Y-%m-%d %H:%M:%S') }}

      # EVENT TIMELINE CARD
      - type: logbook
        title: üîî Heat Pump Event Timeline
        hours_to_show: 24
        entities:
          # Core state changes
          - binary_sensor.heat_pump_running
          - sensor.heat_pump_operating_mode

          # Cycle tracking
          - sensor.heat_pump_last_cycle_duration
          - sensor.heat_pump_last_cycle_cop

          # Phase transitions
          - binary_sensor.heat_pump_in_startup_phase
          - binary_sensor.heat_pump_steady_state
          - binary_sensor.heat_pump_last_cycle_was_short

          # Performance alerts
          - sensor.heat_pump_cop
          - sensor.heat_pump_efficiency_rating

          # Integration sensors (to see when they initialize)
          - sensor.cx_output_power_interval
          - sensor.cx_input_power_kwh

      # CARD 1: RAW HEAT PUMP SENSORS
      - type: markdown
        title: üîå Raw Heat Pump Sensors (cx_sensors.yaml)
        content: |
          ## Primary Inputs (Direct from Modbus)
          | Sensor | Value | Status |
          |--------|-------|--------|
          | Operating Mode | {{ states('sensor.heat_pump_operating_mode') }} | {{ '‚úÖ' if states('sensor.heat_pump_operating_mode') not in ['unknown', 'unavailable'] else '‚ùå' }} |
          | Inlet Temp | {{ states('sensor.heat_pump_inlet_temperature') }}¬∞F | {{ '‚úÖ' if states('sensor.heat_pump_inlet_temperature') not in ['unknown', 'unavailable'] else '‚ùå' }} |
          | Outlet Temp | {{ states('sensor.heat_pump_outlet_temperature') }}¬∞F | {{ '‚úÖ' if states('sensor.heat_pump_outlet_temperature') not in ['unknown', 'unavailable'] else '‚ùå' }} |
          | Delta T | {{ states('sensor.heat_pump_delta_t') }}¬∞F | {{ '‚úÖ' if states('sensor.heat_pump_delta_t') not in ['unknown', 'unavailable'] else '‚ùå' }} |
          | Flow Rate | {{ states('sensor.cx50_pump_flow_gpm') }} GPM | {{ '‚úÖ' if states('sensor.cx50_pump_flow_gpm') | float(0) > 0 else '‚ö†Ô∏è Zero/Low' }} |
          | Flow Rate | {{ states('sensor.cx50_pump_flow_lpm') }} LPM | {{ '‚úÖ' if states('sensor.cx50_pump_flow_lpm') | float(0) > 0 else '‚ö†Ô∏è Zero/Low' }} |
          | AC Voltage | {{ states('sensor.cx50_input_ac_voltage') }}V | {{ '‚úÖ' if states('sensor.cx50_input_ac_voltage') not in ['unknown', 'unavailable'] else '‚ùå' }} |
          | AC Current | {{ states('sensor.cx50_input_ac_current') }}A | {{ '‚úÖ' if states('sensor.cx50_input_ac_current') not in ['unknown', 'unavailable'] else '‚ùå' }} |

          ## Calculated Power (V √ó I)
          | Sensor | Value | Formula | Status |
          |--------|-------|---------|--------|
          | Electrical Input | {{ states('sensor.heat_pump_electrical_power_input') }}W | V √ó I | {{ '‚úÖ' if states('sensor.heat_pump_electrical_power_input') | float(0) > 0 or is_state('binary_sensor.heat_pump_running', 'off') else '‚ö†Ô∏è' }} |
          | Electrical Input | {{ states('sensor.heat_pump_electrical_power_input_kw') }}kW | / 1000 | {{ '‚úÖ' if states('sensor.heat_pump_electrical_power_input_kw') not in ['unknown', 'unavailable'] else '‚ùå' }} |

          ## Calculated Thermal (Q = ·πÅ √ó Cp √ó ŒîT)
          | Sensor | Value | Dependencies | Status |
          |--------|-------|--------------|--------|
          | Thermal Output | {{ states('sensor.heat_pump_thermal_power_output') }}W | Flow, ŒîT, Cp, œÅ | {{ '‚úÖ' if states('sensor.heat_pump_thermal_power_output') not in ['unknown', 'unavailable'] else '‚ùå' }} |
          | Thermal (kW) | {{ states('sensor.heat_pump_thermal_power_kw') }}kW | Mode-filtered | {{ '‚úÖ' if states('sensor.heat_pump_thermal_power_kw') not in ['unknown', 'unavailable'] else '‚ùå' }} |

          ## COP Calculation
          | Sensor | Value | Formula | Status |
          |--------|-------|---------|--------|
          | Current COP | {{ states('sensor.heat_pump_cop') }} | Thermal / Electrical | {{ '‚úÖ Good (1.5-5.5)' if 1.5 < states('sensor.heat_pump_cop') | float(0) < 6 else ('N/A (off)' if is_state('binary_sensor.heat_pump_running', 'off') else '‚ö†Ô∏è') }} |
          | Efficiency Rating | {{ states('sensor.heat_pump_efficiency_rating') }} | COP ‚Üí Text | {{ '‚úÖ' if states('sensor.heat_pump_efficiency_rating') != 'Unknown' else '‚ö†Ô∏è' }} |

          **Data Flow:** Modbus ‚Üí Raw Readings ‚Üí Power Calc (V√óI) ‚Üí Thermal Calc (Q=·πÅCpŒîT) ‚Üí COP

      # CARD 2: INTEGRATION SENSORS
      - type: markdown
        title: ‚ö° Integration Sensors (legacy_sensors.yaml)
        content: |
          ## Integration Platform (Power ‚Üí Energy over time)
          | Sensor | Source | Value | Method | Status |
          |--------|--------|-------|--------|--------|
          | **CX Input Power kWh** | heat_pump_electrical_power_input (W) | {{ states('sensor.cx_input_power_kwh') }} kWh | Riemann (left) | {{ '‚úÖ Accumulating' if states('sensor.cx_input_power_kwh') not in ['unknown', 'unavailable'] and states('sensor.cx_input_power_kwh') | float(-1) >= 0 else '‚ùå' }} |
          | **CX Output Power Interval** | heat_pump_thermal_power_output (W) | {{ states('sensor.cx_output_power_interval') }} kWh | Riemann (left) | {{ '‚úÖ Accumulating' if states('sensor.cx_output_power_interval') not in ['unknown', 'unavailable'] and states('sensor.cx_output_power_interval') | float(-1) >= 0 else '‚ùå Not initialized yet' }} |

          ## Expected Relationship (Energy-Based COP)
          {% set input = states('sensor.cx_input_power_kwh') | float(0) %}
          {% set output = states('sensor.cx_output_power_interval') | float(0) %}
          {% if input > 1 and output > 0 %}
          | Metric | Value | Status |
          |--------|-------|--------|
          | Input Energy | {{ input | round(3) }} kWh | - |
          | Output Energy | {{ output | round(3) }} kWh | - |
          | **COP (Energy-based)** | **{{ (output / input) | round(2) }}** | {{ '‚úÖ Reasonable (1.5-5.5)' if 1.5 < (output / input) < 6 else '‚ö†Ô∏è Check values' }} |
          {% else %}
          **Status:** ‚è≥ Waiting for both sensors to accumulate (need > 1 kWh input)
          {% endif %}

          **Data Flow:** Power (W) ‚Üí Integration ‚Üí Energy (kWh) ‚Üí Utility Meters

          **Note:** Integration sensors created on 2025-11-12 to fix missing sensor definitions

      # CARD 3: CYCLE TRACKING SENSORS
      - type: markdown
        title: üîÑ Cycle Tracking Sensors (heat_pump_cycle_sensors.yaml)
        content: |
          ## Binary Sensor Source
          | Sensor | Value | Based On |
          |--------|-------|----------|
          | Heat Pump Running | {{ states('binary_sensor.heat_pump_running') }} | Power > 500W |

          ## Trigger-Based Cycle Sensors (NEW 2025-11-12)
          | Sensor | Value | Unit | Status |
          |--------|-------|------|--------|
          | Current Cycle Duration | {{ states('sensor.heat_pump_current_cycle_duration') }} | seconds | {{ '‚úÖ Incrementing' if states('sensor.heat_pump_current_cycle_duration') | float(0) > 0 and is_state('binary_sensor.heat_pump_running', 'on') else ('‚úÖ Zero (off)' if is_state('binary_sensor.heat_pump_running', 'off') else '‚ö†Ô∏è') }} |
          | Current Cycle Duration | {{ states('sensor.heat_pump_current_cycle_duration_minutes') }} | minutes | {{ '‚úÖ Matches' if ((states('sensor.heat_pump_current_cycle_duration') | float(0) / 60) | round(2) - states('sensor.heat_pump_current_cycle_duration_minutes') | float(0)) | abs < 0.1 else '‚ö†Ô∏è Mismatch' }} |
          | Last Cycle Duration | {{ states('sensor.heat_pump_last_cycle_duration') }} | seconds | {{ '‚úÖ Has data' if states('sensor.heat_pump_last_cycle_duration') | float(0) > 0 else '‚ö†Ô∏è Waiting for cycle' }} |
          | Last Cycle COP | {{ states('sensor.heat_pump_last_cycle_cop') }} | - | {{ '‚úÖ Captured' if states('sensor.heat_pump_last_cycle_cop') not in ['unknown', 'unavailable'] else '‚ö†Ô∏è Waiting' }} |

          ## Cycle Phases (Calculated from Duration)
          | Sensor | Value | Formula | Expected When |
          |--------|-------|---------|---------------|
          | Startup Phase | {{ states('binary_sensor.heat_pump_in_startup_phase') }} | cycle < 180s | ON during first 3min |
          | Steady State | {{ states('binary_sensor.heat_pump_steady_state') }} | cycle > 180s | ON after 3min |
          | Last Cycle Short | {{ states('binary_sensor.heat_pump_last_cycle_was_short') }} | last < 300s | ON if < 5min cycle |

          **Data Flow:** binary_sensor.heat_pump_running ‚Üí Cycle Duration ‚Üí Binary States

      # CARD 4: UTILITY METERS
      - type: markdown
        title: üìä Utility Meters (utility_meters.yaml)
        content: |
          ## Energy Output Meters (Source: cx_output_power_interval)
          | Meter | Value | Source Status | Meter Status |
          |-------|-------|---------------|--------------|
          | Hourly | {{ states('sensor.cx_hourly_energy_output') }} kWh | {{ '‚úÖ' if states('sensor.cx_output_power_interval') not in ['unknown', 'unavailable'] else '‚ùå Source unavailable' }} | {{ '‚úÖ' if states('sensor.cx_hourly_energy_output') not in ['unknown', 'unavailable'] else '‚ùå' }} |
          | Daily | {{ states('sensor.cx_daily_energy_output') }} kWh | {{ '‚úÖ' if states('sensor.cx_output_power_interval') not in ['unknown', 'unavailable'] else '‚ùå Source unavailable' }} | {{ '‚úÖ' if states('sensor.cx_daily_energy_output') not in ['unknown', 'unavailable'] else '‚ùå' }} |
          | Monthly | {{ states('sensor.cx_monthly_energy_output') }} kWh | {{ '‚úÖ' if states('sensor.cx_output_power_interval') not in ['unknown', 'unavailable'] else '‚ùå Source unavailable' }} | {{ '‚úÖ' if states('sensor.cx_monthly_energy_output') not in ['unknown', 'unavailable'] else '‚ùå' }} |

          ## Energy Input Meters (Source: cx_input_power_kwh)
          | Meter | Value | Sanity Check | Status |
          |-------|-------|--------------|--------|
          | Hourly | {{ states('sensor.cx_hourly_energy_input') }} kWh | {{ '‚úÖ <100kWh' if states('sensor.cx_hourly_energy_input') | float(0) < 100 else '‚ùå TOO HIGH - Corrupted' }} | {{ '‚úÖ' if states('sensor.cx_hourly_energy_input') not in ['unknown', 'unavailable'] else '‚ùå' }} |
          | Daily | {{ states('sensor.cx_daily_energy_input') }} kWh | {{ '‚úÖ <2000kWh' if states('sensor.cx_daily_energy_input') | float(0) < 2000 else '‚ùå TOO HIGH - Corrupted' }} | {{ '‚úÖ' if states('sensor.cx_daily_energy_input') not in ['unknown', 'unavailable'] else '‚ùå' }} |
          | Monthly | {{ states('sensor.cx_monthly_energy_input') }} kWh | {{ '‚úÖ <60000kWh' if states('sensor.cx_monthly_energy_input') | float(0) < 60000 else '‚ùå TOO HIGH - Corrupted' }} | {{ '‚úÖ' if states('sensor.cx_monthly_energy_input') not in ['unknown', 'unavailable'] else '‚ùå' }} |

          **Data Flow:** Integration Sensors ‚Üí Utility Meters ‚Üí Reset on Cycle

      # CARD 5: HVAC DISTRIBUTION
      - type: markdown
        title: üè† HVAC Distribution (hvac_sensors.yaml)
        content: |
          ## Buffer Tank Sensors
          | Sensor | Value | Source | Status |
          |--------|-------|--------|--------|
          | Supply Temp | {{ states('sensor.hvac_buffer_tank_supply_temperature') }}¬∞F | Shelly | {{ '‚úÖ' if states('sensor.hvac_buffer_tank_supply_temperature') not in ['unknown', 'unavailable'] else '‚ùå' }} |
          | Return Temp | {{ states('sensor.hvac_buffer_tank_return_temperature') }}¬∞F | Shelly | {{ '‚úÖ' if states('sensor.hvac_buffer_tank_return_temperature') not in ['unknown', 'unavailable'] else '‚ùå' }} |
          | Delta T | {{ states('sensor.hvac_buffer_tank_delta_t') }}¬∞F | Calculated | {{ '‚úÖ' if states('sensor.hvac_buffer_tank_delta_t') not in ['unknown', 'unavailable'] else '‚ùå' }} |
          | Flow Rate | {{ states('sensor.hvac_buffer_tank_flow_rate') }} LPM | Hydronic | {{ '‚úÖ' if states('sensor.hvac_buffer_tank_flow_rate') | float(0) > 0 else '‚ö†Ô∏è Zero' }} |

          ## Thermal Power & Load
          | Sensor | Value | Formula | Status |
          |--------|-------|---------|--------|
          | HVAC Thermal Power | {{ states('sensor.hvac_thermal_power_used') }}W | Q = ·πÅ √ó Cp √ó ŒîT | {{ '‚úÖ' if states('sensor.hvac_thermal_power_used') not in ['unknown', 'unavailable'] else '‚ùå' }} |
          | House Heat Loss | {{ states('sensor.house_heat_loss_kw') }}kW | Same formula | {{ '‚úÖ' if states('sensor.house_heat_loss_kw') not in ['unknown', 'unavailable'] else '‚ùå' }} |

          ## Distribution Efficiency
          | Metric | Value | Status |
          |--------|-------|--------|
          | HP Output | {{ (states('sensor.heat_pump_thermal_power_output') | float(0) / 1000) | round(2) }}kW | - |
          | HVAC Load | {{ (states('sensor.hvac_thermal_power_used') | float(0) / 1000) | round(2) }}kW | - |
          | Efficiency | {{ states('sensor.system_distribution_efficiency') }}% | {{ '‚úÖ >80%' if states('sensor.system_distribution_efficiency') | float(0) > 80 else ('‚ö†Ô∏è Expected in Heat+DHW' if states('sensor.heat_pump_operating_mode') in ['Heat + DHW', 'HEAT + DHW'] else '‚ùå') }} |

          **Data Flow:** Buffer Tank Sensors ‚Üí HVAC Load ‚Üí Distribution Efficiency

      # CARD 6: OPTIMIZATION SENSORS
      - type: markdown
        title: üéØ Optimization Sensors (cx_optimization_sensors.yaml)
        content: |
          ## Performance Metrics
          | Sensor | Value | Status |
          |--------|-------|--------|
          | Current COP | {{ states('sensor.heat_pump_cop') }} | {{ '‚úÖ Good' if 1.5 < states('sensor.heat_pump_cop') | float(0) < 6 else 'N/A' }} |
          | Last Cycle COP | {{ states('sensor.heat_pump_last_cycle_cop') }} | {{ '‚úÖ' if states('sensor.heat_pump_last_cycle_cop') not in ['unknown', 'unavailable'] else '‚ö†Ô∏è' }} |
          | Avg Steady State COP | {{ states('sensor.heat_pump_average_steady_state_cop') }} | {{ '‚úÖ' if states('sensor.heat_pump_average_steady_state_cop') not in ['unknown', 'unavailable'] else '‚ö†Ô∏è Needs cycles' }} |

          ## Binary Status Sensors
          | Sensor | State | Based On |
          |--------|-------|----------|
          | HP Running | {{ states('binary_sensor.heat_pump_running') }} | Power > 500W |
          | In Startup Phase | {{ states('binary_sensor.heat_pump_in_startup_phase') }} | Cycle < 180s |
          | Steady State | {{ states('binary_sensor.heat_pump_steady_state') }} | Cycle > 180s |
          | Last Cycle Short | {{ states('binary_sensor.heat_pump_last_cycle_was_short') }} | Last < 300s |

          **Data Flow:** Operating Mode ‚Üí Filter Power Sensors ‚Üí COP Tracking
