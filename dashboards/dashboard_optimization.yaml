# CX50 Heat Pump Optimization Dashboard
# Purpose: Consolidated single-view dashboard for heat pump optimization monitoring
# Focus: Actionable insights, progress tracking, and real-time optimization metrics

title: Heat Pump Optimization
views:
  - title: Optimization Overview
    path: optimization-overview
    icon: mdi:speedometer
    badges: []
    cards:
      # ========================================================================
      # HEADER - Optimization Goal
      # ========================================================================
      - type: markdown
        content: |
          # ğŸ¯ Heat Pump Optimization Dashboard

          **Mission:** Improve COP from 2.0-2.5 â†’ **4.55** (manufacturer rating)

          **Root Cause:** Short cycling with high startup penalties

          ---

      # ========================================================================
      # KPI OVERVIEW - Key Performance Indicators
      # ========================================================================
      - type: horizontal-stack
        cards:
          - type: gauge
            entity: sensor.heat_pump_cop
            name: Current COP
            min: 0
            max: 6
            needle: true
            severity:
              green: 4.0
              yellow: 3.0
              red: 0
            segments:
              - from: 0
                color: '#db4437'
              - from: 3.0
                color: '#ff9800'
              - from: 4.0
                color: '#0f9d58'

          - type: gauge
            entity: sensor.heat_pump_cycle_efficiency
            name: Efficiency vs Target
            unit: "%"
            min: 0
            max: 100
            needle: true
            severity:
              green: 85
              yellow: 60
              red: 0

      # ========================================================================
      # KPI CARDS ROW 1
      # ========================================================================
      - type: horizontal-stack
        cards:
          - type: custom:mushroom-entity-card
            entity: sensor.heat_pump_cop
            name: Current COP
            icon: mdi:gauge
            primary_info: state
            secondary_info: name
            icon_color: >
              {% if states('sensor.heat_pump_cop') | float >= 4.0 %}
                green
              {% elif states('sensor.heat_pump_cop') | float >= 3.0 %}
                orange
              {% else %}
                red
              {% endif %}

          - type: custom:mushroom-entity-card
            entity: sensor.heat_pump_cop_improvement_needed
            name: COP Gap to Target
            icon: mdi:target
            primary_info: state
            secondary_info: name
            icon_color: >
              {% if states('sensor.heat_pump_cop_improvement_needed') | float <= 0.5 %}
                green
              {% elif states('sensor.heat_pump_cop_improvement_needed') | float <= 1.5 %}
                orange
              {% else %}
                red
              {% endif %}

          - type: custom:mushroom-entity-card
            entity: sensor.heat_pump_current_cycle_duration_minutes
            name: Current Runtime
            icon: mdi:timer-outline
            primary_info: state
            secondary_info: name
            icon_color: >
              {% if states('sensor.heat_pump_current_cycle_duration_minutes') | float >= 15 %}
                green
              {% elif states('sensor.heat_pump_current_cycle_duration_minutes') | float >= 10 %}
                orange
              {% else %}
                red
              {% endif %}

          - type: custom:mushroom-entity-card
            entity: sensor.heat_pump_daily_runtime_hours
            name: Today's Runtime
            icon: mdi:clock-time-eight-outline
            primary_info: state
            secondary_info: name
            icon_color: blue

      # ========================================================================
      # 3-PHASE PROGRESS TRACKER
      # ========================================================================
      - type: markdown
        content: |
          ## ğŸ“Š Optimization Phase Progress

      - type: entities
        title: Phase 1 - Buffer Differential Optimization
        show_header_toggle: false
        entities:
          - type: custom:bar-card
            entity: input_number.buffer_differential_target
            name: Buffer Differential Target
            min: 10
            max: 18
            target: 18
            unit: "Â°F"
            severity:
              - from: 10
                to: 14
                color: '#db4437'
              - from: 14
                to: 17
                color: '#ff9800'
              - from: 17
                to: 18
                color: '#0f9d58'
          - entity: sensor.hvac_buffer_tank_delta_t
            name: Current Buffer Delta T
          - type: custom:template-entity-row
            name: Phase 1 Status
            state: >
              {% if states('sensor.hvac_buffer_tank_delta_t') | float >= 18 %}
                âœ… Complete
              {% elif states('sensor.hvac_buffer_tank_delta_t') | float >= 14 %}
                ğŸ”„ In Progress
              {% else %}
                â³ Not Started
              {% endif %}

      - type: entities
        title: Phase 2 - Supply Temperature Reduction
        show_header_toggle: false
        entities:
          - type: custom:bar-card
            entity: input_number.heat_pump_supply_temp_target
            name: Supply Temperature Target
            min: 85
            max: 90
            target: 85
            direction: down
            unit: "Â°F"
            severity:
              - from: 85
                to: 87
                color: '#0f9d58'
              - from: 87
                to: 89
                color: '#ff9800'
              - from: 89
                to: 90
                color: '#db4437'
          - entity: sensor.heat_pump_outlet_temperature
            name: Current Supply Temperature
          - type: custom:template-entity-row
            name: Phase 2 Status
            state: >
              {% if states('sensor.heat_pump_outlet_temperature') | float <= 85 %}
                âœ… Complete
              {% elif states('sensor.heat_pump_outlet_temperature') | float <= 87 %}
                ğŸ”„ In Progress
              {% else %}
                â³ Not Started
              {% endif %}

      - type: entities
        title: Phase 3 - Fine-Tune to Optimal
        show_header_toggle: false
        entities:
          - type: attribute
            entity: input_select.optimization_phase
            attribute: current_phase
            name: Current Optimization Phase
          - entity: number.cx50_heating_setpoint_c
            name: Heating Setpoint (Target 82Â°F / 27.8Â°C)
          - type: custom:template-entity-row
            name: Phase 3 Status
            state: >
              {% if states('sensor.heat_pump_outlet_temperature') | float <= 83 and states('sensor.heat_pump_cop') | float >= 4.0 %}
                âœ… Complete
              {% elif states('sensor.heat_pump_outlet_temperature') | float <= 85 %}
                ğŸ”„ In Progress
              {% else %}
                â³ Not Started
              {% endif %}

      # ========================================================================
      # ACTIONABLE ALERTS & RECOMMENDATIONS
      # ========================================================================
      - type: markdown
        content: |
          ## âš ï¸ Active Alerts & Recommendations

      - type: entities
        title: System Status Alerts
        show_header_toggle: false
        state_color: true
        entities:
          - entity: binary_sensor.heat_pump_running
            name: Heat Pump Status
            icon: mdi:heat-pump
          - entity: sensor.heat_pump_short_cycle_alert
            name: Short Cycle Alert
            icon: mdi:alert-circle
          - entity: sensor.heat_pump_cycle_ratio_warning
            name: Cycle Ratio Status
            icon: mdi:information-outline
          - entity: binary_sensor.circulator_running_hp_off
            name: Standby Circulation Loss
            icon: mdi:alert
          - entity: binary_sensor.heat_pump_in_startup_phase
            name: Startup Phase Active
            icon: mdi:rocket-launch

      - type: conditional
        conditions:
          - entity: sensor.heat_pump_short_cycle_alert
            state_not: "Normal"
        card:
          type: markdown
          content: |
            ### ğŸš¨ Short Cycling Detected!

            **Issue:** Cycle duration too short - startup penalty reducing efficiency

            **Action Required:**
            1. Increase buffer differential target
            2. Check thermostat deadband settings
            3. Verify zone valve operation

            **Target:** Minimum 15 minutes runtime per cycle

      - type: conditional
        conditions:
          - entity: binary_sensor.circulator_running_hp_off
            state: "on"
        card:
          type: markdown
          content: |
            ### âš ï¸ Standby Energy Loss Detected!

            **Issue:** Circulator pump running without heat pump

            **Impact:** Wasting energy and cooling buffer tank

            **Action:** Check pump control logic and zone valves

      # ========================================================================
      # COST SAVINGS DASHBOARD
      # ========================================================================
      - type: markdown
        content: |
          ## ğŸ’° Energy & Cost Savings

      - type: horizontal-stack
        cards:
          - type: entity
            entity: sensor.cx_daily_energy_input
            name: Today's Electrical Input
            icon: mdi:lightning-bolt

          - type: entity
            entity: sensor.cx_daily_energy_output
            name: Today's Thermal Output
            icon: mdi:fire

          - type: entity
            entity: sensor.heat_pump_daily_runtime_hours
            name: Today's Runtime
            icon: mdi:timer

          - type: entity
            entity: sensor.heat_pump_daily_cycle_count
            name: Today's Cycle Count
            icon: mdi:counter

      - type: entities
        title: Standby Loss Tracking
        entities:
          - entity: sensor.hp_standby_thermal_loss_rate
            name: Current Standby Loss Rate
            icon: mdi:leak
          - entity: sensor.hp_standby_thermal_loss_accumulated
            name: Total Standby Loss (Accumulated)
            icon: mdi:cash-remove
          - entity: sensor.circulator_pump_idle_loss_duration_daily
            name: Today's Wasted Circulation Time
            icon: mdi:clock-alert-outline

      # ========================================================================
      # REAL-TIME OPTIMIZATION METRICS
      # ========================================================================
      - type: markdown
        content: |
          ## ğŸ“ˆ Real-Time Performance Metrics

      - type: horizontal-stack
        cards:
          - type: entities
            title: Startup Penalty Analysis
            entities:
              - entity: sensor.heat_pump_startup_phase_cop
                name: Startup COP
                icon: mdi:rocket-launch
              - entity: sensor.heat_pump_steady_state_cop
                name: Steady State COP
                icon: mdi:check-circle
              - entity: sensor.heat_pump_startup_energy_penalty
                name: Startup Energy Penalty
                icon: mdi:alert-decagram

          - type: entities
            title: Temperature Monitoring
            entities:
              - entity: sensor.heat_pump_inlet_temperature
                name: Inlet Temp
              - entity: sensor.heat_pump_outlet_temperature
                name: Outlet Temp
              - entity: sensor.heat_pump_delta_t
                name: Delta T
              - entity: sensor.heat_pump_ambient_temperature
                name: Outdoor Temp

      - type: horizontal-stack
        cards:
          - type: entities
            title: Power Metrics
            entities:
              - entity: sensor.heat_pump_electrical_power_input_kw
                name: Electrical Input
                icon: mdi:flash
              - entity: sensor.heat_pump_thermal_power_output_kw
                name: Thermal Output
                icon: mdi:fire
              - entity: sensor.cx50_pump_flow_gpm
                name: Flow Rate
                icon: mdi:waves

          - type: entities
            title: System Efficiency
            entities:
              - entity: sensor.system_distribution_efficiency
                name: Distribution Efficiency
                icon: mdi:percent
              - entity: sensor.hvac_thermal_power_used
                name: HVAC Load
                icon: mdi:home-thermometer
              - entity: sensor.system_distribution_losses
                name: Distribution Losses
                icon: mdi:leak

      # ========================================================================
      # COP TREND GRAPH
      # ========================================================================
      - type: history-graph
        title: COP Performance - Last 24 Hours
        hours_to_show: 24
        refresh_interval: 60
        entities:
          - entity: sensor.heat_pump_cop
            name: Overall COP
          - entity: sensor.heat_pump_startup_phase_cop
            name: Startup COP
          - entity: sensor.heat_pump_steady_state_cop
            name: Steady State COP

      # ========================================================================
      # CYCLE DURATION MONITORING
      # ========================================================================
      - type: history-graph
        title: Cycle Duration - Last 48 Hours
        hours_to_show: 48
        refresh_interval: 60
        entities:
          - entity: sensor.heat_pump_current_cycle_duration_minutes
            name: Runtime (minutes)
          - entity: sensor.heat_pump_off_time_duration
            name: Off Time (minutes)

      # ========================================================================
      # QUICK CONTROLS
      # ========================================================================
      - type: markdown
        content: |
          ## ğŸ® Quick Controls & Settings

      - type: entities
        title: Optimization Controls
        show_header_toggle: false
        entities:
          - entity: input_select.optimization_phase
            name: Current Optimization Phase
          - entity: input_boolean.enable_cop_optimization
            name: Enable COP Optimization Tracking
          - entity: input_boolean.enable_short_cycle_alerts
            name: Enable Short Cycle Alerts
          - entity: input_boolean.enable_startup_penalty_tracking
            name: Enable Startup Penalty Tracking

      - type: entities
        title: Heat Pump Setpoints
        show_header_toggle: false
        entities:
          - entity: number.cx50_heating_setpoint_c
            name: Heating Setpoint
            icon: mdi:thermometer-chevron-up
          - entity: number.cx50_cooling_setpoint_c
            name: Cooling Setpoint
            icon: mdi:thermometer-chevron-down
          - entity: number.cx50_dhw_setpoint_c
            name: DHW Setpoint
            icon: mdi:water-boiler
          - entity: number.cx50_compressor_max_percentage
            name: Max Compressor Speed
            icon: mdi:speedometer

      - type: entities
        title: Optimization Targets
        show_header_toggle: false
        entities:
          - entity: input_number.buffer_differential_target
            name: Buffer Differential Target
          - entity: input_number.heat_pump_supply_temp_target
            name: Supply Temperature Target
          - entity: input_number.target_cop
            name: Target COP
          - entity: input_number.minimum_runtime_target
            name: Minimum Runtime Target

      # ========================================================================
      # POWER & ENERGY VISUALIZATION
      # ========================================================================
      - type: history-graph
        title: Power Input vs Output - Last 24 Hours
        hours_to_show: 24
        refresh_interval: 60
        entities:
          - entity: sensor.heat_pump_electrical_power_input
            name: Electrical Input (W)
          - entity: sensor.heat_pump_thermal_power_output
            name: Thermal Output (W)

      # ========================================================================
      # FOOTER - OPTIMIZATION TIPS
      # ========================================================================
      - type: markdown
        content: |
          ---

          ## ğŸ’¡ Optimization Tips

          ### To Improve COP:
          1. **Increase runtime** - Target 15+ minutes per cycle
          2. **Reduce cycling frequency** - Minimize startup penalties
          3. **Optimize temperatures** - Lower supply temp increases efficiency
          4. **Eliminate standby losses** - Stop pump when HP is off
          5. **Monitor outdoor temp** - Performance varies with ambient conditions

          ### Quick Wins:
          - âœ… Increase buffer differential (Phase 1)
          - âœ… Lower supply temperature gradually (Phase 2)
          - âœ… Fix standby circulation issues
          - âœ… Adjust zone control to reduce short cycling

          ### Monitor These Key Metrics:
          - **COP** - Should trend toward 4.55
          - **Cycle Duration** - Should increase to 15+ minutes
          - **Startup Penalty** - Should decrease as runtime increases
          - **Standby Losses** - Should be near zero

          ---

          **Dashboard Last Updated:** 2025-11-16
