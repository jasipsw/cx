- id: '1720885682891'
  alias: Unlock Doors In The Morning
  description: Unlock Doors In The Morning
  triggers:
  - at: 05:55:00
    trigger: time
  conditions: []
  actions:
  - metadata: {}
    data:
      code: '22594059'
    target:
      device_id:
      - 587b37bf0f53a2f77c480ce504688a13
      entity_id:
      - lock.workshop_double_door
      - lock.my_door
    action: lock.unlock
  - data:
      message: Morning Door Unlock automation has run
      title: Morning Door Unlock automation has run
    action: notify.mobile_app_pixel_8_pro
  mode: single
- id: '1720885979266'
  alias: Evening Door Lock
  description: ''
  triggers:
  - at: '19:00:00'
    trigger: time
  conditions: []
  actions:
  - metadata: {}
    data: {}
    target:
      entity_id:
      - lock.my_door
      - lock.workshop_double_door
      - lock.front_door
      device_id: 7d153866c0b2b32b60b33f3227e3685f
    action: lock.lock
  - metadata: {}
    data:
      message: Evening Door Lock automation has run
      title: Evening Door Lock automation has run
    action: notify.mobile_app_pixel_8_pro
  mode: single
- id: '1721126838040'
  alias: 'Home automation '
  description: ''
  triggers:
  - device_id: 5fb9f37038b9ead0a180e3a147474dae
    domain: device_tracker
    entity_id: b0b8141d2569cde5cfb79cccb180ef09
    type: enters
    zone: zone.home
    trigger: device
  - device_id: 5fb9f37038b9ead0a180e3a147474dae
    domain: device_tracker
    entity_id: b0b8141d2569cde5cfb79cccb180ef09
    type: leaves
    zone: zone.home
    trigger: device
  - trigger: zone
    entity_id: device_tracker.lgs4_a5_256_apr2024
    zone: zone.home
    event: enter
  conditions: []
  actions:
  - metadata: {}
    data:
      title: Jeff home
      message: Someone is transitioned zone home
    action: notify.mobile_app_pixel_8_pro
  mode: single
- id: '1721127753249'
  alias: Jeff zone notify
  description: ''
  use_blueprint:
    path: homeassistant/notify_leaving_zone.yaml
    input:
      person_entity: person.jeff
      zone_entity: zone.home
      notify_device: 5fb9f37038b9ead0a180e3a147474dae
- id: '1721127803290'
  alias: 'Linda zone notify '
  description: ''
  use_blueprint:
    path: homeassistant/notify_leaving_zone.yaml
    input:
      person_entity: person.linda
      zone_entity: zone.home
      notify_device: 5fb9f37038b9ead0a180e3a147474dae
- id: '1731116968380'
  alias: humid turn up fan
  description: ''
  triggers:
  - trigger: numeric_state
    entity_id:
    - sensor.master_bath_humidity_2
    above: 65
  conditions: []
  actions:
  - action: notify.notify
    metadata: {}
    data:
      message: Master Bath is Humid
  mode: single
- id: '1731347689269'
  alias: Unlock Doors for Linda
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - person.linda
    from: not_home
    to: home
  conditions: []
  actions:
  - action: lock.unlock
    metadata: {}
    data: {}
    target:
      entity_id: lock.mudroom
  - action: lock.unlock
    metadata: {}
    data: {}
    target:
      entity_id: lock.front_door
  - action: notify.send_message
    metadata: {}
    data:
      message: Your doors have been unlocked for you
  mode: single
- id: '1731366239999'
  alias: Unlock Doors For Jeff
  description: ''
  triggers:
  - trigger: zone
    entity_id: person.jeff
    zone: zone.near_home
    event: enter
  conditions: []
  actions:
  - action: lock.unlock
    metadata: {}
    data: {}
    target:
      entity_id: lock.mudroom
  - action: lock.unlock
    metadata: {}
    data: {}
    target:
      entity_id: lock.front_door
  - action: notify.send_message
    metadata: {}
    data:
      message: Welcome Home!  The mudroom and front door  have been unlocked for you
        :)
    target:
      entity_id: person.jeff
  - action: notify.mobile_app_pixel_8_pro
    metadata: {}
    data:
      message: Welcome Home!  The mudroom and front door  have been unlocked for you
        :)
  - action: notify.notify
    metadata: {}
    data:
      message: Welcome Home!  The mudroom and front door  have been unlocked for you
        :)
  mode: single
- id: '1732041097525'
  alias: Kitchen Light Motion
  description: ''
  use_blueprint:
    path: Blackshome/sensor-light.yaml
    input:
      motion_trigger:
      - binary_sensor.kitchen_lights_sensors
      light_switch:
        entity_id:
        - light.pantry_cabinet
        - light.kitchen_cabinet
      time_delay: 20
      night_lights_conditions: []
      include_sun: sun_enabled
      sun_elevation_rising: 3
- id: '1732060411007'
  alias: Start kitchen light timer
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - binary_sensor.kitchen_lights_sensors
    to: 'on'
    from: 'off'
  conditions: []
  actions:
  - action: timer.start
    metadata: {}
    data: {}
    target:
      entity_id: timer.upstairs_light_timer
  mode: single
- id: '1732836109928'
  alias: Entrance Lights on at Sunset
  description: ''
  triggers:
  - trigger: sun
    event: sunset
    offset: 00:15:00
  conditions: []
  actions:
  - action: light.turn_on
    metadata: {}
    data: {}
    target:
      label_id: entrance_light
  mode: single
- id: '1734371418731'
  alias: Mudroom driveway light turning on turns on  garage light
  description: ''
  triggers:
  - type: turned_on
    device_id: 6d50f3bb4ef33d4be996932b4fc50626
    entity_id: e1700c5801168b2766540b3bc4bde8b0
    domain: light
    trigger: device
  conditions: []
  actions:
  - type: turn_on
    device_id: 18d461dfd0c26fb71ea7a91e85ca11ab
    entity_id: 61c07151cfd07658efd6048a07e48c32
    domain: light
  - type: turn_on
    device_id: 83333838aaced608d2e153afd7e5d65f
    entity_id: 251c90afd8b2c92fbc62d28c52f2a9bd
    domain: light
  - type: turn_on
    device_id: cf14bb166bd0db6bb58a1f86eb7e3a1e
    entity_id: c501ee27ab7abe50d1f3b33b56a3efdf
    domain: light
  mode: single
- id: '1734371514735'
  alias: Mudroom driveway light turning off turns off garage light
  description: ''
  triggers:
  - type: turned_off
    device_id: 6d50f3bb4ef33d4be996932b4fc50626
    entity_id: e1700c5801168b2766540b3bc4bde8b0
    domain: light
    trigger: device
  conditions: []
  actions:
  - type: turn_off
    device_id: 18d461dfd0c26fb71ea7a91e85ca11ab
    entity_id: 61c07151cfd07658efd6048a07e48c32
    domain: light
  - type: turn_off
    device_id: 83333838aaced608d2e153afd7e5d65f
    entity_id: 251c90afd8b2c92fbc62d28c52f2a9bd
    domain: light
  - type: turn_off
    device_id: cf14bb166bd0db6bb58a1f86eb7e3a1e
    entity_id: c501ee27ab7abe50d1f3b33b56a3efdf
    domain: light
  mode: single
- id: '1735826596716'
  alias: Turn off outside lights in the morning
  description: ''
  triggers:
  - trigger: sun
    event: sunrise
    offset: 00:15:00
  conditions: []
  actions:
  - action: light.turn_off
    metadata: {}
    data: {}
    target:
      label_id: outside_light
  mode: single
- id: '1735828671998'
  alias: Turn off Outside Lights for the Night
  description: ''
  triggers:
  - trigger: time
    at: '23:30:00'
  conditions: []
  actions:
  - action: light.turn_off
    metadata: {}
    data: {}
    target:
      label_id: outside_light
  mode: single
- id: '1736962206042'
  alias: Batteries Fully Charged
  description: ''
  triggers:
  - trigger: numeric_state
    entity_id:
    - sensor.envoy_202425002148_battery
    above: 98
  conditions: []
  actions:
  - action: notify.notify
    metadata: {}
    data:
      message: Perhaps lower the reserve setting to store more energy from the sun?
      title: 50 Clark Batteries are Fully Charged
  - action: notify.send_message
    metadata: {}
    data:
      message: 50 Clark Batteries are Fully Charged
    enabled: false
  - action: notify.mobile_app_pixel_8_pro
    metadata: {}
    data:
      title: 50 Clark Batteries are Fully Charged
    enabled: false
  mode: single
- id: '1739892026124'
  alias: Reset EV Charger Meter
  description: ''
  triggers:
  - trigger: numeric_state
    entity_id:
    - sensor.garage_ev_charger_watts
    for:
      hours: 0
      minutes: 1
      seconds: 0
    below: 1
  conditions: []
  actions:
  - action: utility_meter.reset
    metadata: {}
    data: {}
    target:
      entity_id: sensor.car_charger
  - action: notify.mobile_app_google_pixel_watch_2
    metadata: {}
    data:
      message: Charge Complete
  mode: single
- id: 'cx_optimization_phase_1'
  alias: CX Optimization Phase 1 - Buffer Differential 18Â°F
  description: Implement Phase 1 - Increase buffer differential from 10Â°F to 18Â°F by adjusting heating setpoint
  triggers:
  - trigger: state
    entity_id:
    - input_select.optimization_phase
    to: "Phase 1: Buffer Differential 18Â°F"
  conditions: []
  actions:
  - action: number.set_value
    target:
      entity_id: input_number.buffer_differential_target
    data:
      value: 18
  - action: number.set_value
    target:
      entity_id: input_number.heat_pump_supply_temp_target
    data:
      value: 90
  - action: notify.notify
    metadata: {}
    data:
      message: "Phase 1 activated: Buffer differential target set to 18Â°F, supply temp 90Â°F. Monitor cycle duration for improvements."
      title: CX50 Optimization Phase 1 Active
  mode: single
- id: 'cx_optimization_phase_2'
  alias: CX Optimization Phase 2 - Supply Temp 85Â°F
  description: Implement Phase 2 - Lower supply temperature from 90Â°F to 85Â°F (29.4Â°C)
  triggers:
  - trigger: state
    entity_id:
    - input_select.optimization_phase
    to: "Phase 2: Supply Temp 85Â°F"
  conditions: []
  actions:
  - action: number.set_value
    target:
      entity_id: number.cx50_heating_setpoint_c
    data:
      value: 29.4
  - action: number.set_value
    target:
      entity_id: input_number.heat_pump_supply_temp_target
    data:
      value: 85
  - action: notify.notify
    metadata: {}
    data:
      message: "Phase 2 activated: Supply temperature lowered to 85Â°F (29.4Â°C). Monitor COP improvements."
      title: CX50 Optimization Phase 2 Active
  mode: single
- id: 'cx_optimization_phase_3'
  alias: CX Optimization Phase 3 - Supply Temp 82Â°F (Target)
  description: Implement Phase 3 - Fine-tune to 82Â°F (27.8Â°C) targeting manufacturer specifications
  triggers:
  - trigger: state
    entity_id:
    - input_select.optimization_phase
    to: "Phase 3: Supply Temp 82Â°F (Target)"
  conditions: []
  actions:
  - action: number.set_value
    target:
      entity_id: number.cx50_heating_setpoint_c
    data:
      value: 27.8
  - action: number.set_value
    target:
      entity_id: input_number.heat_pump_supply_temp_target
    data:
      value: 82
  - action: notify.notify
    metadata: {}
    data:
      message: "Phase 3 activated: Supply temperature optimized to 82Â°F (27.8Â°C). Target COP: 4.55. Monitor performance closely."
      title: CX50 Optimization Phase 3 Active
  mode: single
- id: 'cx_short_cycle_alert'
  alias: CX Short Cycle Alert
  description: Alert when heat pump short cycles (runtime < 10 minutes)
  triggers:
  - trigger: state
    entity_id:
    - binary_sensor.heat_pump_running
    from: "on"
    to: "off"
  conditions:
  # Check cycle was actually short but not too short (filter out initialization)
  - condition: template
    value_template: "{{ states('sensor.heat_pump_current_cycle_duration') | float(0) < 600 and states('sensor.heat_pump_current_cycle_duration') | float(0) > 30 }}"

  # Alerts must be enabled
  - condition: state
    entity_id: input_boolean.enable_short_cycle_alerts
    state: "on"

  # Filter out sensor initialization: Previous state must have been valid (not unknown/unavailable)
  - condition: template
    value_template: "{{ trigger.from_state.state not in ['unknown', 'unavailable', 'none'] }}"

  # Filter out restarts: Sensor must have been in previous state for at least 10 seconds
  - condition: template
    value_template: >
      {{ (as_timestamp(now()) - as_timestamp(trigger.from_state.last_changed)) > 10 }}

  actions:
  - action: notify.notify
    metadata: {}
    data:
      message: "Heat pump short cycled: {{ (states('sensor.heat_pump_current_cycle_duration') | float(0) / 60) | round(1) }} minutes runtime. Target: {{ states('input_number.minimum_runtime_target') }} minutes."
      title: CX50 Short Cycle Detected
  mode: single
- id: 'cx_target_cop_achieved'
  alias: CX Target COP Achieved Alert
  description: Alert when heat pump achieves target COP
  triggers:
  - trigger: numeric_state
    entity_id:
    - sensor.heat_pump_cop
    above: 4.5
    for:
      hours: 0
      minutes: 5
      seconds: 0
  conditions:
  - condition: state
    entity_id: input_boolean.enable_cop_optimization
    state: "on"
  actions:
  - action: notify.notify
    metadata: {}
    data:
      message: "Excellent! Heat pump COP reached {{ states('sensor.heat_pump_cop') }} - at or above manufacturer's 4.55 rating!"
      title: CX50 Target COP Achieved!
  mode: single
# Heat Pump Event Logging Automations
# These automations create custom logbook entries for important heat pump events
# to aid in debugging and performance tracking

# ============================================================================
# CYCLE EVENTS
# ============================================================================

- id: log_heat_pump_standby_power_loss
  alias: "Log: Heat Pump Standby Power Loss"
  description: Log standby power consumption before heat pump starts
  trigger:
    - platform: state
      entity_id: binary_sensor.heat_pump_running
      from: "off"
      to: "on"
  action:
    - service: logbook.log
      data:
        name: Heat Pump Standby
        message: >
          âš¡ Standby power loss: {{ states('sensor.heat_pump_last_standby_power') | float(0) }}W
          (consumed while heat pump was idle)
        entity_id: binary_sensor.heat_pump_running

- id: log_heat_pump_cycle_started
  alias: "Log: Heat Pump Cycle Started"
  description: Log when heat pump starts a new cycle
  trigger:
    - platform: state
      entity_id: binary_sensor.heat_pump_running
      from: "off"
      to: "on"
  action:
    - service: logbook.log
      data:
        name: Heat Pump
        message: >
          ðŸŸ¢ Cycle started in {{ states('sensor.heat_pump_operating_mode') }} mode
          (Power: {{ states('sensor.heat_pump_electrical_power_input') }}W)
        entity_id: binary_sensor.heat_pump_running

- id: log_heat_pump_cycle_completed
  alias: "Log: Heat Pump Cycle Completed"
  description: Log cycle completion with performance stats
  trigger:
    - platform: state
      entity_id: binary_sensor.heat_pump_running
      from: "on"
      to: "off"
  action:
    - service: logbook.log
      data:
        name: Heat Pump
        message: >
          âš« Cycle completed: {{ (states('sensor.heat_pump_last_cycle_duration') | float / 60) | round(1) }} min,
          COP {{ states('sensor.heat_pump_last_cycle_cop') }},
          Mode: {{ states('sensor.heat_pump_operating_mode') }}
        entity_id: binary_sensor.heat_pump_running

# ============================================================================
# SHORT CYCLE WARNING
# ============================================================================

- id: log_heat_pump_short_cycle
  alias: "Log: Heat Pump Short Cycle Warning"
  description: Log warning when a short cycle is detected
  trigger:
    - platform: state
      entity_id: binary_sensor.heat_pump_last_cycle_was_short
      to: "on"
  condition:
    # Filter out sensor initialization: Previous state must have been valid
    - condition: template
      value_template: "{{ trigger.from_state.state not in ['unknown', 'unavailable', 'none'] }}"

    # Ensure cycle duration is meaningful (> 30 seconds, filters out initialization glitches)
    - condition: template
      value_template: "{{ states('sensor.heat_pump_last_cycle_duration') | float(0) > 30 }}"

    # Filter out restarts: Sensor must have been in previous state for at least 10 seconds
    - condition: template
      value_template: >
        {{ (as_timestamp(now()) - as_timestamp(trigger.from_state.last_changed)) > 10 }}
  action:
    - service: logbook.log
      data:
        name: Heat Pump Short Cycle
        message: >
          âš ï¸ Short cycle detected: {{ (states('sensor.heat_pump_last_cycle_duration') | float / 60) | round(1) }} minutes
          (Target: {{ states('input_number.minimum_runtime_target') }} min)
        entity_id: binary_sensor.heat_pump_last_cycle_was_short

# ============================================================================
# MODE CHANGES
# ============================================================================

- id: log_heat_pump_mode_change
  alias: "Log: Heat Pump Mode Change"
  description: Log when operating mode changes
  trigger:
    - platform: state
      entity_id: sensor.heat_pump_operating_mode
  condition:
    - condition: template
      value_template: "{{ trigger.from_state.state != trigger.to_state.state }}"
    - condition: template
      value_template: "{{ trigger.from_state.state not in ['unknown', 'unavailable'] }}"
  action:
    - service: logbook.log
      data:
        name: Heat Pump Mode
        message: "ðŸ”„ Changed from {{ trigger.from_state.state }} to {{ trigger.to_state.state }}"
        entity_id: sensor.heat_pump_operating_mode

# ============================================================================
# PHASE TRANSITIONS
# ============================================================================

- id: log_heat_pump_entered_steady_state
  alias: "Log: Heat Pump Entered Steady State"
  description: Log when heat pump enters steady state operation
  trigger:
    - platform: state
      entity_id: binary_sensor.heat_pump_steady_state
      to: "on"
  action:
    - service: logbook.log
      data:
        name: Heat Pump Phase
        message: >
          âœ… Entered steady state
          ({{ states('sensor.heat_pump_current_cycle_duration_minutes') | round(1) }} min runtime,
          COP {{ states('sensor.heat_pump_cop') }})
        entity_id: binary_sensor.heat_pump_steady_state

- id: log_heat_pump_exited_steady_state
  alias: "Log: Heat Pump Exited Steady State"
  description: Log when heat pump exits steady state
  trigger:
    - platform: state
      entity_id: binary_sensor.heat_pump_steady_state
      from: "on"
      to: "off"
  condition:
    - condition: state
      entity_id: binary_sensor.heat_pump_running
      state: "on"
  action:
    - service: logbook.log
      data:
        name: Heat Pump Phase
        message: "â¸ï¸ Exited steady state (cycle ending soon)"
        entity_id: binary_sensor.heat_pump_steady_state

# ============================================================================
# PERFORMANCE EVENTS
# ============================================================================

- id: log_heat_pump_cop_excellent
  alias: "Log: Heat Pump Excellent COP"
  description: Log when COP exceeds 4.0 (excellent performance)
  trigger:
    - platform: numeric_state
      entity_id: sensor.heat_pump_cop
      above: 4.0
  condition:
    - condition: state
      entity_id: binary_sensor.heat_pump_running
      state: "on"
  action:
    - service: logbook.log
      data:
        name: Heat Pump Performance
        message: >
          â­ Excellent COP: {{ states('sensor.heat_pump_cop') }}
          ({{ states('sensor.heat_pump_operating_mode') }} mode,
          {{ states('sensor.heat_pump_current_cycle_duration_minutes') | round(1) }} min runtime)
        entity_id: sensor.heat_pump_cop

- id: log_heat_pump_cop_poor
  alias: "Log: Heat Pump Poor COP"
  description: Log when COP drops below 2.0 (poor performance)
  trigger:
    - platform: numeric_state
      entity_id: sensor.heat_pump_cop
      below: 2.0
  condition:
    - condition: state
      entity_id: binary_sensor.heat_pump_running
      state: "on"
    - condition: numeric_state
      entity_id: sensor.heat_pump_current_cycle_duration
      above: 60  # Only log if running > 1 minute (avoid startup transients)
  action:
    - service: logbook.log
      data:
        name: Heat Pump Performance
        message: >
          âš ï¸ Low COP: {{ states('sensor.heat_pump_cop') }}
          ({{ states('sensor.heat_pump_operating_mode') }} mode,
          Ambient: {{ states('sensor.heat_pump_ambient_temperature') }}Â°F)
        entity_id: sensor.heat_pump_cop

# ============================================================================
# SENSOR INITIALIZATION TRACKING
# ============================================================================

- id: log_cx_output_power_initialized
  alias: "Log: CX Output Power Interval Initialized"
  description: Log when the thermal energy integration sensor initializes
  trigger:
    - platform: state
      entity_id: sensor.cx_output_power_interval
      from: "unknown"
  condition:
    - condition: template
      value_template: "{{ trigger.to_state.state not in ['unknown', 'unavailable'] }}"
  action:
    - service: logbook.log
      data:
        name: Sensor Initialization
        message: >
          âœ… CX Output Power Interval initialized at {{ trigger.to_state.state }} kWh
          (thermal energy tracking now active)
        entity_id: sensor.cx_output_power_interval

# Manual reset instructions for CX Output Power Interval integration sensor
# NOTE: integration.reset service not available in this HA version
# Run this from Settings â†’ Automations â†’ [This automation] â†’ Run
- id: reset_cx_output_power_interval
  alias: "Reset CX Output Power Interval Sensor - Instructions"
  description: Shows instructions to manually reset the thermal energy integration sensor
  trigger: []  # Manual trigger only
  condition: []
  action:
    - service: persistent_notification.create
      data:
        title: "Reset CX Output Power Interval Sensor"
        message: >
          **Current Value:** {{ states('sensor.cx_output_power_interval') }} kWh


          **To reset this sensor to 0:**

          1. Go to **Developer Tools â†’ States**

          2. Find entity: `sensor.cx_output_power_interval`

          3. Click on it

          4. Under "Set State", enter: `0`

          5. Click **Set State**


          The sensor will continue accumulating from 0 going forward.


          *(The integration.reset service is not available in your Home Assistant version)*
        notification_id: cx_output_reset_instructions
  mode: single

- id: log_cycle_duration_sensor_initialized
  alias: "Log: Cycle Duration Sensor Initialized"
  description: Log when cycle duration sensor starts working
  trigger:
    - platform: state
      entity_id: sensor.heat_pump_current_cycle_duration
      from: "unavailable"
  condition:
    - condition: template
      value_template: "{{ trigger.to_state.state not in ['unknown', 'unavailable'] }}"
  action:
    - service: logbook.log
      data:
        name: Sensor Initialization
        message: "âœ… Cycle duration sensor initialized (value: {{ trigger.to_state.state }}s)"
        entity_id: sensor.heat_pump_current_cycle_duration

# ============================================================================
# DISTRIBUTION EFFICIENCY ALERTS
# ============================================================================

- id: log_distribution_efficiency_critical
  alias: "Log: Distribution Efficiency Critical"
  description: Log when distribution efficiency is critically low (not in DHW mode)
  trigger:
    - platform: numeric_state
      entity_id: sensor.system_distribution_efficiency
      below: 50
  condition:
    - condition: state
      entity_id: binary_sensor.heat_pump_running
      state: "on"
    - condition: template
      value_template: "{{ states('sensor.heat_pump_operating_mode') not in ['Heat + DHW', 'HEAT + DHW', 'DHW'] }}"
    - condition: numeric_state
      entity_id: sensor.heat_pump_thermal_power_output
      above: 1000  # Only if producing > 1kW
  action:
    - service: logbook.log
      data:
        name: Distribution Efficiency
        message: >
          ðŸš¨ Critical efficiency: {{ states('sensor.system_distribution_efficiency') }}%
          (HP Output: {{ (states('sensor.heat_pump_thermal_power_output') | float / 1000) | round(1) }}kW,
          HVAC Load: {{ (states('sensor.hvac_thermal_power_used') | float / 1000) | round(1) }}kW)
        entity_id: sensor.system_distribution_efficiency

# ============================================================================
# DHW MODE TRACKING
# ============================================================================

- id: log_heat_pump_dhw_mode_entered
  alias: "Log: Heat Pump Entered DHW Mode"
  description: Log when heat pump enters any DHW mode with context about COP impact
  trigger:
    - platform: state
      entity_id: sensor.heat_pump_operating_mode
      to: "DHW"
    - platform: state
      entity_id: sensor.heat_pump_operating_mode
      to: "Heat + DHW"
    - platform: state
      entity_id: sensor.heat_pump_operating_mode
      to: "HEAT + DHW"
  condition:
    - condition: template
      value_template: >
        {{ trigger.from_state.state not in ['DHW', 'Heat + DHW', 'HEAT + DHW', 'unknown', 'unavailable'] }}
  action:
    - service: logbook.log
      data:
        name: Heat Pump DHW
        message: >
          ðŸš¿ Entered {{ trigger.to_state.state }} mode
          (Note: Distribution efficiency will be low - energy goes to hot water tank)
        entity_id: sensor.heat_pump_operating_mode

- id: log_heat_pump_dhw_mode_exited
  alias: "Log: Heat Pump Exited DHW Mode"
  description: Log when heat pump exits DHW mode back to pure heating
  trigger:
    - platform: state
      entity_id: sensor.heat_pump_operating_mode
      from: "DHW"
      to: "Heat"
    - platform: state
      entity_id: sensor.heat_pump_operating_mode
      from: "Heat + DHW"
      to: "Heat"
    - platform: state
      entity_id: sensor.heat_pump_operating_mode
      from: "HEAT + DHW"
      to: "Heat"
  action:
    - service: logbook.log
      data:
        name: Heat Pump DHW
        message: >
          ðŸ  Exited DHW mode â†’ {{ trigger.to_state.state }}
          (Space heating only - distribution efficiency should improve)
        entity_id: sensor.heat_pump_operating_mode

- id: log_heat_pump_dhw_cycle_completed
  alias: "Log: Heat Pump DHW Cycle Completed"
  description: Log DHW cycle completion with specific DHW COP
  trigger:
    - platform: state
      entity_id: binary_sensor.heat_pump_running
      from: "on"
      to: "off"
  condition:
    - condition: template
      value_template: >
        {{ states('sensor.heat_pump_operating_mode') in ['DHW', 'Heat + DHW', 'HEAT + DHW'] }}
  action:
    - service: logbook.log
      data:
        name: Heat Pump DHW Cycle
        message: >
          ðŸš¿ DHW cycle completed: {{ (states('sensor.heat_pump_last_cycle_duration') | float / 60) | round(1) }} min,
          COP {{ states('sensor.heat_pump_last_cycle_cop') }}
          ({{ states('sensor.heat_pump_operating_mode') }} mode)
        entity_id: binary_sensor.heat_pump_running

# ============================================================================
# DUPLICATE ENTITY DETECTOR
# ============================================================================

- id: 'duplicate_entity_detector_notification'
  alias: Duplicate Entity Detector - Notification
  description: Automatically detect and notify about duplicate entities (_2, _3, etc.) created by Home Assistant
  triggers:
    # Check on Home Assistant startup
    - platform: homeassistant
      event: start

    # Check every hour to catch duplicates created during runtime
    - platform: time_pattern
      hours: "/1"

  conditions: []

  actions:
    # Check if any duplicate entities exist
    - if:
        - condition: template
          value_template: >
            {%- set duplicates = namespace(found=false) %}
            {%- for entity in states %}
              {# Match entities ending in _2 through _99 #}
              {%- if entity.entity_id | regex_match('.*_([2-9]|[1-9][0-9])$') %}
                {# Get the presumed original entity name by removing the suffix #}
                {%- set original = entity.entity_id | regex_replace('_([2-9]|[1-9][0-9])$', '') %}
                {# Check if the original entity exists - if so, this is a true duplicate #}
                {%- if states[original] is defined %}
                  {%- set duplicates.found = true %}
                {%- endif %}
              {%- endif %}
            {%- endfor %}
            {{ duplicates.found }}
      then:
        # Send persistent notification with duplicate entity list
        - action: persistent_notification.create
          data:
            title: "âš ï¸ Duplicate Entities Detected"
            notification_id: duplicate_entity_detector
            message: >
              **Home Assistant has created duplicate entities with `_2`, `_3`, etc. suffixes.**

              This usually happens when:
              - `unique_id` changed in YAML
              - `entity_id` conflicts with existing entity
              - HA restart with config changes


              **Duplicates found:**

              {%- for entity in states %}
                {%- if entity.entity_id | regex_match('.*_([2-9]|[1-9][0-9])$') %}
                  {%- set original = entity.entity_id | regex_replace('_([2-9]|[1-9][0-9])$', '') %}
                  {# Only show if the original entity exists - this is a true duplicate #}
                  {%- if states[original] is defined %}

              - **{{ entity.domain }}.{{ entity.entity_id.split('.')[1] }}**
                - Status: {{ 'âŒ Unavailable' if entity.state in ['unknown', 'unavailable'] else 'âš ï¸ Active (' + entity.state + ')' }}
                - Friendly Name: {{ entity.name }}
                - Original Entity: `{{ original }}` ({{ 'âœ… exists' if states[original].state not in ['unknown', 'unavailable'] else 'âš ï¸ unavailable' }})
                  {%- endif %}
                {%- endif %}
              {%- endfor %}


              **How to fix:**

              1. Go to **Settings â†’ Devices & Services â†’ Entities**
              2. Search for entities ending in `_2`, `_3`, etc.
              3. Click on each duplicate entity
              4. Click **Delete** (if unavailable/unwanted)
              5. Restart Home Assistant to recreate correctly


              **Alternatively**, check the **Sensor Verification Dashboard** for a detailed table.
      else:
        # Clear the notification if no duplicates found
        - action: persistent_notification.dismiss
          data:
            notification_id: duplicate_entity_detector

  mode: single

# ============================================================================
# ADAPTIVE SUPPLY TEMPERATURE OPTIMIZATION
# ============================================================================

- id: 'supply_temp_optimization_recommendations'
  alias: Supply Temperature Optimization Recommendations
  description: >
    Analyzes zone demand and sends recommendations for CX50 setpoint changes.
    User reviews and manually applies changes to account for radiant floor thermal lag.
  triggers:
    # Check every 6 hours
    - platform: time_pattern
      hours: "/6"

  conditions:
    # Must be enabled
    - condition: state
      entity_id: input_boolean.enable_supply_temp_optimization
      state: "on"

    # Heat pump must not be in DHW mode
    - condition: template
      value_template: >
        {{ states('sensor.heat_pump_operating_mode') not in ['DHW', 'Heat + DHW', 'HEAT + DHW'] }}

  actions:
    - choose:
        # RECOMMEND DECREASE when demand has been low
        - conditions:
            - condition: state
              entity_id: sensor.radiant_system_demand_level
              state: "Low"
              for:
                hours: 4
            # Verify we're above minimum limit
            - condition: template
              value_template: >
                {% set current_c = states('number.cx50_heating_setpoint_c') | float(30) %}
                {% set min_f = states('input_number.supply_temp_min_limit') | float(78) %}
                {% set min_c = (min_f - 32) / 1.8 %}
                {{ current_c > (min_c + 0.5) }}
          sequence:
            - action: persistent_notification.create
              data:
                title: "Supply Temp Recommendation: Decrease"
                message: >
                  **Recommendation:** Decrease setpoint by 1Â°F

                  **Current:** {{ states('number.cx50_heating_setpoint_c') }}Â°C ({{ (states('number.cx50_heating_setpoint_c') | float * 1.8 + 32) | round(1) }}Â°F)

                  **Suggested:** {{ (states('number.cx50_heating_setpoint_c') | float - 0.5) | round(1) }}Â°C ({{ ((states('number.cx50_heating_setpoint_c') | float - 0.5) * 1.8 + 32) | round(1) }}Â°F)

                  **Reason:** Demand has been Low for 4+ hours

                  Zones calling: {{ states('sensor.radiant_zones_calling') }}
                  Flow rate: {{ states('sensor.hvac_buffer_tank_flow_rate') }} gal/min
                  Outdoor temp: {{ states('sensor.heat_pump_ambient_temperature') }}Â°F
                notification_id: supply_temp_recommendation
            - action: logbook.log
              data:
                name: Supply Temp Optimization
                message: >
                  ðŸ“‹ RECOMMENDATION: Decrease setpoint by 0.5Â°C - Demand Low for 4+ hours
                entity_id: number.cx50_heating_setpoint_c

        # RECOMMEND INCREASE when demand has been high
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: sensor.radiant_system_demand_level
                  state: "High"
                  for:
                    hours: 4
                - condition: state
                  entity_id: sensor.radiant_system_demand_level
                  state: "Very High"
                  for:
                    hours: 2
            # Verify we're below maximum limit
            - condition: template
              value_template: >
                {% set current_c = states('number.cx50_heating_setpoint_c') | float(30) %}
                {% set max_f = states('input_number.supply_temp_max_limit') | float(105) %}
                {% set max_c = (max_f - 32) / 1.8 %}
                {{ current_c < (max_c - 0.5) }}
          sequence:
            - action: persistent_notification.create
              data:
                title: "Supply Temp Recommendation: Increase"
                message: >
                  **Recommendation:** Increase setpoint by 1Â°F

                  **Current:** {{ states('number.cx50_heating_setpoint_c') }}Â°C ({{ (states('number.cx50_heating_setpoint_c') | float * 1.8 + 32) | round(1) }}Â°F)

                  **Suggested:** {{ (states('number.cx50_heating_setpoint_c') | float + 0.5) | round(1) }}Â°C ({{ ((states('number.cx50_heating_setpoint_c') | float + 0.5) * 1.8 + 32) | round(1) }}Â°F)

                  **Reason:** Demand has been {{ states('sensor.radiant_system_demand_level') }} for extended period

                  Zones calling: {{ states('sensor.radiant_zones_calling') }}
                  Flow rate: {{ states('sensor.hvac_buffer_tank_flow_rate') }} gal/min
                  Outdoor temp: {{ states('sensor.heat_pump_ambient_temperature') }}Â°F
                notification_id: supply_temp_recommendation
            - action: logbook.log
              data:
                name: Supply Temp Optimization
                message: >
                  ðŸ“‹ RECOMMENDATION: Increase setpoint by 0.5Â°C - Demand {{ states('sensor.radiant_system_demand_level') }} for extended period
                entity_id: number.cx50_heating_setpoint_c

      # Default: No recommendation needed
      default:
        - action: logbook.log
          data:
            name: Supply Temp Optimization
            message: >
              âœ“ No change recommended - Demand: {{ states('sensor.radiant_system_demand_level') }},
              Setpoint: {{ states('number.cx50_heating_setpoint_c') }}Â°C
            entity_id: number.cx50_heating_setpoint_c

  mode: single

# Log when optimization is enabled/disabled
- id: 'log_supply_temp_optimization_toggle'
  alias: "Log: Supply Temp Optimization Toggle"
  description: Log when supply temp optimization is enabled or disabled
  triggers:
    - platform: state
      entity_id: input_boolean.enable_supply_temp_optimization
  actions:
    - action: logbook.log
      data:
        name: Supply Temp Optimization
        message: >
          {% if is_state('input_boolean.enable_supply_temp_optimization', 'on') %}
            âœ… ENABLED - Automatic setpoint adjustment active
            (Limits: {{ states('input_number.supply_temp_min_limit') }}Â°F - {{ states('input_number.supply_temp_max_limit') }}Â°F)
          {% else %}
            â¸ï¸ DISABLED - Manual control only
          {% endif %}
        entity_id: input_boolean.enable_supply_temp_optimization
  mode: single

# One-time reminder - can be deleted after it runs
- id: 'reminder_llm_optimization_20251119'
  alias: "Reminder: Consider AI/LLM for Optimization"
  description: One-time reminder to consider AI/LLM features for thermal optimization
  triggers:
    - platform: time
      at: "09:00:00"
  conditions:
    - condition: template
      value_template: "{{ now().date() == strptime('2025-11-19', '%Y-%m-%d').date() }}"
  actions:
    - action: persistent_notification.create
      data:
        title: "Reminder: AI/LLM for Optimization"
        message: >
          Consider whether HA's AI/LLM integrations would be useful for thermal optimization.

          Options to explore:
          - Daily analysis reports via conversation.process
          - Anomaly detection for unusual patterns
          - Weather-aware recommendations

          Setup required: OpenAI, Anthropic, or Ollama integration
        notification_id: llm_optimization_reminder
    - action: notify.mobile_app_pixel_8_pro
      data:
        title: "Reminder: AI/LLM for Optimization"
        message: "Consider AI/LLM features for thermal optimization analysis"
  mode: single
